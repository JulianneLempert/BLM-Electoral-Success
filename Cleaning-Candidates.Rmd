---
title: "Cleaning Candidates"
author: "Julianne Lempert"
date: "`r Sys.Date()`"
output: html_document
---

```{r,message=FALSE}
# Load libraries
library(tidyverse)
library(knitr)
library(wru)
```

## Cleaning Local Candidates

```{r}
locals <- read.csv("locals.csv")
```


```{r}
# Changing race options to black, white, or other (NAs I'll address w/ BISG)
locals <- locals %>%
  # Subset to 2020
  filter(year >= 2010) %>%
  mutate(race_est = case_when(
    race_est %in% c("asian","other", "hispanic") ~ "other",
    race_est == "caucasian" ~ "white",
    TRUE ~ race_est)) %>%
  # Getting rid of irrelevant columns
  select(-c(votes, vote_share, contributor.cfscore, bonica.cid, prob_democrat, prob_republican, prob_female, prob_male, prob_black, prob_white, prob_hispanic, prob_asian, prob_other, ballotpedia_url)) %>%
    # Renaming variables
 rename(office = office_consolidated, gender = gender_est,race = race_est, party = pid_est, location = geo_name, last_name = lastname, first_name = firstname, cand_id = ledb_candid) %>%
  # Fixes duplicate naming of states
  mutate(state_abb = case_when(
    state_abb == "Maryland" ~ "MD",
    state_abb == "Utah" ~ "UT",
    TRUE ~ state_abb)) %>%
  # Removes unnamed candidate
  filter(first_name != "scattering")
```

```{r}
write.csv(locals, file = "locals")
```


## Cleaning State Legislatures

```{r}
sleg <- read.csv("sleg.csv")
```

```{r}
sleg <- sleg %>%
  filter(year >= 2010) %>%
# Removing irrelevant variables
  select(-c(uncert, day, sid, mmdpost, dseats, popnum, nest, nest1, nest2, nest3, eseats, term, termz, partytsource, hold, hold1, hold2, tenure1, tenure2, limit, middle2, nick, namenum, last1, last2, last3, last3, ltype1, ltype2, ltype3, ltype4, lastb, firstb, middleb, middle2b, nickb, suffixb, last1b, last2b, ltype1b, ltype2b, namebsource, v38, v39, nonlasto, middle2o, nicko, nonlasto,suffix, prefix, sicpsr, ddez, specpost, redist, redist1, redist2, redist3, regime, flot, flot1, flot2, flot3, deter, cando, candformat, partyo, party, firstcase, v56, v57, v58, v18_20171211, v19_20171211, v19_20160217, candid20190807, candid20210504, candid20210504, cand20210504,cand20190807, candpartyo, lasto, firsto, middleo, suffixo, last4, vote, cand, partyt, prior1, prior2)) %>%
# Renaming variables 
   rename(state = sab, state_fips = sfips, county = cname, county_fips = cfips, senate = sen, district_name = dname, district_number = dno, geo_post = geopost, district_type = dtype, election_type = etype, party = partyz, last_name = last, first_name = first, middle_name = middle, cand_id = candid, case_id = caseid) %>%
   # Changes empty cells to NA
  mutate(county = na_if(str_trim(county), ""))
```


```{r}
sleg %>%
  filter(is.na(county_fips) & !is.na(county))
```

```{r}
sleg %>%
  filter(year == 2020) %>%
  select(cname, cfips)
```



```{r}
fips_match <- fips_match %>%
  rename(state_fips = FIPS.State,
         county = County.Name) %>%
  mutate(county = tolower(county)) %>%
  mutate(county = str_trim(county))
```

```{r}
sleg_match <- left_join(sleg, fips_match, by = c("county", "state_fips"))
```



```{r}
sleg <- sleg %>%
  filter(year >= 2010) %>%
# Removing irrelevant variables
  select(-c(uncert, day, sid, mmdpost, dseats, popnum, nest, nest1, nest2, nest3, eseats, term, termz, partytsource, hold, hold1, hold2, tenure1, tenure2, limit, middle2, nick, namenum, last1, last2, last3, last3, ltype1, ltype2, ltype3, ltype4, lastb, firstb, middleb, middle2b, nickb, suffixb, last1b, last2b, ltype1b, ltype2b, namebsource, v38, v39, nonlasto, middle2o, nicko, nonlasto,suffix, prefix, sicpsr, ddez, specpost, redist, redist1, redist2, redist3, regime, flot, flot1, flot2, flot3, deter, cando, candformat, partyo, party, firstcase, v56, v57, v58, v18_20171211, v19_20171211, v19_20160217, candid20190807, candid20210504, candid20210504, cand20210504,cand20190807, candpartyo, lasto, firsto, middleo, suffixo, last4, vote, cand, partyt, prior1, prior2)) %>%
# Renaming variables 
   rename(state = sab, state_fips = sfips, county = cname, county_fips = cfips, senate = sen, district_name = dname, district_number = dno, geo_post = geopost, district_type = dtype, election_type = etype, party = partyz, last_name = last, first_name = first, middle_name = middle, cand_id = candid, case_id = caseid) %>%
   # Removing 1 withdrawal case
 filter(outcome != "withdrew") %>%
  # Assigning clearer values
  mutate(outcome = case_when(
    outcome == "w" ~ "won",
    # Candidates who lost in a runoff are marked as lost
    outcome == "r" ~ "lost",
    outcome == "l" ~ "lost",
    outcome == "t" ~ "tie"
  )) %>%
  # Geraldo Alicea and Peter Durant came to an exact tie, then Durant won in a special election
  mutate(outcome = ifelse(last_name == "alicea" & outcome == "tie", "lost", outcome)) %>%
  mutate(outcome = ifelse(last_name == "durant" & outcome == "tie", "won", outcome)) %>%
   # Denotes write-in/scattering
  filter(party != "w") %>%
  mutate(party = case_when(
    party == "d" ~ "democrat",
    party == "r" ~ "republican",
    # denotes non-major party
    party == "nm" ~ "other",
    # Fused Democrat and Republican, when votes for the two parties aren't separately reported on the ballot
    party == "b" ~ "fused",
    party == "np" ~ "non-partisan election")) %>%
  mutate(election_type = case_when(
    election_type == "g" ~ "general",
    election_type %in% c("s", "gs", "ssg", "nps") ~ "special",
    election_type %in% c("ttp", "dp", "rp", "upf", "7thindepp", "amerindepp", "conservativep", "constamerindepp", "constp", "greenp", "indepamerp", "indepp", "indepp1", "indepp2", "indeppartyofdelp", "liberp", "libertyunionp", "mountainp", "petitioningcandp", "progp", "workp", "amerpfsettled", "dpfsettled", "dpfunsettled", "indeppfsettled", "liberpfsettled", "rpfsettled", "rpfunsettled", "thegreenpfsettled", "unapfsettled", "dpsgf", "dpsf") ~ "primary",
    election_type %in% c("runoff", "lasrunoff", "larunoff", "dprunoff", "dpsgrunoff", "dpsrunoff", "grunoff", "rprunoff", "srunoff", "dpfsettled", "sfunsettled", "srunoff", "lafsettled", "lafunsettled", "lasf") ~ "runoff")) %>%
   rename(incumbency = exper) %>%
   mutate(incumbency = case_when(
    incumbency == "inc" ~ "incumbent",
    incumbency == "sinc" ~ "incumbent",
    TRUE ~ "challenger")) %>%
  # Removes the word "county" after some county names
  mutate(county = gsub("county", "", county)) %>%
  # Changes empty cells to NA
  mutate(across(
    c(county, district_name, first_name, middle_name), 
    ~ na_if(str_trim(.x), "")))
#%>% 
#  mutate(county = as.character(county)) %>%
  #mutate(county = str_trim(county),
       #  county = tolower(county)) %>%
 # filter(county != "emergencyutilityworkers") %>%
  #filter(county != "stateuocava")
```

```{r}
sleg %>%
  filter(cname %in% c("emergencyutilityworkers", "stateuocava")) %>%
  distinct(year)
```

```{r}
sleg %>%
  filter(!(cname %in% c("emergencyutilityworkers", "stateuocava") & year == 2014)) %>%
  distinct(year)
```




## Cleaning House Candidates (General)

```{r}
house_generals <- read.csv("house_generals through 2022.csv")
```

```{r}
house_generals <- house_generals %>%
# Subset to relevant years
  filter(year >= 2010) %>%
# Remove irrelevant variables or columns with only one value
  select(-c(state, state_cen, state_ic, writein, unofficial, version, office, stage, 
            special, mode, fusion_ticket, runoff, state_fips)) %>%
# Remove write-ins because BISG is not possible
  filter(candidate != "WRITEIN") %>%
# Any party besides Democrat or Republican gets called Other
    mutate(party = case_when(
    str_detect(party, "DEMOCRAT") ~ "DEMOCRAT",
    str_detect(party, "REPUBLICAN") ~ "REPUBLICAN",
    TRUE ~ "OTHER")) %>%
# Rename variables
  rename(state = state_po, candidate_votes = candidatevotes, total_votes = totalvotes) %>%
# Filter to only the 50 states
   filter(state != "DC") %>%
# Remove the word in quotes along with the quotes
  mutate(candidate = gsub(' ".*?" ', ' ', candidate)) %>%
  
# Separates candidate names for future BISG analysis
separate(candidate, into = c("first_name", "middle_name", "last_name", "suffix"), 
         sep = " ", extra = "merge", fill = "right")

# If nothing was put in last_name, the second name was the last name
# so move middle_name value to last_name
house_generals$last_name <- 
  ifelse(is.na(house_generals$last_name), house_generals$middle_name, 
         house_generals$last_name)

# Fill middle_name with NA if middle_name value got moved to last_name
house_generals$middle_name <-
  ifelse(house_generals$middle_name == house_generals$last_name, NA, 
         house_generals$middle_name)

# Remove any real suffix and other punctuation
house_generals <- house_generals %>%
  mutate(suffix = ifelse(suffix %in% c("JR", "SR", "II", "III", "IV"), NA, suffix)) %>%
  mutate(middle_name = ifelse(grepl('[\"“”]', middle_name), NA, middle_name)) %>%
  mutate(last_name = ifelse(grepl('[\"“”]', last_name), NA, last_name)) %>%
  mutate(first_name = gsub('[\"“”]', '', first_name))

# If last name is a suffix, the middle name was the last name
# so move middle name value to last name
house_generals$last_name <- 
  ifelse(house_generals$last_name %in% c("JR", "SR", "II", "III", "IV"), 
         house_generals$middle_name, house_generals$last_name)

# Fill middle name with NA if middle name value got moved to last name
house_generals$middle_name <-
  ifelse(house_generals$middle_name == house_generals$last_name, NA, 
         house_generals$middle_name)

house_generals <- house_generals %>%
  # Remove unnamed candidates
  filter(!first_name %in% c("OTHER", "BLANK", "VOID", "OVER", "UNDERVOTES", "OVERVOTES",
                            "VOTEFOREDDIECOM", "BLANKS", "ALL", "OTHERS", "SCATTERING",
                            "SCATTER", "PRO-LIFE", "WRITE-IN", "MISCELLANEOUS", "WORKING",
                            "INDEPENDENT", "EXHAUSTED", "MODERATE"))
```

```{r}
# Manual name fixes, according to Ballotpedia

house_generals <- house_generals %>%
 mutate(last_name = case_when(
    first_name == "EDWARD" & middle_name == "A" & is.na(last_name) 
    & suffix == "MAIDMENT" ~ "MAIDMENT",
    first_name == "GEOFFREY" & middle_name == "M" & is.na(last_name) 
    & suffix == "YOUNG" ~ "YOUNG",
    first_name == "WILLIAM" & middle_name == "F" & is.na(last_name) 
    & suffix == "POWERS" ~ "POWERS",
    first_name == "JAMES" & middle_name == "G" & is.na(last_name) 
    & suffix == "MYLES" ~ "MYLES",
    first_name == "ROBERT" & middle_name == "C" & is.na(last_name) 
    & suffix == "SCOTT" ~ "SCOTT",
    first_name == "HERBERT" & middle_name == "C" & is.na(last_name) 
    & suffix == "JONES, JR" ~ "JONES",
    first_name == "CHARLES" & middle_name == "J" & is.na(last_name) 
    & suffix == "FLEISCHMANN" ~ "FLEISCHMANN",
    first_name == "MAX" & middle_name == "H" & last_name == "DELLA" 
    & suffix == "PIA" ~ "DELLA PIA",
    first_name == "GEORGE" & middle_name == "A" & last_name == "D" 
    & suffix == "SANTOS" ~ "SANTOS",
    first_name == "JESÚS" & middle_name == "G" & is.na(last_name) 
    & suffix == "GARCÍA" ~ "GARCÍA",
    first_name == "HENRY" & middle_name == "C" & is.na(last_name) 
    & suffix == "JOHNSON, JR" ~ "JOHNSON",
    first_name == "EARL" & middle_name == "L" & is.na(last_name) 
    & suffix == "CARTER" ~ "CARTER",
    first_name == "THEODORE" & is.na(middle_name) & is.na(last_name) 
    & suffix == "MURRAY" ~ "MURRAY",
    first_name == "G" & is.na(middle_name) & last_name == "A" ~ "PUDLO",
    first_name == "MICHAEL" & middle_name == "J" & is.na(last_name) 
    & suffix == "BARKLEY" ~ "BARKLEY",
    first_name == "ERIC" & middle_name == "A" & is.na(last_name) 
    & suffix == "CRAWFORD" ~ "CRAWFORD",
    first_name == "DEBRA" & middle_name == "JO" & is.na(last_name) 
    & suffix == "BORDEN" ~ "BORDEN",
    first_name == "RICARDO" & middle_name == "DE" & last_name == "LA" 
    & suffix == "FUENTE" ~ "DE LA FUENTE",
    first_name == "MONICA" & middle_name == "DE" & last_name == "LA" 
    & suffix == "CRUZ-HERNANDEZ" ~ "DE LA CRUZ",
    first_name == "KYLE" & middle_name == "VAN" & last_name == "DE" 
    & suffix == "WATER" ~ "VAN DE WATER",
    first_name == "GERALD" & middle_name == "T" & last_name == "VAN" 
    & suffix == "SICKLE" ~ "VAN SICKLE",
    first_name == "MICHELLE" & middle_name == "DE" & last_name == "LA" 
    & suffix == "ISLA" ~ "DE LA ISLA",
    first_name == "GENERAL" & middle_name == "PARKER" & is.na(last_name) ~ "PARKER",
    first_name == "DIANE" & middle_name == "E" & last_name == "MITSCH" 
    & suffix == "BUSH" ~ "BUSH",
    first_name == "JAMES" & middle_name == "E" & last_name == "JIM" 
    & suffix == "CLYBURN" ~ "CLYBURN",
    first_name == "EBERT" & middle_name == "G" & last_name == "BILL" 
    & suffix == "BEEMAN" ~ "BEEMAN",
    first_name == "VICKIE" & middle_name == "YATES" & last_name == "B" 
    & suffix == "GLISSON" ~ "GLISSON",
    first_name == "ANDREW" & middle_name == "VSEVOLOD" & last_name == "VON" 
    & suffix == "SONN" ~ "VON SONN",
    first_name == "WILLIAM" & middle_name == "MAVERICK" & last_name == "ST" 
    & suffix == "CLAIRE" ~ "ST CLAIRE",
    first_name == "C" & middle_name == "W" & last_name == "BILL" 
    & suffix == "YOUNG" ~ "YOUNG",
    first_name == "GLORIA" & last_name == "E" & suffix == "LA RIVA" ~ "LA RIVA",
    first_name == "SAM" & middle_name == "S" & suffix == "CALIGIURI" ~ "CALIGIURI",
    first_name == "C" & middle_name == "A" & last_name == "DUTCH" 
    & suffix == "RUPPERSBERGER" ~ "RUPPERSBERGER",
    first_name == "SEAN" & middle_name == "D" & suffix == "MIELAT" ~ "MIELAT",
    first_name == "J" & middle_name == "MATTHEW" & suffix == "DE HEUS" ~ "DE HEUS",
    first_name == "TRACELLA" & middle_name == "LOU" & suffix == "HILL" ~ "HILL",
    first_name == "M" & middle_name == "E" & last_name == "MAC" 
    & suffix == "MCCULLOUGH" ~ "MCCULLOUGH",
    first_name == "WYNNE" & middle_name == "V" & last_name == "E" 
    & suffix == "LEGROW" ~ "LEGROW",
    first_name == "THOMAS" & middle_name == "S" & suffix == "PERRIELLO" ~ "PERRIELLO",
    first_name == "JONATHAN" & middle_name == "TE" & suffix == "COURTNEY" ~ "COURTNEY",
    first_name == "FRANK" & middle_name == "DELLA" & suffix == "VALLE" ~ "VALLE",
    first_name == "NAN" & middle_name == "AS" & suffix == "HAYWORTH" ~ "HAYWORTH",
    first_name == "BRIAN" & middle_name == "RYAN" & last_name == "B" 
    & suffix == "DOYLE" ~ "DOYLE",
    first_name == "HOWARD" & middle_name == "TERM" & last_name == "LIMITS" 
    & suffix == "LAWSON" ~ "LAWSON",
    first_name == "ROSEANN" & middle_name == "EHRHARD" & suffix == "WOFFORD" ~ "WOFFORD",
    first_name == "NICHOLAS" & suffix == "DI IORIO" ~ "Di Iorio",
    first_name == "ALAN" & middle_name == "J" & last_name == "K" 
    & suffix == "YIM" ~ "YIM",
    first_name == "KAREN" & middle_name == "FREE" & last_name == "SPIRIT" 
    & suffix == "TALLEY-LANE" ~ "TALLEY-LANE",
    TRUE ~ last_name  # Keep existing values for all other rows
  )) %>%
  mutate(middle_name = case_when(
      first_name == "DIANE" & middle_name == "E" & last_name == "BUSH" ~ "MITSCH",
      first_name == "JAMES" & middle_name == "E" & last_name == "CLYBURN" ~ "ENOS",
      first_name == "C" & middle_name == "W" & last_name == "YOUNG" ~ "WILLIAM",
      first_name == "SAM" & middle_name == "S" & last_name == "CALIGIURI" ~ "SF",
      first_name == "TRACELLA" & middle_name == "LOU" & last_name == "HILL" ~ "LOU O'HARA",
      first_name == "THOMAS" & middle_name == "S" & last_name == "PERRIELLO" ~ "SP",
      first_name == "JONATHAN" & middle_name == "T" & last_name == "COURTNEY" ~ "TE",
      first_name == "FRANK" & middle_name == "L" & last_name == "VALLE" ~ "DELLA",
      first_name == "NAN" & middle_name == "A" & last_name == "HAYWORTH" ~ "AS",
      first_name == "ROSEANN" & middle_name == "L" & last_name == "WOFFORD" ~ "EHRHARD",
      first_name == "SEAN" & middle_name == "D" & last_name == "MIELAT" ~ "DM",
      TRUE ~ middle_name  # Keep existing values for all other rows
    )) %>%
  mutate(first_name = case_when(
    first_name == "C" & middle_name == "WILLIAM" & last_name == "YOUNG" ~ "CHARLES",
    first_name == "C" & last_name == "RUPPERSBERGER" ~ "DUTCH",
    first_name == "M" & middle_name == "E" & last_name == "MCCULLOUGH" ~ "MAC",
    TRUE ~ first_name  # Keep existing values for all other rows
  ))

# Set all suffix values to NA
house_generals$suffix <- NA

# Variable not needed for BISG
house_generals <- house_generals %>%
  select(-suffix)

# Set all adjusted middle names to NA
house_generals <- house_generals %>%
  mutate(middle_name = case_when(
      first_name == "KAREN" & middle_name == "FREE" & last_name == "TALLEY-LANE" ~ NA,
      first_name == "ALAN" & middle_name == "J" & last_name ==  "YIM" ~ NA,
      first_name == "HOWARD" & middle_name == "TERM" & last_name == "LAWSON" ~ NA,
      first_name == "BRIAN" & middle_name == "RYAN" & last_name == "DOYLE" ~ NA,
      first_name == "WYNNE" & middle_name == "V" & last_name == "LEGROW" ~ NA,
      first_name == "MAC" & middle_name == "E" & last_name == "MCCULLOUGH" ~ NA,
      first_name == "EBERT" & middle_name == "G" & last_name == "BEEMAN" ~ NA,
      first_name == "GENERAL" & middle_name == "PARKER" & last_name == "PARKER" ~ NA,
      first_name == "MICHELLE" & middle_name == "DE" & last_name == "DE LA ISLA" ~ NA,
      first_name == "KYLE" & middle_name == "VAN" & last_name == "VAN DE WATER" ~ NA,
      first_name == "MONICA" & middle_name == "DE" & last_name == "DE LA CRUZ" ~ NA,
      first_name == "RICARDO" & middle_name == "DE" & last_name == "DE LA FUENTE" ~ NA,
      first_name == "GEORGE" & middle_name == "A" & last_name == "SANTOS" ~ NA,
      TRUE ~ middle_name  # Keep existing values for all other rows
    ))
```

```{r}
house_generals <- house_generals %>%
 # Remove commas at end of string
  mutate(middle_name = gsub(",\\s*$", "", middle_name)) %>%
  mutate(last_name = gsub(",\\s*$", "", last_name)) %>%
  # Remove redundant rows
  distinct(year, district, last_name, first_name, .keep_all = TRUE)
```

```{r}
# Calculate results

house_generals <- house_generals %>%
  # Calculate proportion of votes the candidate received
  mutate(win_proportion = candidate_votes / total_votes) %>%
  # Label all districts with their states so they are distinct
   mutate(district = paste(state, district, sep = "_")) %>%
  # Exclude candidates that received no votes
   filter(candidate_votes != 0)

plurality_states <- house_generals %>% 
  # Exclude states without a plurality system 
  filter(!state %in% c("AK", "ME", "GA", "LA")) %>% 
  # Group into distinct contests
  group_by(year, state, district) %>% 
  # Designate a candidate a winner if they received the highest vote proportion
  mutate(result = ifelse(win_proportion == max(win_proportion), "WON", "LOST")) %>%
  # Remove grouping of distinct contests
  ungroup()

GA_LA <- house_generals %>%
  # Filter to just Georgia and Louisiana
  filter(state %in% c("GA", "LA")) %>%
  # Group into distinct contests
  group_by(year, state, district) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WON", "LOST")
    } else {
       # In  6 cases of no one getting over 50%, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WON", "LOST")}) %>%
  # Remove grouping of distinct contests
  ungroup()

AK_ME <- house_generals %>%
  # Filters to just Alaska and Maine
  filter(state %in% c("AK", "ME")) %>%
   # Groups into distinct contests
  group_by(year, state, district) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WON", "LOST")
    } else {
      # In 3 cases of no one getting over 50%, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WON", "LOST")}) %>%
  # Remove grouping of distinct contests
  ungroup()
  
# Bind rows back together
house_generals <- bind_rows(plurality_states, GA_LA, AK_ME)

# Variables not needed anymore
house_generals <- house_generals %>%
  select(-c(candidate_votes, total_votes, win_proportion))
```


## Cleaning Senate Candidates (General, through 2020)

```{r}
senate_generals <- read.csv("senate_generals through 2020.csv")
```

```{r}
# Subset to case years
senate_generals <- senate_generals %>%
  filter(year >= 2010) %>%
# Removing irrelevant variables or columns with only one value
  select(-c(state, state_cen, state_ic, office, district, party_detailed, unofficial, version, writein, state_fips, mode)) %>%
# Removing rows with no candidate name
    filter(!is.na(candidate)) %>%
# Any party besides Democrat or Republican gets called Other
   mutate(party_simplified = ifelse(party_simplified == "DEMOCRAT" | party_simplified == "REPUBLICAN",
                                    party_simplified, "OTHER")) %>%
# Renaming variables
  rename(state = state_po, candidate_votes = candidatevotes, total_votes = totalvotes, party = party_simplified) %>%
   # Removes meaningless values
  filter(!candidate %in% c("BLANK VOTE/SCATTERING", "SCATTER", "OTHER", "OVER VOTE", "BLANK VOTE", "OTHERS", "OVER VOTES", "UNDER VOTES", "BLANK VOTES","VOID VOTE", "NONE OF THESE CANDIDATES", "OTHER CANDIDATES", "BLANK VOTE/VOID VOTE/SCATTERING", "NONE OF THE ABOVE")) %>%
    # Removes the word in quotes along with the quotes
  mutate(candidate = gsub('[\"“”][^\"“”]+[\"“”]', '', candidate)) %>%
# Separates candidate names 
  separate(candidate, into = c("first_name", "middle_name", "last_name", "suffix"), sep = " ", extra = "merge", fill = "right") %>%
    mutate(middle_name = ifelse(trimws(middle_name) == "", NA, middle_name))
  
# If nothing was put in last_name, the second name was the last name so move middle_name value to last_name
senate_generals$last_name <- 
  ifelse(is.na(senate_generals$last_name), senate_generals$middle_name, senate_generals$last_name)

# Fill middle_name with NA if middle_name value got moved to last_name
senate_generals$middle_name <-
  ifelse(senate_generals$middle_name == senate_generals$last_name, NA, senate_generals$middle_name)

# Corrected an error
senate_generals$middle_name[313] <- "Y"
senate_generals$last_name[313] <- "ALLEN"
senate_generals$suffix[303] <- NA

# Removes suffix, not needed for BISG
senate_generals <- senate_generals %>%
  select(-suffix) %>%
# Removes the period at the end of one letter middle names 
   mutate(middle_name = gsub('\\.$', '', middle_name)) %>%
   # Removes the period at the end of one letter first names 
   mutate(first_name = gsub('\\.$', '', first_name)) %>%
  # Removes the period at the end of one letter last names 
   mutate(last_name = gsub('\\.$', '', last_name)) %>%
  # Removes comma at end
  mutate(last_name = gsub(",\\s*$", "", last_name)) %>%
  mutate(across(everything(), ~ replace(., . == "", NA)))

# Removes a candidate with just first name and very few votes
# Removes a candidate with a one letter first name and one letter middle name and few votes
senate_generals <- senate_generals[-c(49,86), ]

# Manual error fixing
senate_generals$last_name[81] <- "LANE"
senate_generals$last_name[82] <- "G"
senate_generals$last_name[86] <- "ROBERT"
senate_generals$first_name[90] <- "CHARLIE"
senate_generals$last_name[c(166,295)] <- "MANCHIN"
senate_generals$last_name[333] <- "D"
senate_generals$last_name[421] <- "EMERSON"
senate_generals$last_name[490] <- "M"
senate_generals$last_name[530] <- "TAYLOR"
senate_generals$last_name[877] <- "LOVE"
senate_generals$middle_name[c(81,82,86,166,295,237,241,333,421,490,530,877,196,236,240)] <- NA

senate_generals <- senate_generals %>%
  distinct(first_name, middle_name, last_name, .keep_all = TRUE)
```

```{r}
senate_generals <- senate_generals %>%
  # Excludes candidates that received no votes
   filter(candidate_votes != 0) %>%
  # Calculates proportion of votes the candidate received
  mutate(win_proportion = candidate_votes / total_votes)

plurality_states <- senate_generals %>% 
  # Excludes states without a plurality system 
  filter(!state %in% c("AK", "ME", "GA", "LA")) %>% 
  # Groups into distinct contests
  group_by(year, state) %>% 
  # Designates a candidate a winner if they received the highest vote proportion
  mutate(result = ifelse(win_proportion == max(win_proportion), "WINNER", "LOSER")) %>%
  ungroup()

GA_LA <- senate_generals %>%
  filter(state %in% c("GA", "LA")) %>%
  # Groups into distinct contests
  group_by(year, state) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WINNER", "LOSER")
    } else {
       # In all 6 cases of no one getting over 50% of the votes, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WINNER", "LOSER")}) %>%
  ungroup()

AK_ME <- senate_generals %>%
  filter(state %in% c("AK", "ME")) %>%
   # Groups into distinct contests
  group_by(year, state) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WINNER", "LOSER")
    } else {
      # In all 3 cases of no one getting over 50% of the votes, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WINNER", "LOSER")}) %>%
  ungroup()
```

```{r}
# Manual fixes to results
# Plurality state fixes

plurality_states <- plurality_states %>%
  mutate(result = case_when(
    last_name == "LONG" & first_name == "WENDY" ~ "LOSER",
    last_name == "FARLEY" ~ "LOSER",
    last_name == "HARRISON" ~ "LOSER",
    last_name == "GILLIBRAND" ~ "WINNER",
    last_name == "LANKFORD" ~ "WINNER",
    last_name == "GRAHAM" ~ "WINNER",
    TRUE ~ result))

plurality_states <- add_row(plurality_states, year = 2018, state = "MS", stage = "gen", special = "False", first_name = "ROGER",
                            middle_name = "F", last_name = "WICKER", candidate_votes = NA, total_votes = NA, 
                            party = "REPUBLICAN", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2018, state = "MN", stage = "gen", special = "False", first_name = "AMY",
                            middle_name = NA, last_name = "KLOBUCHAR", candidate_votes = NA, total_votes = NA, 
                            party = "DEMOCRAT", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2012, state = "NY", stage = "gen", special = "False", first_name = "KIRSTEN",
                            middle_name = "E", last_name = "GILLIBRAND", candidate_votes = NA, total_votes = NA, 
                            party = "DEMOCRAT", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2018, state = "NY", stage = "gen", special = "False", first_name = "KIRSTEN",
                            middle_name = "E", last_name = "GILLIBRAND", candidate_votes = NA, total_votes = NA, 
                            party = "DEMOCRAT", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2020, state = "SC", stage = "gen", special = "False", first_name = "LINDSEY",
                            middle_name = NA, last_name = "GRAHAM", candidate_votes = NA, total_votes = NA, 
                            party = "REPUBLICAN", win_proportion = NA, result = "WINNER")
```

```{r}
# Manual fixes to results
# GA and LA state fixes

GA_LA <- GA_LA %>%
  mutate(result = case_when(
    last_name == "WARNOCK" ~ "WINNER",
    last_name == "BARKSDALE" ~ "LOSER",
    TRUE ~ result)) %>%
  mutate(first_name = case_when(
    last_name == "CASSIDY" ~ "BILL",
    TRUE ~ first_name))

GA_LA <- add_row(GA_LA, year = 2016, state = "GA", stage = "gen", special = "False", first_name = "JOHNNY",
                            middle_name = NA, last_name = "ISAKSON", candidate_votes = NA, total_votes = NA, 
                            party = "REPUBLICAN", win_proportion = NA, result = "WINNER")
```

```{r}
# Manual fixes to results
# AK and ME state fixes

AK_ME <- AK_ME %>%
  mutate(result = case_when(
  last_name == "STOCK" ~ "LOSER",
  last_name == "GROSS" ~ "LOSER",
  TRUE ~ result))
  
AK_ME <- add_row(AK_ME, year = 2016, state = "AK", stage = "gen", special = "False", first_name = "LISA",
                            middle_name = NA, last_name = "MURKOWSKI", candidate_votes = NA, total_votes = NA, 
                            party = "REPUBLICAN", win_proportion = NA, result = "WINNER")
AK_ME <- add_row(AK_ME, year = 2020, state = "AK", stage = "gen", special = "False", first_name = "DAN",
                            middle_name = NA, last_name = "SULLIVAN", candidate_votes = NA, total_votes = NA, 
                            party = "REPUBLICAN", win_proportion = NA, result = "WINNER")

```

```{r}
senate_generals <- bind_rows(plurality_states, GA_LA, AK_ME)

# Variables not needed anymore
senate_generals <- senate_generals %>%
  select(-c(candidate_votes, total_votes, win_proportion))
```

```{r}
senate_generals <- senate_generals %>%
  # Removes question marks from middle names
  mutate(middle_name = gsub("\\?", "", middle_name))
```


## Cleaning House Candidates (Primaries, 2012-2018)

```{r}
# Reading in data
house_primaries <- read.delim("house_primaries 2012-2018.tab", header = TRUE)
```

```{r}
house_primaries <- house_primaries %>%
  # Remove irrelevant variables or columns with one value
  select(-c(seat, redist, fr, prez, votep, incname, candvotes, 
            tvotes, office, qual, definc, law,
            candpct, type, candnumber)) %>%
# Rename variables
   rename(contest_id = raceid,
         candidate_name = candidate,
         incumbent = inc) %>%
# Assign clearer values
# Party refers to the primary contest held, not self-identified party of candidate
  mutate(party = case_when(
    party == 0 ~ "rep",
    party == 1 ~ "dem"))

# Create named vector to reassign spelled-out states to abbreviations
state_mapping <- c(
  "alabama" = "AL", "alaska" = "AK", "arizona" = "AZ", "arkansas" = "AR", 
  "california" = "CA", "colorado" = "CO", "connecticut" = "CT", "delaware" = "DE",
  "florida" = "FL", "georgia" = "GA", "hawaii" = "HI", "idaho" = "ID",
  "illinois" = "IL", "indiana" = "IN", "iowa" = "IA", "kansas" = "KS",
  "kentucky" = "KY", "louisiana" = "LA", "maine" = "ME", "maryland" = "MD",
  "massachusetts" = "MA", "michigan" = "MI", "minnesota" = "MN", "mississippi" = "MS",
  "missouri" = "MO", "montana" = "MT", "nebraska" = "NE", "nevada" = "NV",
  "new hampshire" = "NH", "new jersey" = "NJ", "new mexico" = "NM", "new york" = "NY",
  "north carolina" = "NC", "north dakota" = "ND", "ohio" = "OH", "oklahoma" = "OK",
  "oregon" = "OR", "pennsylvania" = "PA", "rhode island" = "RI", "south carolina" = "SC",
  "south dakota" = "SD", "tennessee" = "TN", "texas" = "TX", "utah" = "UT",
  "vermont" = "VT", "virginia" = "VA", "washington" = "WA", "west virginia" = "WV",
  "wisconsin" = "WI", "wyoming" = "WY")

# Index at vector to reassign state values
house_primaries <- house_primaries %>%
   mutate(state = state_mapping[state]) %>%
# Assign clearer values
   mutate(gender = case_when(
    gender == 0 ~ "male",
    gender == 1 ~ "female")) %>%
  mutate(runoff = case_when(
    runoff == 0 ~ "not run-off state or run-off not needed",
    runoff == 1 ~ "primary triggered a run-off, no nomination determined",
    runoff == 2 ~ "two-candidate run-off, winner advances to general")) %>%
  mutate(winner = case_when(
    winner == 1 ~ "won",
    winner == 0 ~ "lost")) %>%
  mutate(incumbent = case_when(
    incumbent == 1 ~ "inc",
    incumbent == 0 ~ "chal")) %>%
# Extract just district component of string
  mutate(stcd = str_sub(stcd, -2)) %>% 
# Rename variables for clarity
  rename(district = stcd, result = winner, incumbency = incumbent) %>%
# Labels all districts with their states so they are distinct
   mutate(district = str_remove(district, "^0+")) %>%
  mutate(district = paste(state, district, sep = "_")) %>%
# Separate candidate names
  separate(candidate_name, into = c("last_name", "first_name", "extra_name"), sep = "_", 
           extra = "merge", fill = "right") %>%
# Remove components of extra names (including white spaces) that aren't meaningful
  mutate(extra_name = gsub("\\s*(jr|iii|i|ii|sr)\\s*", "", extra_name)) %>%
# Replace underscores with a space
  mutate(extra_name = gsub('_', ' ', extra_name)) %>%
# Change any cell with just white spaces to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == "", NA, extra_name)) %>%
# Remove parentheses
  mutate(extra_name = gsub("[()]", "", extra_name)) %>%
# Remove redundant rows
  distinct(year, district, last_name, first_name, .keep_all = TRUE)
```

```{r}
# If first name is a suffix, the extra name was the first name 
# so move extra name value to first name
house_primaries$first_name <- 
  ifelse(house_primaries$first_name %in% c("jr", "sr", "ii", "iii", "iv"), 
         house_primaries$extra_name, house_primaries$first_name)

# Fill extra name with NA if extra name value got moved to first name
house_primaries$extra_name <-
  ifelse(house_primaries$extra_name == house_primaries$first_name, NA, 
         house_primaries$extra_name)
```



## Cleaning FEC Senate 2022


```{r}
# Column removal
senate_22 <- senate_22 %>%
  select(-c(office...2, office_full, party...4, election_years, cycles, load_date, first_file_date, last_file_date, last_f2_date, address_city, address_street_1, address_street_2, address_zip, district...7, district_number...8, election_districts, is_election, receipts, disbursements, cash_on_hand_end_period, debts_owed_by_committee, coverage_start_date, coverage_end_date, federal_funds_flag, has_raised_funds, individual_itemized_contributions, transfers_from_other_authorized_committee, other_political_committee_contributions, state_full, district...48, district_number...49, state...47, candidate_inactive...27, candidate_inactive...43, office...42, active_through,two_year_period, address_state, candidate_id...29, party...41, candidate_election_year, cycle, candidate_status, incumbent_challenge)) %>%
# Rename for clarity
  rename(party = party_full, state = state...6, candidate_id = candidate_id...19, year = election_year, incumbency = incumbent_challenge_full) %>%
# Set other parties to other
  mutate(party = case_when(
    party == "REPUBLICAN PARTY" ~ "REPUBLICAN",
    party == "DEMOCRATIC PARTY" ~ "DEMOCRAT",
    TRUE ~ "OTHER")) %>%
# Separates candidate names into last and the rest of the name
  separate(name, into = c("last_name", "first_extra_name"), sep = ",", extra = "merge", fill = "right") %>%
# Remove only leading white spaces before separating into first and extra name
  mutate(first_extra_name = str_trim(first_extra_name, side = "left")) %>%
# Separates names into first and middle/suffix
separate(first_extra_name, into = c("first_name", "extra_name"), sep = " ", extra = "merge", fill = "right") %>%
# Removes the word in quotes along with the quotes
  mutate(extra_name = ifelse(grepl('[\"“”]', extra_name), NA, extra_name)) %>%
# Removes the word in parentheses along with the parentheses
  mutate(extra_name = gsub('\\s*\\(.*?\\)\\s*', '', extra_name)) %>%
# Removes components of extra names (including white spaces) that aren't meaningful 
  mutate(extra_name = gsub("\\s*(DR|MR|MS|REVEREND|JUNIOR|PHD|SR|I|II|III|JR|REV
                           |PROF|PASTOR|COL|COLONEL|3RD|N/A|TRUMP AKA NOT MURKOWSK|- MASTER MASTER
                           |M.D.|V|S NOT YOUNG BUT)\\s*", "", extra_name)) %>%
# Removes any periods at the end of a name
  mutate(extra_name = gsub("\\.{1,2}$", "", extra_name)) %>%
# Removes nicknames denoted in quotes
   mutate(extra_name = ifelse(grepl('"', extra_name), NA, extra_name)) %>%
# Changes any cell with just white spaces to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == "", NA, extra_name)) %>%
# Changes any cell with just periods to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == ".", NA, extra_name))
```


## FEC House 2010

```{r}
# Column removal
house_2010 <- house_2010 %>%
  select(-c(office...2, office_full, party...4, election_years, cycles, load_date, first_file_date, last_file_date, last_f2_date, address_city, address_street_1, address_street_2, address_zip, is_election, receipts, disbursements, cash_on_hand_end_period, debts_owed_by_committee, coverage_start_date, coverage_end_date, federal_funds_flag, has_raised_funds, individual_itemized_contributions, transfers_from_other_authorized_committee, other_political_committee_contributions, state_full, district...48, district_number...49, state...47, candidate_inactive...27, candidate_inactive...43, office...42, active_through,two_year_period, address_state, candidate_id...29, party...41, candidate_election_year, cycle, candidate_status, incumbent_challenge, district...7, election_districts)) %>%
# Rename for clarity
  rename(party = party_full, state = state...6, candidate_id = candidate_id...19, year = election_year, incumbency = incumbent_challenge_full, district = district_number...8) %>%
# Only the 50 states
  filter(!state %in% c("MP", "DC", "AS", "GU", "VI")) %>%
# set other parties to other
  mutate(party = case_when(
    party == "REPUBLICAN PARTY" ~ "REPUBLICAN",
    party == "DEMOCRATIC PARTY" ~ "DEMOCRAT",
    TRUE ~ "OTHER")) %>%
# Separates candidate names into last and the rest of the name
  separate(name, into = c("last_name", "first_extra_name"), sep = ",", extra = "merge", fill = "right") %>%
# Remove only leading white spaces before separating into first and extra name
  mutate(first_extra_name = str_trim(first_extra_name, side = "left")) %>%
# Separates into first name and middle/suffix
  separate(first_extra_name, into = c("first_name", "extra_name"), sep = " ", extra = "merge", fill = "right") %>%
# Removes the word in quotes along with the quotes
  mutate(extra_name = ifelse(grepl('[\"“”]', extra_name), NA, extra_name)) %>%
# Removes the word in parentheses along with the parentheses
  mutate(extra_name = gsub('\\s*\\(.*?\\)\\s*', '', extra_name)) %>%
# Removes components of extra names (including white spaces) that aren't meaningful
  mutate(extra_name = gsub("\\s*(DR|MR|MS|REVEREND|JUNIOR|PHD|SR|I|II|III|JR|REV|
                           PROF|PASTOR|COL|COLONEL|3RD|N/A|TRUMP AKA NOT MURKOWSK|- MASTER MASTER
                           |M.D.|V|S NOT YOUNG BUT|MD)\\s*", "", extra_name)) %>%
  mutate(extra_name = gsub(",\\s*$", "", extra_name)) %>%
# Removes any periods at the end of a name
   mutate(extra_name = gsub("\\.{1,2}$", "", extra_name)) %>%
# Removes nicknames
   mutate(extra_name = ifelse(grepl('"|\'', extra_name), NA, extra_name)) %>%
# Changes any cell with just white spaces to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == "", NA, extra_name)) %>%
# Changes any cell with just periods to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == ".", NA, extra_name))
```


## Cleaning FEC House 2020

```{r}
# Column removal
house_2020 <- house_2020 %>%
  select(-c(office...2, office_full, party...4, election_years, cycles, load_date, first_file_date, last_file_date, last_f2_date, address_city, address_street_1, address_street_2, address_zip, is_election, receipts, disbursements, cash_on_hand_end_period, debts_owed_by_committee, coverage_start_date, coverage_end_date, federal_funds_flag, has_raised_funds, individual_itemized_contributions, transfers_from_other_authorized_committee, other_political_committee_contributions, state_full, district...48, district_number...49, state...47, candidate_inactive...27, candidate_inactive...43, office...42, active_through,two_year_period, address_state, candidate_id...29, party...41, candidate_election_year, cycle, candidate_status, incumbent_challenge, district...7, election_districts)) %>%
# Rename for clarity
  rename(party = party_full, state = state...6, candidate_id = candidate_id...19, year = election_year, incumbency = incumbent_challenge_full, district = district_number...8) %>%
# Only the 50 states
  filter(!state %in% c("MP", "DC", "AS", "GU", "VI")) %>%
# set other parties to other
  mutate(party = case_when(
    party == "REPUBLICAN PARTY" ~ "REPUBLICAN",
    party == "DEMOCRATIC PARTY" ~ "DEMOCRAT",
    TRUE ~ "OTHER")) %>%
# Separates candidate names into last and the rest of the name
  separate(name, into = c("last_name", "first_extra_name"), sep = ",", extra = "merge", fill = "right") %>%
# Remove only leading white spaces before separating into first and extra name
  mutate(first_extra_name = str_trim(first_extra_name, side = "left")) %>%
# Separates into first name and middle/suffix
  separate(first_extra_name, into = c("first_name", "extra_name"), sep = " ", extra = "merge", fill = "right") %>%
# Removes the word in quotes along with the quotes
 mutate(extra_name = ifelse(grepl('[\"“”]', extra_name), NA, extra_name)) %>%
# Removes the word in parentheses along with the parentheses
  mutate(extra_name = gsub('\\s*\\(.*?\\)\\s*', '', extra_name)) %>%
# Removes components of extra names (including white spaces) that aren't meaningful
  mutate(extra_name = gsub("\\s*(DR|MR|MS|REVEREND|JUNIOR|PHD|SR|I|II|III|JR|REV
                           |PROF|PASTOR|COL|COLONEL|3RD|N/A|TRUMP AKA NOT MURKOWSK|- MASTER MASTER
                           |M.D.|V|S NOT YOUNG BUT|MD)\\s*", "", extra_name)) %>%
  # Removes commas at end
  mutate(extra_name = gsub(",\\s*$", "", extra_name)) %>%
# Removes any periods at the end of a name
   mutate(extra_name = gsub("\\.{1,2}$", "", extra_name)) %>%
# Removes nicknames
   mutate(extra_name = ifelse(grepl('"|\'', extra_name), NA, extra_name)) %>%
# Changes any cell with just white spaces to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == "", NA, extra_name)) %>%
# Changes any cell with just periods to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == ".", NA, extra_name))
```



## Cleaning FEC House 2022

```{r}
# Column removal
house_2022 <- house_2022 %>%
  select(-c(office...2, office_full, party...4, election_years, cycles, load_date, first_file_date, last_file_date, last_f2_date, address_city, address_street_1, address_street_2, address_zip, is_election, receipts, disbursements, cash_on_hand_end_period, debts_owed_by_committee, coverage_start_date, coverage_end_date, federal_funds_flag, has_raised_funds, individual_itemized_contributions, transfers_from_other_authorized_committee, other_political_committee_contributions, state_full, district...48, district_number...49, state...47, candidate_inactive...27, candidate_inactive...43, office...42, active_through,two_year_period, address_state, candidate_id...29, party...41, candidate_election_year, cycle, candidate_status, incumbent_challenge, district...7, election_districts)) %>%
# Rename for clarity
  rename(party = party_full, state = state...6, candidate_id = candidate_id...19, year = election_year, incumbency = incumbent_challenge_full, district = district_number...8) %>%
# Only the 50 states
  filter(!state %in% c("MP", "DC", "AS", "GU", "VI")) %>%
# set other parties to other
  mutate(party = case_when(
    party == "REPUBLICAN PARTY" ~ "REPUBLICAN",
    party == "DEMOCRATIC PARTY" ~ "DEMOCRAT",
    TRUE ~ "OTHER")) %>%
# Separates candidate names into last and the rest of the name
  separate(name, into = c("last_name", "first_extra_name"), sep = ",", extra = "merge", fill = "right") %>%
# Remove only leading white spaces before separating into first and extra name
  mutate(first_extra_name = str_trim(first_extra_name, side = "left")) %>%
# Separates into first name and middle/suffix
  separate(first_extra_name, into = c("first_name", "extra_name"), sep = " ", extra = "merge", fill = "right") %>%
# Removes the word in quotes along with the quotes
  mutate(extra_name = ifelse(grepl('[\"“”]', extra_name), NA, extra_name)) %>%
# Removes the word in parentheses along with the parentheses
  mutate(extra_name = gsub('\\s*\\(.*?\\)\\s*', '', extra_name)) %>%
# Removes components of extra names (including white spaces) that aren't meaningful
  mutate(extra_name = gsub("\\s*(DR|MR|MS|REVEREND|JUNIOR|PHD|SR|I|II|III|JR|REV|PROF
                           |PASTOR|COL|COLONEL|3RD|N/A|TRUMP AKA NOT MURKOWSK|- MASTER MASTER
                           |M.D.|V|S NOT YOUNG BUT|MD)\\s*", "", extra_name)) %>%
  mutate(extra_name = gsub(",\\s*$", "", extra_name)) %>%
# Removes any periods at the end of a name
   mutate(extra_name = gsub("\\.{1,2}$", "", extra_name)) %>%
# Removes nicknames
   mutate(extra_name = ifelse(grepl('"|\'', extra_name), NA, extra_name)) %>%
# Changes any cell with just white spaces to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == "", NA, extra_name)) %>%
# Changes any cell with just periods to NA
  mutate(extra_name = ifelse(str_trim(extra_name) == ".", NA, extra_name))
```



## Cleaning Governors 2010


```{r}
governors_2010 <- governors_2010 %>%
# Removes irrelevant columns
  select(-c(`Write-ins`, Occupation, `Primaries spending`, `GE spending`, `Total spending`)) %>%
# Remove write-ins because BISG not available
  filter(Candidate != "Write-ins") %>%
# Set other parties to other
  mutate(Party = case_when(
    Party %in% "R" ~ "Republican",
    Party %in% "D" ~ "Democrat",
    TRUE ~ "Other"))
```

```{r}
governors_2010 %>%
  group_by(State)
```

```{r}
governors_2010 <- governors_2010 %>%
  rename(general = `General election`, primary = Primaries)
```


Should I do winners this way?
generals complete

https://archive.nytimes.com/www.nytimes.com/elections/2010/results/governor.html?scp=3&sq=governor%20elections&st=cse


```{r}
governors_2010 <- governors_2010 %>%
  mutate(General_Result =
           ifelse(Candidate %in% c("Sean Parnell", "Robert Bentley", "Mike Beebe", "Jan Brewer", "Edmund G. “Jerry” Brown", "John Hickenlooper", "Dannel Malloy", "Rick Scott", "Nathan Deal", "Neil Abercrombie", "Terry Branstad", "CL “Butch” Otter", "Patrick Quinn", "Sam Brownback", "Deval Patrick", "Martin O’Malley", "Paul R. LePage", "Rick Snyder", "Mark Dayton", "Dave Heineman", "John H. Lynch", "Susana Martinez", "Brian Sandoval", "Andrew Cuomo", "John Kasich", "Mary Fallin", "John Kitzhaber", "Tom Corbett", "Lioln Chafee", "Nikki R. Haley", "Dennis Daugaard", "Bill Haslam", "Rick Perry", "Gary Herbert", "Peter Shumlin", "Scott Walker", "Matt Mead"), "Won", "Lost"))
```


```{r}
governors_2010 <- governors_2010 %>%
  mutate(Primary_Result = ifelse(General_Result == "Won", "Won", 
                                  ifelse(Candidate %in% c("	
Ethan Berkowitz", "	
Ron Sparks", "Jim Keet", "Terry Goddard", "	
Meg Whitman", ""), "Won", "Lost")))
```

```{r}
governors_2010 %>%
  filter(`Republican primary` == 1)
```


```{r}
la_governors_2010 <- governors_2010 %>%
  mutate(primary = case_when(
    primary == "mini" ~ NA,
    TRUE ~ primary
  )) %>%
  mutate(general = case_when(
    general == "mini" ~ NA,
    TRUE ~ general
  ))
```


```{r}
results_governors_2010 %>%
  filter(Race == "P/G")
```

```{r}
unique(governors_2010$State)
```




```{r}
governors_2010 <- governors_2010 %>%
  filter(!Candidate %in% c("Total: Andrew Cuomo", "Total: Carl Paladino")) %>%
  filter(!(Candidate == "Andrew Cuomo" & Party == "Other"))
```


```{r}
governors_2010 <- governors_2010 %>%
  filter(!grepl("withdrew|dropped|removed|eliminated", notes, ignore.case = TRUE))
```

```{r}
governors_2010 %>%
  filter(!is.na(notes))
```



```{r}
unique_candidates <- governors_2010 %>%
  distinct(Candidate)
```



```{r}
# separates candidate names
governors_2010 <- governors_2010 %>%
  separate(Candidate, into = c("first_name", "middle_name","last_name"), sep = " ", extra = "merge", fill = "right")

# If nothing was put in last_name, the second name was the last name so move middle_name value to last_name
governors_2010$last_name <- ifelse(is.na(governors_2010$last_name), governors_2010$middle_name, governors_2010$last_name)

# Fill middle_name with NA if middle_name value got moved to last_name
governors_2010$middle_name <- ifelse(governors_2010$middle_name == governors_2010$last_name, NA, governors_2010$middle_name)

# Removes any periods at the end of a name
governors_2010 <- governors_2010 %>%
  mutate(middle_name = gsub("\\.{1,2}$", "", middle_name)) %>%
# Removes nicknames
  mutate(middle_name = ifelse(grepl('[\"“”]', middle_name), NA, middle_name)) %>%
# Removes the word in parentheses along with the parentheses
  mutate(middle_name = gsub('\\s*\\(.*?\\)\\s*', '', middle_name))
```


```{r}
governors_2010 <- governors_2010 %>%
  filter(!first_name %in% c("8", "Others", "None", "Total:"))
```

```{r}
governors_2010 <- governors_2010 %>%
  mutate(last_name = gsub("\\s*(Sr|Jr|I|II|III)\\s*", "", last_name))
```

```{r}
governors_2010 <- governors_2010 %>%
# Removes any periods at the end of a name
   mutate(last_name = gsub("\\.{1,2}$", "", last_name)) %>%
# Removes and signs
  mutate(last_name = gsub("&", "", last_name)) %>%
# Changes any cell with just white spaces to NA
  mutate(last_name = ifelse(str_trim(last_name) == "", NA, last_name)) %>%
  mutate(middle_name = ifelse(str_trim(middle_name) == "", NA, middle_name)) %>%
# Changes any cell with just periods to NA
  mutate(last_name = ifelse(str_trim(last_name) == ".", NA, last_name))
```

```{r}
# re-run
# If nothing was put in last_name, the second name was the last name so move middle_name value to last_name
governors_2010$last_name <- ifelse(is.na(governors_2010$last_name), governors_2010$middle_name, governors_2010$last_name)

# Fill middle_name with NA if middle_name value got moved to last_name
governors_2010$middle_name <- ifelse(governors_2010$middle_name == governors_2010$last_name, NA, governors_2010$middle_name)
```

```{r}
governors_2010 <- governors_2010 %>%
  mutate(last_name = str_trim(last_name, side = "left"))
```

```{r}
governors_2010 <- governors_2010 %>%
 mutate(last_name = gsub("&", "", last_name))
```

```{r}
# Correcting an error
governors_2010$middle_name[104] <- "P"
governors_2010$last_name[104] <- "Moore"
```

```{r}
# Struggling with quotations
governors_2010 %>%
mutate(last_name = gsub('[\"“”]', "", last_name)) %>%
  filter(first_name == "Edmund")
```



## Cleaning Governors 2012

12 states

```{r}
governors_2012 <- governors_2012 %>%
  # Assign clear values
 mutate(Party = case_when(
    str_detect(Party, "Republican") ~ "Republican",
    str_detect(Party, "Democrat") ~ "Democrat",
    TRUE ~ "Other"
  )) %>%
   mutate(Occupation = ifelse(Occupation %in% "Incumbent", "Incumbent", "Challenger")) %>%
  # Rename variable
   rename(Incumbency = Occupation) %>%
  # Remove candidates not in race
  filter(Result != "Dropped Out" & Result != "Withdrew") %>%
  # Remove unnamed candidates
  filter(!str_detect(Candidate, "Other|Others")) %>%
  # Make variable for primary result
  mutate(Primary = ifelse(Result == "Lost Primary", "Lost", "Won")) %>%
  # Make variable for general result
  # Candidates without result pertaining to general election marked as "Did Not Advance"
  mutate(General = ifelse(Result == "Won General", "Won", 
                          ifelse(Result == "Lost General", "Lost", "Did Not Advance"))) %>%
  # Variable no longer needed
  select(-Result)
```

```{r}
# First round of name splitting

space_states <- governors_2012 %>%
  # Filter to states that use spaces for name variable separation
  filter(!State %in% c("IN", "MO", "MT", "NH", "NC", "ND", "UT")) %>%
  # Split into first name and last name
  separate(Candidate, into = c("first_name", "last_name"), 
           sep = " ", extra = "merge", fill = "right")
  
comma_states <- governors_2012 %>%
  # Filter to states that use commas for name variable separation
  filter(State %in% c("IN", "MO", "MT", "NH", "NC", "ND", "UT")) %>%
  # Split into last name and first name
  separate(Candidate, into = c("last_name", "first_name"),
           sep = ",", extra = "merge", fill = "right")

space_states <- space_states %>%
  # Remove nicknames denoted by quotes
  mutate(first_name = ifelse(grepl('[\"“”]', first_name), NA, first_name)) %>%
  mutate(last_name = ifelse(grepl('[\"“”]', last_name), NA, last_name)) %>%
  # Remove the word in parentheses along with the parentheses
  mutate(first_name = gsub('\\s*\\(.*?\\)\\s*', '', first_name)) %>%
  mutate(last_name = gsub('\\s*\\(.*?\\)\\s*', '', last_name))

comma_states <- comma_states %>%
  # Remove nicknames denoted by quotes
  mutate(first_name = ifelse(grepl('[\"“”]', first_name), NA, first_name)) %>%
  mutate(last_name = ifelse(grepl('[\"“”]', last_name), NA, last_name)) %>%
  # Remove the word in parentheses along with the parentheses
  mutate(first_name = gsub('\\s*\\(.*?\\)\\s*', '', first_name)) %>%
  mutate(last_name = gsub('\\s*\\(.*?\\)\\s*', '', last_name))

space_states <- space_states %>%
  # Remove white spaces in first and last names
  mutate(first_name = str_trim(first_name),
         last_name = str_trim(last_name))

  # Remove white spaces in first and last names
comma_states <- comma_states %>%
  mutate(first_name = str_trim(first_name),
         last_name = str_trim(last_name))

# Second round of name splitting

space_states <- space_states %>%
  # Split into middle name and last name
  separate(last_name, into = c("middle", "last"), sep = " ", 
           extra = "merge", fill = "right")

comma_states <- comma_states %>% 
  # Split into first name and middle name
      separate(first_name, into = c("first", "middle"), sep = " ", 
               extra = "merge", fill = "left")

# If nothing was put in last_name, the second name was the last name 
# so move middle_name value to last_name
space_states$last <- ifelse(is.na(space_states$last), space_states$middle, 
                            space_states$last)

# Fill middle_name with NA if middle_name value got moved to last_name
space_states$middle <- ifelse(space_states$middle == space_states$last, NA, 
                              space_states$middle)

# If nothing was put in first, the middle name is the first name
comma_states$first <- ifelse(is.na(comma_states$first), comma_states$middle, 
                             comma_states$first)

# Fill middle name with NA if middle name value got moved to first name
comma_states$middle <- ifelse(comma_states$middle == comma_states$first, NA, 
                              comma_states$middle)

# Rename variables for merge
comma_states <- comma_states %>%
  rename(first_name = first,
         middle_name = middle)

# Rename variables for merge
space_states <- space_states %>%
  rename(middle_name = middle,
         last_name = last)

# Bind the rows back
governors_2012 <- bind_rows(space_states, comma_states)
```

```{r}
governors_2012 <- governors_2012 %>%
  # Change to uppercase
  mutate(first_name = toupper(first_name),
         middle_name = toupper(middle_name),
         last_name = toupper(last_name)) %>%
   # Remove the period at the end of one letter middle names 
   mutate(middle_name = gsub('\\.$', '', middle_name)) %>%
   # Remove white space
   mutate(middle_name = str_trim(middle_name))

# Manual name fix
governors_2012 <- governors_2012 %>%
  mutate(first_name = ifelse(last_name == "FANNING", "ROBERT", first_name),
         middle_name = ifelse(last_name == "FANNING", NA, middle_name)) %>%
   # Remove redundant rows
  distinct(State, last_name, first_name, .keep_all = TRUE)
```



## Cleaning Governors 2014

36 states

```{r}
governors_2014 <- governors_2014 %>%
  mutate(Party = case_when(
    Party %in% "Republican" ~ "Republican",
    Party %in% "Democrat" ~ "Democrat",
    TRUE ~ "Other")) %>%
mutate(Occupation = ifelse(Occupation %in% "Incumbent", "Incumbent", "Challenger")) %>%
  rename(Incumbency = Occupation)

governors_2014$Result[10] <- "Lost Primary" # fixing a typo

# making variable for primary result
governors_2014 <- governors_2014 %>%
  mutate(Primary = ifelse(Result %in% c("Lost Primary", "Lost Convention", "Lost Primary and General", "Lost"), "Lost", "Won")) %>%
# making variable for general result
  mutate(General = ifelse(Result == "Won General", "Won", ifelse(Result %in% c("Lost General","Lost Primary and General","Lost"), "Lost", "Did Not Advance"))) %>%
# No longer needed
  select(-Result) %>%
# Separates candidate names 
  separate(Candidate, into = c("first_name", "middle_name", "last_name"), sep = " ", extra = "merge", fill = "right")
  
# If there was nothing put in the last name column, the second name was the last name so move the name in middle name to last name column
governors_2014$last_name <- 
  ifelse(is.na(governors_2014$last_name), governors_2014$middle_name, governors_2014$last_name)

# Fill the middle name with NA if the middle name value got put to last name
governors_2014$middle_name <-
  ifelse(governors_2014$middle_name == governors_2014$last_name, NA, governors_2014$middle_name)

governors_2014 <- governors_2014 %>%
  mutate(last_name = gsub("\\*\\d+$", "", last_name)) # takes out the asterisk and numbers that appear on some names, the d+ refers to digits, the $ references the end of the string

governors_2014 <- governors_2014 %>%
  filter(first_name != "Write-Ins") %>%
     # Removes the period at the end of one letter first names 
   mutate(first_name = gsub('\\.$', '', first_name)) %>%
    # Removes the period at the end of one letter middle names 
   mutate(middle_name = gsub('\\.$', '', middle_name))
```

```{r}
# Manual name fixes
governors_2014$last_name[102] <- "Shepard"
governors_2014$last_name[105] <- "Pennington"
governors_2014$last_name[175] <- "Snyder"
governors_2014$last_name[176] <- "Schauer"
governors_2014$last_name[177] <- "Buzuma"
governors_2014$last_name[178] <- "Homeniuk"
governors_2014$last_name[179] <- "McFarlin"
governors_2014$last_name[198] <- "Elworth"
governors_2014$last_name[268] <- "Healey"
governors_2014$first_name[9] <- "JR"
governors_2014$first_name[35] <- "John"
governors_2014$middle_name[35] <- "Ward"
governors_2014$last_name[35] <-"Molina"
governors_2014$last_name[301] <- "Marceaux"
governors_2014$middle_name[c(301, 42,198,179,178,177,176,175,105,102)] <- NA
```


## Cleaning Governors 2016

12 states


```{r}
governors_2016 <- governors_2016 %>%
  mutate(Party = case_when(
    Party %in% "Republican" ~ "Republican",
    Party %in% "Democrat" ~ "Democrat",
    TRUE ~ "Other")) %>%
 mutate(Occupation = case_when(
    Occupation == "Incumbent Attorney General of Missouri" ~ "Challenger", # Exception case
    grepl("Incumbent", Occupation) ~ "Incumbent", # Anything w/ incumbent gets marked incumbent          
    is.na(Occupation) ~ NA_character_, # Keeps NAs as NAs                              
    TRUE ~ "Challenger")) %>% # Everyone else is a challenger
  rename(Incumbency = Occupation) %>%
  filter(!Result %in% c("Withdrew *", "(withdrew)", "(not on ballot)", "NA", "N/A", "-", "Withdrew", NA)) %>%
# Making variable for primary result
  mutate(Primary = ifelse(Result %in% c("Lost Primary", "Lost primary election", "Lost at party convention"), "Lost", "Won")) %>%
# Making variable for general result
  mutate(General = ifelse(Result == "Won General" | Result == "Won general election", "Won", ifelse(Result %in% c("Lost General","Lost general","Lost general election"), "Lost", "Did Not Advance"))) %>%
# No longer needed
  select(-Result) %>%
  filter(!Candidate %in% c("write-in", "Write-in", "Write-In")) %>%
  select(-`Candidate Filing Date`)

# Removes nickname used for the Republican candidate in Washington
governors_2016$Candidate[90] <- "Michael Nelson"

# Created a named vector to reassign spelled-out states to abbreviations
state_mapping <- c("Delaware" = "DE", "Indiana" = "IN",
  "Missouri" = "MO", "Montana" = "MT", "New Hampshire" = "NH",
  "North Carolina" = "NC", "North Dakota" = "ND", "Oregon" = "OR", "Utah" = "UT",
  "Vermont" = "VT", "Washington" = "WA", "West Virginia" = "WV")

# Indexed at vector to reassign values
governors_2016 <- governors_2016 %>%
   mutate(State = state_mapping[State]) %>%
# separates candidate names
  separate(Candidate, into = c("first_name", "middle_name", "last_name"), sep = " ", extra = "merge", fill = "right")
  
# if there was nothing put in the last name column, the second name was the last name so move the name in middle name to last name column
governors_2016$last_name <- 
  ifelse(is.na(governors_2016$last_name), governors_2016$middle_name, governors_2016$last_name)

# fill the middle name with NA if the middle name value got put to last name
governors_2016$middle_name <-
  ifelse(governors_2016$middle_name == governors_2016$last_name, NA, governors_2016$middle_name)
```

```{r}
governors_2016 <- governors_2016 %>%
    # Removes the period at the end of one letter middle names 
   mutate(middle_name = gsub('\\.$', '', middle_name)) %>%
        # Removes the period at the end of one letter first names 
   mutate(first_name = gsub('\\.$', '', first_name))
```

```{r}
governors_2016$first_name[89] <- "Michael"
governors_2016$middle_name[89] <- "George"
governors_2016$last_name[89] <- "Nelson"
governors_2016$last_name[1] <- "Carney"
governors_2016$last_name[12] <- "Steinman"
governors_2016$last_name[22] <- "Turilli"
governors_2016$last_name[24] <- "Brown"
governors_2016$last_name[29] <- "Nelson"
governors_2016$last_name[30] <- "Dunlap"
governors_2016$first_name[66] <- "William"
governors_2016$last_name[74] <- "Tavares"

governors_2016$middle_name[c(24,29,30,74,88)] <- NA
```

```{r}
# Removes duplicate candidate, a write-in candidate, 
governors_2016 <- governors_2016[-c(90,6,80),]
```



## BISG

BISG prep

```{r}
Sys.setenv(CENSUS_API_KEY = "d751138a4df18e65bb578d33e8d239b171dbda5d")
```

```{r}
# Scraping census data

census.data <- get_census_data(
  # Personal API key from US Census Bureau
  key = Sys.getenv("CENSUS_API_KEY"),
  states = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", 
  "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
  "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", 
  "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", 
  "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"),
  age = FALSE,
  sex = FALSE,
  year = "2010",
  census.geo = c("county"),
  # Number of times to reboot if network error
  retry = 1)
```

sleg bisg attempt

```{r}
sleg_BISG <- sleg %>%
  select(county_fips, last_name, first_name, state, year) %>%
  # Put leading zeros as needed
  mutate(county_fips = str_trim(county_fips)) %>%
  filter(nchar(county_fips) != 4) %>%
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  rename(surname = last_name,
         county = county_fips,
         first = first_name) %>%
  mutate(surname = toupper(surname),
         first = toupper(first))

full_name <- sleg_BISG %>% filter(!is.na(first))
just_surname <- sleg_BISG %>% filter(is.na(first))

results_full_name <- predict_race(
  voter.file = full_name,
  census.surname = TRUE,
  surname.only = FALSE,
  names.to.use = "surname, first",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  year = "2020",
  skip_bad_geos = TRUE) 

skipped_rows <- anti_join(full_name, results_full_name, by = c("county", "surname", "first", "state", "year"))
skipped_rows <- skipped_rows %>%
  mutate(pred.whi = NA,
         pred.bla = NA,
         pred.his = NA,
         pred.asi = NA,
         pred.oth = NA)

results_just_surname <- predict_race(
  voter.file = just_surname,
  census.surname = TRUE,
  surname.only = TRUE,
  names.to.use = "surname",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  year = "2020",
  skip_bad_geos = TRUE)

sleg_results <- rbind(results_full_name, results_just_surname, skipped_rows)
```

```{r}
sleg_results <- sleg_results %>%
  rename(last_name = surname,
         first_name = first,
         county_fips = county)

sleg <- sleg %>%
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  mutate(first_name = toupper(first_name),
         last_name = toupper(last_name),
         middle_name = toupper(middle_name))

sleg_full <- full_join(sleg, sleg_results, by = c("county_fips", "last_name", "first_name", "state"))
```







```{r}
hun_six <- read.csv("DOA_csv/Crosswalk_2010_116.csv")
```

```{r}
fips_match <- read.csv("Fips Match Sheet - Sheet1.csv")
```

```{r}
# Create named vector to reassign spelled-out states to abbreviations
state_mapping <- c(
  "Alabama" = "AL", "Alaska" = "AK", "Arizona" = "AZ", "Arkansas" = "AR", 
  "California" = "CA", "Colorado" = "CO", "Connecticut" = "CT", "Delaware" = "DE",
  "Florida" = "FL", "Georgia" = "GA", "Hawaii" = "HI", "Idaho" = "ID",
  "Illinois" = "IL", "Indiana" = "IN", "Iowa" = "IA", "Kansas" = "KS",
  "Kentucky" = "KY", "Louisiana" = "LA", "Maine" = "ME", "Maryland" = "MD",
  "Massachusetts" = "MA", "Michigan" = "MI", "Minnesota" = "MN", "Mississippi" = "MS",
  "Missouri" = "MO", "Montana" = "MT", "Nebraska" = "NE", "Nevada" = "NV",
  "New Hampshire" = "NH", "New Jersey" = "NJ", "New Mexico" = "NM", "New York" = "NY",
  "North Carolina" = "NC", "North Dakota" = "ND", "Ohio" = "OH", "Oklahoma" = "OK",
  "Oregon" = "OR", "Pennsylvania" = "PA", "Rhode Island" = "RI", "South Carolina" = "SC",
  "South Dakota" = "SD", "Tennessee" = "TN", "Texas" = "TX", "Utah" = "UT",
  "Vermont" = "VT", "Virginia" = "VA", "Washington" = "WA", "West Virginia" = "WV",
  "Wisconsin" = "WI", "Wyoming" = "WY")

# Index at vector to reassign state values
hun_six <- hun_six %>%
   mutate(cd_state = state_mapping[cd_state])
```

```{r}
hun_six <- hun_six %>%
# Label all districts with their states so they are distinct
  rename(county_name = nhgisnam,
         state_name = cd_state,
         state_fips = cd_statefip) %>%
    mutate(county_name = tolower(county_name)) %>%
  select(county_name, state_name, state_fips, district) %>%
  filter(district != 98)
```

```{r}
fips_match <- fips_match %>%
  rename(county_name = County.Name,
         state_fips = FIPS.State,
         county_fips = FIPS.County,
         state_name = State) %>%
  mutate(county_name = tolower(county_name))
```

```{r}
fips_match <- fips_match %>%
   mutate(state_name = state_mapping[state_name])
```


```{r}
nrow(hun_six)
nrow(fips_match)
```

```{r}
full_match <- left_join(hun_six, fips_match, by = c("county_name", "state_fips", "state_name"))
```

1213 non matches

```{r}
full_match <- full_match %>%
  select(-c(state_fips, county_name)) %>%
  rename(state = state_name) %>%
 # Label all districts with their states so they are distinct
   mutate(district = paste(state, district, sep = "_"))
```

Senate:

```{r}
senate <- left_join(senate_generals, full_match, by = c("state"))
```

```{r}
SBISG <- senate %>%
  select(county_fips, last_name, first_name, middle_name, state, party) %>%
  mutate(party = case_when(
    party == "DEMOCRAT" ~ "1",
    party == "REPUBLICAN" ~ "2",
    party == "OTHER" ~ "0")) %>%
  # Put leading zeros as needed
  mutate(county_fips = str_trim(county_fips)) %>%
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  rename(surname = last_name,
         county = county_fips,
         first = first_name,
         middle = middle_name) %>%
  filter(!is.na(county) & !is.na(surname)) %>%
  distinct()
```

```{r}
RSBISG <- predict_race(
  voter.file = SBISG,
  census.surname = TRUE,
  surname.only = FALSE,
  names.to.use = "surname, first, middle",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  party = "party",
  year = "2020",
  skip_bad_geos = TRUE) 
```

```{r}
RSBISG <- RSBISG %>%
   distinct(first, surname, county, state, .keep_all = TRUE) %>%
  group_by(first, surname, state) %>%
  mutate(avg_white = mean(pred.whi),
         avg_black = mean(pred.bla),
         avg_his = mean(pred.his),
         avg_asi = mean(pred.asi),
         avg_other = mean(pred.oth)) %>%
    mutate(
      race = case_when(
      avg_white == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "white",
      avg_black == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "black",
      avg_his == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "hispanic",
      avg_asi == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "asian",
      avg_other == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "other")) 

RSBISG <- as.data.frame(RSBISG)

RSBISG <- RSBISG %>%
   group_by(first, surname, middle, state) %>%
    mutate(
      race = case_when(
  abs(avg_white - avg_black) <= 0.2 ~ "check",
  TRUE ~ race)) %>%
  ungroup() %>%
 select(surname, first, state, middle, race) %>%
  rename(first_name = first,
         last_name = surname,
         middle_name = middle) %>%
   distinct()
```


```{r}
senate_BISG <- left_join(senate_generals, RSBISG, by = c("state", "last_name", "first_name", "middle_name"))
```


House:

```{r}
house <- left_join(house_generals, full_match, by = c("state", "district"))
```

```{r}
HBISG <- house %>%
  select(county_fips, last_name, first_name, middle_name, state, party) %>%
  mutate(party = case_when(
    party == "DEMOCRAT" ~ "1",
    party == "REPUBLICAN" ~ "2",
    party == "OTHER" ~ "0")) %>%
  # Put leading zeros as needed
  mutate(county_fips = str_trim(county_fips)) %>%
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  rename(surname = last_name,
         county = county_fips,
         first = first_name,
         middle = middle_name) %>%
  filter(!is.na(county) & !is.na(surname)) %>%
  distinct()
```

```{r}
HBISG <- predict_race(
  voter.file = HBISG,
  census.surname = TRUE,
  surname.only = FALSE,
  names.to.use = "surname, first, middle",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  party = "party",
  year = "2020",
  skip_bad_geos = TRUE) 
```

```{r}
RHBISG <- HBISG %>%
   distinct(first, surname, county, state, .keep_all = TRUE) %>%
  group_by(first, surname, state) %>%
  mutate(avg_white = mean(pred.whi),
         avg_black = mean(pred.bla),
         avg_his = mean(pred.his),
         avg_asi = mean(pred.asi),
         avg_other = mean(pred.oth)) %>%
    mutate(
      race = case_when(
      avg_white == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "white",
      avg_black == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "black",
      avg_his == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "hispanic",
      avg_asi == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "asian",
      avg_other == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "other")) 

RHBISG <- as.data.frame(RHBISG)

RHBISG <- RHBISG %>%
   group_by(first, surname, middle, state) %>%
    mutate(
      race = case_when(
  abs(avg_white - avg_black) <= 0.2 & avg_black >= 0.3 ~ "check",
  TRUE ~ race)) %>%
  ungroup() %>%
 select(surname, first, state, middle, race) %>%
  rename(first_name = first,
         last_name = surname,
         middle_name = middle) %>%
   distinct()
```


```{r}
house_BISG <- left_join(house_generals, RHBISG, by = c("state", "last_name", "first_name", "middle_name"))
```


House primaries: 

```{r}
house_p <- left_join(house_primaries, full_match, by = c("district"))
```


```{r}
pHBISG <- house_p %>%
  select(county_fips, last_name, first_name, state) %>%
  # Put leading zeros as needed
  mutate(county_fips = str_trim(county_fips)) %>%
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  rename(surname = last_name,
         county = county_fips,
         first = first_name) %>%
  mutate(surname = toupper(surname),
         first = toupper(first)) %>%
  filter(!is.na(county) & !is.na(surname))
```

```{r}
pRHBISG <- predict_race(
  voter.file = pHBISG,
  census.surname = TRUE,
  surname.only = FALSE,
  names.to.use = "surname, first",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  year = "2020",
  skip_bad_geos = TRUE) 
```

```{r}
pRHBISG <- pRHBISG %>%
  distinct(first, surname, county, state, .keep_all = TRUE) %>%
  group_by(first, surname, state) %>%
  mutate(avg_white = mean(pred.whi),
         avg_black = mean(pred.bla),
         avg_his = mean(pred.his),
         avg_asi = mean(pred.asi),
         avg_other = mean(pred.oth)) %>%
    mutate(
      race = case_when(
      avg_white == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "white",
      avg_black == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "black",
      avg_his == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "hispanic",
      avg_asi == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "asian",
      avg_other == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "other")) 

pRHBISG <- as.data.frame(pRHBISG)

pRHBISG <- pRHBISG %>%
   group_by(first, surname, state) %>%
    mutate(
      race = case_when(
  abs(avg_white - avg_black) <= 0.2 ~ "check",
  TRUE ~ race)) %>%
  ungroup() %>%
 select(surname, first, state, race) %>%
  rename(first_name = first,
         last_name = surname) %>%
   distinct()
```

```{r}
pRHBISG <- pRHBISG %>%
  mutate(last_name = tolower(last_name),
         first_name = tolower(first_name))
```

```{r}
house_p_BISG <- left_join(house_primaries, pRHBISG, by = c("state", "last_name", "first_name"))
```





```{r}
house_p_protest <- left_join(house_p_BISG, protest_district, by = c("district"))
```



```{r}
senate_2020 <- senate_BISG %>%
  filter(year == 2020)
```

```{r}
protest_district <- protest_district %>%
  rename(state = State)
```


```{r}
senate_protest_2020 <- left_join(senate_2020, protest_district, by = "state")
```

```{r}
senate_protest_2020 <- senate_protest_2020 %>%
  group_by(state) %>%
  select(-c(district, year, state, special, County)) %>%
  mutate(Frequency = n()) %>%
  mutate(across(c(Size, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas), 
      ~ sum(.x, na.rm = TRUE))) %>%
  distinct(state, last_name, .keep_all = TRUE)
```

```{r}
# Filling in "check race"
# denoting middle eastern as asian for hand coding

senate_protest_2020 <- senate_protest_2020 %>%
  mutate(race = case_when(
    last_name == "JONES" ~ "white",
    first_name == "MOHAMMAD" ~ "asian",
    last_name == "KAPADIA" ~ "hispanic",
    last_name == "RODRIGUEZ" ~ "hispanic",
    last_name == "SANCHEZ" ~ "hispanic",
    last_name == "WILSON" ~ "black",
    last_name == "BOOKER" ~ "black",
    last_name == "MEHTA" ~ "asian",
    last_name == "FERNANDEZ" ~ "hispanic",
    last_name == "LUJAN" ~ "hispanic",
    last_name == "TAHER" ~ "asian",
    last_name == "BRADSHAW" ~ "black",
    last_name == "TURULLOLS-BONILLA" ~ "hispanic",
    last_name == "JOHNSON" ~ "white",
    last_name == "TAYLOR" ~ "white",
    last_name == "DARET" ~ "white",
    last_name == "JOHN" ~ "white",
    last_name == "MENDOZA" ~ "hispanic",
    last_name == "CUNNINGHAM" ~ "white",
    last_name == "BARTELL" ~ "black",
    last_name == "FORTUIN" ~ "white",
    last_name == "WINFIELD" ~ "white",
    last_name == "HARRISON" ~ "black",
    last_name == "GROSS" ~ "white",
    TRUE ~ race
  ))
```




```{r}
house_2020 <- house_BISG %>%
  filter(year == 2020)
```


```{r}
house_protest_2020 <- left_join(house_2020, protest_district, by = c("district", "state"))
```

```{r}
house_protest_2020 <- house_protest_2020 %>%
  group_by(district) %>%
  select(-c(year, County)) %>%
  mutate(Frequency = n()) %>%
  mutate(across(c(Size, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas), 
      ~ sum(.x, na.rm = TRUE))) %>%
  distinct(district, last_name, .keep_all = TRUE)
```


```{r}
# filling in race check

house_protest_2020 <- house_protest_2020 %>%
  mutate(race = case_when(
    last_name == "MOORE" ~ "white",
    last_name == "ROGERS" ~ "white",
    last_name == "OMAR" ~ "black",
    last_name == "SEWELL" ~ "black",
    last_name == "GILES" ~ "white",
    last_name == "EARLY" ~ "white",
    last_name == "WALKER" ~ "black",
    last_name == "ELLISON" ~ "black",
    last_name == "MUCARSEL-POWELL" ~ "white",
    last_name == "RUSH" ~ "black",
    
    TRUE ~ race
  ))
```

```{r}
house_protest_2020 %>%
  filter(race == "check")
```




```{r}
white_candidates <- house_protest_2020 %>%
  filter(race == "white") %>%
  mutate(success = ifelse(result == "WON", 1, 0))

white_candidates <- white_candidates %>%
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas, Size, Frequency),
    ~ ifelse(is.na(.), 0, .)
  ))

model <- glm(
  success ~ Size,
  data = white_candidates,
  family = binomial)

# Summarize model results
summary(model)
```

```{r}
white_candidates <- senate_protest_2020 %>%
  filter(race == "white") %>%
  mutate(success = ifelse(result == "WINNER", 1, 0))

white_candidates <- white_candidates %>%
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas, Size, Frequency),
    ~ ifelse(is.na(.), 0, .)
  ))

model <- glm(
  success ~ Frequency,
  data = white_candidates,
  family = binomial)

# Summarize model results
summary(model)
```



