---
title: "Cleaning Protest Data"
author: "Julianne Lempert"
date: "`r Sys.Date()`"
output: html_document
---

```{r,message=FALSE}
# Load library
library(tidyverse)
```

All protest data pulled from: 
Chenoweth, Erica, Soha Hammam, and Jay Ulfelder. 2024. “Crowd Counting Consortium.” Ash 
Center. https://ash.harvard.edu/programs/crowd-counting-consortium/.

## May 2020

```{r}
# Load data
may <- read.csv("May Crowd Estimates 2020 - Antiracism.csv")
```

```{r}
may <- may %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove Country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(29:46, Country, EstimateText, Actor, AdjustedLow, AdjustedHigh, 
            EventType, Location, Claim, MacroEvent, BestGuess, Pro.2..Anti.1., 
            Events, Source1, Source2, Source3, Misc., TownsCities)) %>%
  # Creating protest size column, measured in number of participants 
  # When there is an EstimateLow and no EstimateHigh, Size is EstimateLow
  # There are 3 cases where there is an EstimateLow and no EstimateHigh; no cases vice versa
  mutate(Size = ifelse(!is.na(EstimateLow) & is.na(EstimateHigh), EstimateLow, 
                       # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
                       ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                              # If EstimateLow and EstimateHigh are the same, that is the Size
                              ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                     # If Estimate Low and EstimateHigh are not the same, take the average
                                     (EstimateLow + EstimateHigh)/2), NA))) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # Correct state name inconsistencies
  mutate(StateTerritory = str_trim(StateTerritory)) %>%
  mutate(StateTerritory = case_when(
    StateTerritory == "Texas" ~ "TX",
    TRUE ~ StateTerritory)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = City.Town,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = TearGas) %>%
  # Changes a value of "unspecified" or "unclear" to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries), 
    ~ case_when(
      .x %in% c("unspecified", "unclear") ~ NA, 
      TRUE ~ .x))) %>%
  # Changes empty cells to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Corrects value error in Tear_Gas
   mutate(Tear_Gas = ifelse(Tear_Gas != "0" & Tear_Gas != "1" & !is.na(Tear_Gas), NA, Tear_Gas)) %>%
  # Change character descriptions to numbers
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas),
    ~ case_when(
      .x == "numerous" ~ "75",  
      .x == "several" ~ "25",
      .x == "many" ~ "10",
      .x == "more than 70" ~ "70",
      .x == "at least 20" ~ "20",
      .x == "at least 1" ~ "1",
      .x == "around 300" ~ "300",
      .x == "about a dozen" ~ "12",
      TRUE ~ .x))) %>%
  # Turn vector to numeric
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))

# Add column identifying the month
may$Month <- "May"
```


## June 2020

```{r}
# Load data
june <- read.csv("June Crowd Estimates 2020 - Antiracism.csv")
```

```{r}
june <- june %>%
  # Denote NAs consistently
  mutate(EstimateText = case_when(
    EstimateText == "na" ~ NA,
    TRUE ~ EstimateText)) %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove Country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(29:46, Country, EstimateText, Actor, AdjustedLow, AdjustedHigh, 
            EventType, Location, Claim, MacroEvent, BestGuess, Pro.2..Anti.1., 
            Events, Source1, Source2, Source3, Misc., TownsCities)) %>%
  # Creating protest size column, measured in number of participants 
  # When there is an EstimateLow and no EstimateHigh, Size is EstimateLow
  # Note that there is 1 case where there is an EstimateLow and no EstimateHigh, no cases vice versa
  mutate(Size = ifelse(!is.na(EstimateLow) & is.na(EstimateHigh), EstimateLow, 
                       # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
                       ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                              # If EstimateLow and EstimateHigh are the same, that is the Size
                              ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                     # If Estimate Low and EstimateHigh are not the same, take the average
                                     (EstimateLow + EstimateHigh)/2), NA))) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # States that are blank have no other values in other columns
  filter(StateTerritory != "") %>%
  # Correct state name inconsistencies
  mutate(StateTerritory = str_trim(StateTerritory)) %>%
  # Not looking at non-states beyond DC
  filter(!StateTerritory %in% c("Guam", "GU")) %>%
  mutate(StateTerritory = case_when(
    # Iowa sometimes got marked "IO"
    StateTerritory == "IO" ~ "IA",
    TRUE ~ StateTerritory)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = CityTown,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = TearGas) %>%
  # Changes a value of "unspecified" or "unclear" to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage), 
    ~ case_when(
      .x %in% c("unspecified", "unclear") ~ NA, 
      TRUE ~ .x))) %>%
  # Changes empty cells to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Corrects value errors in Tear_Gas
   mutate(Tear_Gas = ifelse(Tear_Gas != "0" & Tear_Gas != "1" & !is.na(Tear_Gas), NA, Tear_Gas)) %>%
  # Change character descriptions to numbers
 mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas),
    ~ case_when(
      .x == "numerous" ~ "20",  
      .x == "several" ~ "25",
      .x == "multiple" ~ "10",
      .x == "more than 70" ~ "70",
      .x == "at least 61" ~ "61",
      .x == "at least 1" ~ "1",
      .x == "around 300" ~ "300",
      .x == "about a dozen" ~ "12",
      .x == "nearly 200" ~ "200",
      .x == "more than a dozen" ~ "12",
      .x == "more than 90" ~ "90",
      .x == "fewer than 10" ~ "10",
      .x == "at least several" ~ "10",
      .x == "at least 263" ~ "263",
      TRUE ~ .x))) %>%
  # Turn vector to numeric
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))

# Add column identifying the month
june$Month <- "June"
```


## July 2020

```{r}
# Load data
july <- read.csv("July Crowd Estimates 2020 - Antiracism.csv")
```

```{r}
july <- july %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove Country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(29:47, Country, EstimateText, Actor, AdjustedLow, AdjustedHigh, 
            EventType, Location, Claim, MacroEvent, BestGuess, Pro.2..Anti.1., 
            Events, Source1, Source2, Source3, Misc., TownsCities)) %>%
  # Creating protest size column, measured in number of participants 
  # When there is an EstimateLow and no EstimateHigh, Size is EstimateLow
  # Note that there is 1 case where there is an EstimateLow and no EstimateHigh, no cases vice versa
  mutate(Size = ifelse(!is.na(EstimateLow) & is.na(EstimateHigh), EstimateLow, 
                       # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
                       ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                              # If EstimateLow and EstimateHigh are the same, that is the Size
                              ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                     # If Estimate Low and EstimateHigh are not the same, take the average
                                     (EstimateLow + EstimateHigh)/2), NA))) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # Correct state name inconsistencies
  mutate(StateTerritory = str_trim(StateTerritory)) %>%
  mutate(StateTerritory = case_when(
    StateTerritory == "NB" ~ "NE",
    StateTerritory == "KA" & CityTown == "El Dorado" ~ "AR",
    StateTerritory == "KA" & CityTown == "Wichita" ~ "KS",
    StateTerritory == "KA" & CityTown == "Overland Park" ~ "KS",
    TRUE ~ StateTerritory)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = CityTown,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = Tear.Gas) %>%
  # Changes a value of "unspecified" or "unclear" to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries), 
    ~ case_when(
      .x %in% c("unspecified", "unclear") ~ NA, 
      TRUE ~ .x))) %>%
  # Changes empty cells to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Corrects value error in Tear_Gas
   mutate(Tear_Gas = ifelse(Tear_Gas != "0" & Tear_Gas != "1" & !is.na(Tear_Gas), NA, Tear_Gas)) %>%
   # Change character descriptions to numbers
 mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas),
    ~ case_when(
      .x == "at least 2" ~ "2",  
      .x == "several" ~ "20",
      TRUE ~ .x))) %>%
  # Turn vector to numeric
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))

# Add column identifying month
july$Month <- "July"
```


## August

```{r}
# Load data
august <- read.csv("August Crowd Estimates 2020 - Tally.csv")
```

```{r}
august <- august %>%
  # Fixes number inconsistency
  mutate(EstimateLow = case_when(
    EstimateLow == "2,000" ~ "2000",
    TRUE ~ EstimateLow)) %>%
  mutate(EstimateHigh = case_when(
    EstimateHigh == "2,000" ~ "2000",
    TRUE ~ EstimateHigh)) %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove Country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(31:44, Country, EstimateText, AdjustedLow, AdjustedHigh, 
            EventType, Location, MacroEvent, BestGuess, 
            Events, Source2, Source3, Actor, Source1, Misc., CountLove, AdHoc, TownsCities)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = CityTown,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = TearGas) %>%
  # Changes empty cells to NA
  mutate(across(
    c(State, EstimateLow, EstimateHigh, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Changes to numeric
  mutate(EstimateLow = as.numeric(EstimateLow)) %>%
  mutate(EstimateHigh = as.numeric(EstimateHigh)) %>%
  # Creating protest size column, measured in number of participants 
  # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
  mutate(Size = ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                          # If EstimateLow and EstimateHigh are the same, that is the Size
                          ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                # If Estimate Low and EstimateHigh are not the same, take the average
                                  (EstimateLow + EstimateHigh)/2), NA)) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # Correct state name inconsistencies
  mutate(State = str_trim(State)) %>%
  mutate(State = case_when(
  State == "KA" & City_Town == "Overland Park" ~ "KS",
    TRUE ~ State)) %>%
  # Changes a value of "unspecified" or "unclear" to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries), 
    ~ case_when(
      .x %in% c("unspecified", "unclear") ~ NA, 
      TRUE ~ .x)))
```

August was not pre-sorted into BLM protests. Sorting below.

```{r}
august <- august %>%
  # All Claim text to lower case
  mutate(Claim = tolower(Claim)) %>%
  # Remove 286 pro-Trump protests, which were not BLM protests
  filter(Pro2.Anti1 != 2) %>%
  # Creates binary BLM protest variable, 1 is a BLM protest, 0 is not
  mutate(BLM = case_when(
    # Pro2.Anti1 == 1 denotes anti-Trump protest
    # Detects character strings consistent with BLM protests in the anti-Trump category
    Pro2.Anti1 == 1 & str_detect(Claim, regex("black|police|racism|racial|
                                              confederate|brutality|oppression|supremacy")) ~ 1,
    # Pro2.Anti1 == 0 denotes protests unrelated to Trump
    # Detects character strings consistent with BLM protests in the unrelated to Trump category
    Pro2.Anti1 == 0 & str_detect(Claim, regex("black|racism")) ~ 1,
    TRUE ~ 0)) %>%
    # Drops non-BLM protests
  filter(BLM == 1) %>%
  # Variables not needed anymore
  select(-c(Claim, Pro2.Anti1, BLM))

# Adds column identifying the month
august$Month <- "August"
```

```{r}
august <- august %>%
  # Change character descriptions to numbers
 mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas),
    ~ case_when(
      .x == "a few" ~ "3",  
      .x == "several" ~ "20",
      TRUE ~ .x))) %>%
  # Turn vector to numeric
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))
```


## September

```{r}
# Load data
september <- read.csv("September Crowd Estimates 2020 - Tally.csv")
```

```{r}
september <- september %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove Country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(31:44, Country, EstimateText, AdjustedLow, AdjustedHigh, 
            EventType, Location, MacroEvent, BestGuess, 
            Events, Source2, Source3, Actor, Source1, Misc., CountLove, AdHoc, TownsCities)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = CityTown,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = TearGas) %>%
  # Changes empty cells to NA
  mutate(across(
    c(State, EstimateLow, EstimateHigh, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Changes to numeric
  mutate(EstimateLow = as.numeric(EstimateLow)) %>%
  mutate(EstimateHigh = as.numeric(EstimateHigh)) %>%
  # Creating protest size column, measured in number of participants 
  # When there is an EstimateLow and no EstimateHigh, Size is EstimateLow
  # Note that there are 2 cases where there is an EstimateLow and no EstimateHigh, no cases vice versa
  mutate(Size = ifelse(!is.na(EstimateLow) & is.na(EstimateHigh), EstimateLow, 
                       # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
                       ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                              # If EstimateLow and EstimateHigh are the same, that is the Size
                              ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                     # If Estimate Low and EstimateHigh are not the same, take the average
                                     (EstimateLow + EstimateHigh)/2), NA))) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # Correct state name inconsistencies
  mutate(State = str_trim(State)) %>%
  # Changes a value of "unspecified" to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries), 
    ~ case_when(
      .x %in% c("unspecified") ~ NA, 
      TRUE ~ .x))) %>%
  # Corrects value error in Tear_Gas
   mutate(Tear_Gas = ifelse(Tear_Gas != "0" & Tear_Gas != "1" & !is.na(Tear_Gas), NA, Tear_Gas))
```

September was not pre-sorted into BLM protests. Sorting below.

```{r}
september <- september %>%
  # All Claim text to lower case
  mutate(Claim = tolower(Claim)) %>%
  # Remove 456 pro-Trump protests, which were not BLM protests
  filter(Pro.2..Anti.1. != 2) %>%
  # Creates binary BLM protest variable, 1 is a BLM protest, 0 is not
  mutate(BLM = case_when(
    # Pro.2..Anti.1. == 1 denotes anti-Trump protest
     # Detects character strings consistent with BLM protests in the anti-Trump category
    Pro.2..Anti.1. == 1 & str_detect(Claim, regex("black|police|racism|racial|
                                              confederate|brutality|oppression|supremacy")) ~ 1,
    # Pro.2..Anti.1. == 0 denotes protests unrelated to Trump
   # Detects character strings consistent with BLM protests in the unrelated to Trump category
    Pro.2..Anti.1. == 0 & str_detect(Claim, regex("black|racism|racial|conviction")) ~ 1,
    TRUE ~ 0)) %>%
    # Drops non-BLM protests
  filter(BLM == 1) %>%
  # Variables not needed anymore
  select(-c(Claim, Pro.2..Anti.1., BLM))

# Add column identifying the month
september$Month <- "September"
```

```{r}
september <- september %>%
  # Change character descriptions to numbers
 mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas),
    ~ case_when(
      .x == "some" ~ "5",  
      .x == "several" ~ "20",
      .x == "more than a dozen" ~ "15",
      .x == "at least 24" ~ "24",
      .x == "many" ~ "10",
      TRUE ~ .x))) %>%
  # Turn vector to numeric
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))
```

## October

```{r}
# Load data
october <- read.csv("October Crowd Estimates 2020 - Tally.csv")
```

```{r}
october <- october %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove Country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(26:44, Country, EstimateText, AdjustedLow, AdjustedHigh, 
            EventType, Location, MacroEvent, BestGuess, 
            Events, Actor, Misc., TownsCities)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = CityTown,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = TearGas) %>%
  # Changes empty cells to NA
  mutate(across(
    c(State, EstimateLow, EstimateHigh, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Changes to numeric
  mutate(EstimateLow = as.numeric(EstimateLow)) %>%
  mutate(EstimateHigh = as.numeric(EstimateHigh)) %>%
  # Creating protest size column, measured in number of participants 
  # When there is an EstimateLow and no EstimateHigh, Size is EstimateLow
  # Note that there are 2 cases where there is an EstimateLow and no EstimateHigh, no cases vice versa
  mutate(Size = ifelse(!is.na(EstimateLow) & is.na(EstimateHigh), EstimateLow, 
                       # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
                       ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                              # If EstimateLow and EstimateHigh are the same, that is the Size
                              ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                     # If Estimate Low and EstimateHigh are not the same, take the average
                                     (EstimateLow + EstimateHigh)/2), NA))) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # Correct state name inconsistencies
  mutate(State = str_trim(State)) %>%
  # Changes a value of "unspecified", "unclear", or "unknown" to NA
  mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage), 
    ~ case_when(
      .x %in% c("unspecified", "unclear", "unknown") ~ NA, 
      TRUE ~ .x))) %>%
  # Corrects value error in Tear_Gas
   mutate(Tear_Gas = ifelse(Tear_Gas != "1" & !is.na(Tear_Gas), NA, Tear_Gas))
```

October was not pre-sorted into BLM protests. Sorting below.

```{r}
october <- october %>%
  # All Claim text to lower case
  mutate(Claim = tolower(Claim)) %>%
  # Remove 741 pro-Trump protests, which were not BLM protests
  filter(Pro.2..Anti.1. != 2) %>%
  # Creates binary BLM protest variable, 1 is a BLM protest, 0 is not
  mutate(BLM = case_when(
    # Pro.2..Anti.1. == 1 denotes anti-Trump protest
     # Detects character strings consistent with BLM protests in the anti-Trump category
    Pro.2..Anti.1. == 1 & str_detect(Claim, regex("black|police|racism|racial|
                                              confederate|brutality|supremacy")) ~ 1,
    # Pro.2..Anti.1. == 0 denotes protests unrelated to Trump
   # Detects character strings consistent with BLM protests in the unrelated to Trump category
    Pro.2..Anti.1. == 0 & str_detect(Claim, regex("black|racism|racial|defund|brutality|warrant")) ~ 1,
    TRUE ~ 0)) %>%
    # Drops non-BLM protests
  filter(BLM == 1) %>%
  # Variables not needed anymore
  select(-c(Claim, Pro.2..Anti.1., BLM))

# Add column identifying month
october$Month <- "October"
```


```{r}
october <- october %>%
  # Change character descriptions to numbers
 mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas),
    ~ case_when(
      .x == "a few" ~ "3",  
      .x == "several" ~ "20",
      .x == "at least two" ~ "2",
      .x == "at least 2" ~ "2",
      .x == "many" ~ "10",
      TRUE ~ .x))) %>%
  # Turn vector to numeric
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))
```


## November

```{r}
# Load data
november <- read.csv("November Crowd Estimates 2020 - Tally.csv")
```

```{r}
november <- november %>%
  # Convert date to a date object
   mutate(Day = day(Date)) %>%
  # The election was 11/3/2020, only keep protests before the election
    filter(Day <= 2) %>%
  # Remove unnamed columns with no values
  # All protests are in the US, so remove country
  # Remove EstimateText, which contains raw text clips that are already summarized in other columns
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(26:45, Country, EstimateText, AdjustedLow, AdjustedHigh, 
            EventType, Location, MacroEvent, BestGuess, 
            Events, Actor, Misc., TownsCities)) %>%
  # Rename variables
  # DC is the only non-state
  rename(State = StateTerritory,
         City_Town = CityTown,
         Arrests = ReportedArrests,
         Participant_Injuries = ReportedParticipantInjuries,
         Police_Injuries = ReportedPoliceInjuries,
         Property_Damage = ReportedPropertyDamage,
         Tear_Gas = TearGas) %>%
  # Changes empty cells to NA
  mutate(across(
    c(State, EstimateLow, EstimateHigh, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas, County), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Changes to numeric
  mutate(EstimateLow = as.numeric(EstimateLow)) %>%
  mutate(EstimateHigh = as.numeric(EstimateHigh)) %>%
  # Creating protest size column, measured in number of participants 
  # If neither EstimateLow nor EstimateHigh are NA, perform the following, or else Size is NA
  mutate(Size = ifelse(!is.na(EstimateLow) & !is.na(EstimateHigh), 
                              # If EstimateLow and EstimateHigh are the same, that is the Size
                              ifelse(EstimateLow == EstimateHigh, EstimateLow, 
                                     # If Estimate Low and EstimateHigh are not the same, take the average
                                     (EstimateLow + EstimateHigh)/2), NA)) %>%
  # Columns no longer needed
  select(-c(EstimateLow, EstimateHigh)) %>%
  # Correct state name inconsistencies
  mutate(State = str_trim(State)) %>%
  # Changes a value of "unspecified" to NA
  mutate(Participant_Injuries = case_when(
    Participant_Injuries == "unspecified" ~ NA,
    TRUE ~ Participant_Injuries)) %>%
  # Corrects value error in Tear_Gas
   mutate(Tear_Gas = ifelse(Tear_Gas != "1" & !is.na(Tear_Gas), NA, Tear_Gas))
```

November was not pre-sorted into BLM protests. Sorting below.

```{r}
november <- november %>%
  # All Claim text to lower case
  mutate(Claim = tolower(Claim)) %>%
  # Remove 104 pro-Trump protests, which were not BLM protests
  filter(Pro2Anti1 != 2) %>%
  # Creates binary BLM protest variable, 1 is a BLM protest, 0 is not
  mutate(BLM = case_when(
    # Pro2Anti1. == 1 denotes anti-Trump protest
     # Detects character strings consistent with BLM protests in the anti-Trump category
    Pro2Anti1 == 1 & str_detect(Claim, regex("black|racism|racial")) ~ 1,
    # Pro2Anti1 == 0 denotes protest unrelated to Trump
   # Detects character strings consistent with BLM protests in the unrelated to Trump category
    Pro2Anti1 == 0 & str_detect(Claim, regex("black")) ~ 1,
    TRUE ~ 0)) %>%
    # Drops non-BLM protests
  filter(BLM == 1) %>%
  # Variables not needed anymore
  select(-c(Claim, Pro2Anti1, BLM))

# Add column identifying month
november$Month <- "November"
```

```{r}
# Change vectors to numeric
november <- november %>%
   mutate(across(
    c(Arrests, Participant_Injuries, Police_Injuries, Property_Damage, Tear_Gas), as.numeric))
```

```{r}
# Row bind all protest months into one dataset
protests <- rbind(may, june, july, august, september, october, november)
```

```{r}
# For data that does not need a helper merge dataset
# Local offices

protests1 <- protests %>%
  # Set to lowercase
  mutate(County = tolower(County)) %>%
  mutate(City_Town = tolower(City_Town)) %>%
  # Remove county label
  mutate(County = gsub("county", "", County)) %>%
  # Remove Date and Month
  select(-c(Date, Month))
```

```{r}
# For data that needs a helper merge dataset
# State and federal offices

protests3 <- protests %>%
  # Set to lowercase
  mutate(County = tolower(County)) %>%
  # Remove county label
  mutate(County = gsub("county", "", County)) %>%
  # Remove City_Town, Date, and Month
  select(-c(City_Town, Date, Month))
```

```{r}
# For data that does not need a helper merge dataset
# Local offices identified by county

final_protests1 <- protests1 %>%
  # Group by county
  group_by(County) %>%
  # Create frequency variable that computes the number of protests in that county
  mutate(Frequency = n()) %>%
  # Create more metric variables by adding the total counts in that county
  mutate(across(c(Size, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per county
  distinct(County, .keep_all = TRUE)
```

```{r}
# For data that does not need a helper merge dataset
# Local offices identified by city or town

final_protests2 <- protests1 %>%
  # Group by city/town
  group_by(City_Town) %>%
  # Create frequency variable that computes the number of protests in that county
  mutate(Frequency = n()) %>%
  # Create more metric variables by adding the total counts in that county
  mutate(across(c(Size, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per city/town
  distinct(City_Town, .keep_all = TRUE)
```

```{r}
# For data that needs a helper merge dataset
# State and federal offices

final_protests3 <- protests3 %>%
   # Group by county
  group_by(County) %>%
   # Create frequency variable that computes the number of protests in that county
  mutate(Frequency = n()) %>%
  # Create more metric variables by adding the total counts in that county
  mutate(across(c(Size, Arrests, Participant_Injuries, 
      Police_Injuries, Property_Damage, Tear_Gas), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per county
  distinct(County, .keep_all = TRUE)
```


```{r}
# Read in dataset
# Maps FIPS to congressional districts
hun_six <- read.csv("DOA_csv/Crosswalk_2010_116.csv")

# Create named vector to reassign spelled-out states to abbreviations
state_mapping <- c(
  "Alabama" = "AL", "Alaska" = "AK", "Arizona" = "AZ", "Arkansas" = "AR", 
  "California" = "CA", "Colorado" = "CO", "Connecticut" = "CT", "Delaware" = "DE",
  "Florida" = "FL", "Georgia" = "GA", "Hawaii" = "HI", "Idaho" = "ID",
  "Illinois" = "IL", "Indiana" = "IN", "Iowa" = "IA", "Kansas" = "KS",
  "Kentucky" = "KY", "Louisiana" = "LA", "Maine" = "ME", "Maryland" = "MD",
  "Massachusetts" = "MA", "Michigan" = "MI", "Minnesota" = "MN", "Mississippi" = "MS",
  "Missouri" = "MO", "Montana" = "MT", "Nebraska" = "NE", "Nevada" = "NV",
  "New Hampshire" = "NH", "New Jersey" = "NJ", "New Mexico" = "NM", "New York" = "NY",
  "North Carolina" = "NC", "North Dakota" = "ND", "Ohio" = "OH", "Oklahoma" = "OK",
  "Oregon" = "OR", "Pennsylvania" = "PA", "Rhode Island" = "RI", "South Carolina" = "SC",
  "South Dakota" = "SD", "Tennessee" = "TN", "Texas" = "TX", "Utah" = "UT",
  "Vermont" = "VT", "Virginia" = "VA", "Washington" = "WA", "West Virginia" = "WV",
  "Wisconsin" = "WI", "Wyoming" = "WY")

hun_six <- hun_six %>%
  # Index at new state names
  mutate(cd_state = state_mapping[cd_state]) %>%
  # Label all districts with their states so they are distinct
  rename(County = nhgisnam,
         State = cd_state) %>%
  # Set to lowercase
  mutate(County = tolower(County)) %>%
  # Grab relevant columns
  select(County, State, district) %>%
  # Remove district not in scope
  filter(district != 98) %>%
  # Label districts with their states so they are distinguishable
  mutate(district = paste(State, district, sep = "_"))
```

```{r}
# Merge datasets to create a protest dataset ready to merge with candidate datasets and into BISG
protest_district <- left_join(final_protests3, hun_six, by = c("County", "State"))
```

