---
title: "Cleaning Protest Data"
author: "Julianne Lempert"
---

```{r,message=FALSE}
# Load library
library(tidyverse)
```

Protest data: 
Chenoweth, Erica, Soha Hammam, and Jay Ulfelder. 2024. “Crowd Counting Consortium.” Ash 
Center. https://ash.harvard.edu/programs/crowd-counting-consortium/.

```{r}
# Load data
protests <- read.csv("ccc-antiracism-2020.csv")
```

```{r}
protests <- protests %>%
  # Remove columns irrelevant/unhelpful to analysis or containing values that I don't differentiate among
  # BLM vigils/memorials included as protests
  select(-c(1:18, size_cat, 30:66)) %>%
  # Rename variables
  rename(size = size_mean,
         state = resolved_state,
         locality = resolved_locality,
         county = resolved_county,
         fips = fips_code) %>%
  # Remove leading state fips code
  mutate(fips = str_sub(fips, -3)) %>%
    # Remove county label
  mutate(county = gsub("County", "", county)) %>%
    # String trim values
  mutate(across(
    c(arrests, arrests_any, injuries_crowd, injuries_crowd_any, injuries_police, injuries_police_any, property_damage, property_damage_any, chemical_agents, locality, county, state), ~ str_trim(.x))) %>%
    # Change empty cells to NA
  mutate(across(
    c(locality, county, state), 
    ~ na_if(.x, ""))) %>%
  # Change a value of "unspecified", "unclear", or "unknown" to zero
  mutate(across(
    c(arrests, injuries_crowd, injuries_police, property_damage, chemical_agents), ~ case_when(.x %in% c("unspecified", "unclear", "unknown") ~ "0", 
      TRUE ~ .x))) %>%
  # Turn NAs to zero
  mutate(across(
    c(arrests, injuries_crowd, injuries_police, property_damage, chemical_agents), ~ case_when(is.na(.x) ~ "0", 
      TRUE ~ .x))) %>%
   # Turn empty cells to zero
  mutate(across(
    c(arrests, injuries_police), ~ case_when(.x == "" ~ "0", 
      TRUE ~ .x))) %>%
  # If binary "any" columns say 0, mark the metric column with 0
 mutate(arrests = ifelse(arrests_any == 0, "0", arrests),
        injuries_crowd = ifelse(injuries_crowd_any == 0, "0", injuries_crowd),
        injuries_police = ifelse(injuries_police_any == 0, "0", injuries_police),
        property_damage = ifelse(property_damage_any == 0, "0", property_damage)) %>%
  # Binary columns no longer needed
  select(-c(arrests_any, injuries_crowd_any, injuries_police_any, property_damage_any)) %>%
  # Change character descriptions to numbers
   mutate(arrests = case_when(
      arrests == "at least 1" ~ "1",
      arrests == "at least 20" ~ "20",
      arrests %in% c("about a dozen", "more than a dozen")  ~ "12",
      arrests == "around 300" ~ "300",
      arrests == "more than 70" ~ "70",
      arrests == "nearly 200" ~ "200",
      arrests == "more than 90" ~ "90",
      arrests == "at least 263" ~ "263",
      arrests =="fewer than 10" ~ "10",
      arrests %in% c("at least two", "at least 2" )  ~ "2",
      arrests == "at least 24" ~ "24",
      arrests %in% c("numerous", "many", "several", "at least several")  ~ "10", # Arbitrary stand-in value of 10 chosen; represents 17 cases total
      arrests %in% c("a few","some") ~ "3", # Assumed; represents 2 cases total
      TRUE ~ arrests)) %>%
  mutate(injuries_crowd = case_when(
    injuries_crowd == "at least 61" ~ "61",
    injuries_crowd == "at least 2" ~ "2",
    # Arbitrary stand-in value of 10 chosen; represents 8 cases total
    injuries_crowd %in% c("many", "several")  ~ "10", 
    TRUE ~ injuries_crowd)) %>%
  mutate(injuries_police = case_when(
    # Arbitrary stand-in value of 10 chosen; represents 5 cases total
    injuries_police %in% c("multiple", "numerous", "many", "several")  ~ "10", 
    TRUE ~ injuries_police)) %>%
   # Convert metrics to numeric
   mutate(across(
    c(arrests, injuries_crowd, injuries_police, property_damage, chemical_agents), as.numeric)) %>%
  # Correct location error
  mutate(locality = ifelse(locality == "Noviny", "Troy", locality),
         county = ifelse(county == "Niasvizh District", "Oakland", county),
         state = ifelse(state == "Minsk Region", "MI", state)) %>%
  # Set to lowercase
  mutate(county = tolower(county)) %>%
  mutate(locality = tolower(locality)) %>%
  # If there is no specific city/town value, assign the county name as the city/town name
  mutate(locality = ifelse(is.na(locality), county, locality)) %>%
  # If there is no specific county value, assign the city/town name as the county name
  mutate(county = ifelse(is.na(county), locality, county)) %>%
  # Remove rows with no county, locality, or state value
  # Note that there are 9 cases of no county or locality value, but a state value
  filter(!is.na(county) & !is.na(locality) & !is.na(state)) %>%
  # Fill in missing fips value for Oakland County, Michigan
  mutate(fips = ifelse(county == "oakland" & state == "MI", "125", fips))
```

County-level protests:
Local offices (no helper merger dataset)
State and federal offices (needs a helper merger dataset, creation below)

```{r}
county_protests <- protests %>%
  # Remove city/town column
  select(-locality) %>%
  # Group by county
  group_by(county) %>%
  # Create frequency variable that computes the number of protests in that county
  mutate(frequency = n()) %>%
  # Create metric variables by adding the total counts in that county
  mutate(across(c(size, arrests, injuries_crowd, 
      injuries_police, property_damage, chemical_agents), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per county
  distinct(county, .keep_all = TRUE)
```

City/Town-level protests:
Local offices (no helper merger dataset)

```{r}
city_protests <- protests %>%
  # Group by city/town
  group_by(locality) %>%
  # Create frequency variable that computes the number of protests in that city/town
  mutate(frequency = n()) %>%
  # Create metric variables by adding the total counts in that city/town
  mutate(across(c(size, arrests, injuries_crowd, 
      injuries_police, property_damage, chemical_agents), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per city/town
  distinct(locality, .keep_all = TRUE)
```

State protests:
Senate and governors

```{r}
state_protests <- protests %>%
  # Group by city/town
  group_by(state) %>%
  # Create frequency variable that computes the number of protests in that city/town
  mutate(frequency = n()) %>%
  # Create metric variables by adding the total counts in that city/town
  mutate(across(c(size, arrests, injuries_crowd, 
      injuries_police, property_damage, chemical_agents), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per city/town
 distinct(state, .keep_all = TRUE)
```

FIPS-district dataset citation:
Ferrara, Andreas, Patrick A. Testa, and Liyang Zhou. 2022. “New Area- and Population-Based
Geographic Crosswalks for U.S. Counties and Congressional Districts, 1790-2020.”
doi:10.3886/E150101V4.

```{r}
# Read in dataset
# Maps FIPS to congressional districts (116th Congress)
hun_six <- read.csv("DOA_csv/Crosswalk_2010_116.csv")

# Create named vector to reassign spelled-out states to abbreviations
state_mapping <- c(
  "Alabama" = "AL", "Alaska" = "AK", "Arizona" = "AZ", "Arkansas" = "AR", 
  "California" = "CA", "Colorado" = "CO", "Connecticut" = "CT", "Delaware" = "DE",
  "Florida" = "FL", "Georgia" = "GA", "Hawaii" = "HI", "Idaho" = "ID",
  "Illinois" = "IL", "Indiana" = "IN", "Iowa" = "IA", "Kansas" = "KS",
  "Kentucky" = "KY", "Louisiana" = "LA", "Maine" = "ME", "Maryland" = "MD",
  "Massachusetts" = "MA", "Michigan" = "MI", "Minnesota" = "MN", "Mississippi" = "MS",
  "Missouri" = "MO", "Montana" = "MT", "Nebraska" = "NE", "Nevada" = "NV",
  "New Hampshire" = "NH", "New Jersey" = "NJ", "New Mexico" = "NM", "New York" = "NY",
  "North Carolina" = "NC", "North Dakota" = "ND", "Ohio" = "OH", "Oklahoma" = "OK",
  "Oregon" = "OR", "Pennsylvania" = "PA", "Rhode Island" = "RI", "South Carolina" = "SC",
  "South Dakota" = "SD", "Tennessee" = "TN", "Texas" = "TX", "Utah" = "UT",
  "Vermont" = "VT", "Virginia" = "VA", "Washington" = "WA", "West Virginia" = "WV",
  "Wisconsin" = "WI", "Wyoming" = "WY")

hun_six <- hun_six %>%
  # Index at new state names
  mutate(cd_state = state_mapping[cd_state]) %>%
  # Label all districts with their states so they are distinct
  rename(county = nhgisnam,
         state = cd_state) %>%
  # Set to lowercase
  mutate(county = tolower(county)) %>%
  # Grab relevant columns
  select(county, state, district) %>%
  # Remove district not in scope
  filter(district != 98) %>%
  # Label districts with their states so they are distinguishable
  mutate(district = paste(state, district, sep = "_"))
```

```{r}
# Merge datasets to create a protest-district dataset ready to merge with candidate datasets and into BISG
protest_district <- left_join(county_protests, hun_six, by = c("county", "state"))

protest_district <- protest_district %>%
  # Group by district
  group_by(district) %>%
  # Create frequency variable that computes the number of protests in that district
  mutate(frequency = n()) %>%
  # Create metric variables by adding the total counts in that district
  mutate(across(c(size, arrests, injuries_crowd, 
      injuries_police, property_damage, chemical_agents), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per district
  distinct(district, .keep_all = TRUE)
```

State legislatures districts protest data

```{r}
# Merging with dataset with state legislature districts & fips & state from sleg dataset
protest_state_districts <- left_join(protests, state_district_fips, by = c("state", "fips"))

protest_state_districts <- protest_state_districts %>%
   # Group by district
  group_by(dno) %>%
  # Create frequency variable that computes the number of protests in that district
  mutate(frequency = n()) %>%
  # Create metric variables by adding the total counts in that district
  mutate(across(c(size, arrests, injuries_crowd, 
      injuries_police, property_damage, chemical_agents), 
      ~ sum(.x, na.rm = TRUE))) %>%
  # Only keep one row per district
  distinct(dno, .keep_all = TRUE)
```
