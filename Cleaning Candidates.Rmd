---
title: "Cleaning Candidates (Kaggle)"
author: "Julianne Lempert"
date: "`r Sys.Date()`"
output: html_document
---

```{r,message=FALSE}
# Load libraries
library(tidyverse)
library(knitr)
library(wru)
```

## Cleaning Local Candidates

Dataset citation:
De Benedictis-Kessner, Justin, Diana Lee, Yamil Velez, and Christopher Warshaw. 2023. 
“American Local Government Elections Database.” doi: 10.17605/OSF.IO/MV5E6.

```{r}
# Read in local office data
locals <- read.csv("locals.csv")
```

```{r}
locals <- locals %>%
  # Subset to relevant years
  filter(year >= 2010) %>%
  mutate(race_est = case_when(
    # Race is included in this dataset
    # Set race options to Black, white, or other
    race_est %in% c("asian", "other", "hispanic") ~ "other",
    race_est == "caucasian" ~ "white",
    TRUE ~ race_est)) %>%
  # Get rid of irrelevant columns
  select(-c(votes, vote_share, contributor.cfscore, bonica.cid, prob_democrat, prob_republican, prob_female, prob_male, prob_black, prob_white, prob_hispanic, prob_asian, prob_other, ballotpedia_url)) %>%
    # Rename variables
 rename(office = office_consolidated, gender = gender_est,race = race_est, party = pid_est, location = geo_name, last_name = lastname, first_name = firstname, cand_id = ledb_candid, state = state_abb) %>%
  # Fixes duplicate naming of states
  mutate(state = case_when(
    state == "Maryland" ~ "MD",
    state == "Utah" ~ "UT",
    TRUE ~ state)) %>%
  # Removes unnamed candidate
  filter(first_name != "scattering")
```

```{r}
locals <- locals %>%
  # Turn text in fips to lowercase
  mutate(fips = tolower(fips)) %>%
  # Fips text explicitly mentioning county
  mutate(location = case_when(
    fips == "mo-st. louis county" ~ "st. louis",
    fips == "md-baltimore county" ~ "baltimore",
    fips == "tx-kenedy & kleberg counties" ~ "kleberg",
    TRUE ~ location)) %>%
  # Provide fips for counties with just text
   mutate(fips = case_when(
    fips == "mo-st. louis county" ~ "29189",
    fips == "md-baltimore county" ~ "24005",
    fips == "tx-kenedy & kleberg counties" ~ "48273",
    TRUE ~ fips)) %>%
  # Create a fips_type variable
  mutate(fips_type = case_when(
     grepl("-", fips) ~ "other",
    # 5-digit fips or location names with county denote county, except if there's a dash
      nchar(fips) == 5 ~ "county",  
    # 7-digit fips denotes place, except if there's dash
      nchar(fips) == 7 ~ "place",
      TRUE ~ "other")) %>%
    # Remove white space
  mutate(location = str_trim(location)) %>%
  # Set to lowercase
  mutate(location = tolower(location)) %>%
  # Remove county label
  mutate(location = gsub("county", "", location))

# Manual location fixes
locals <- locals %>%
  mutate(location = case_when(
    fips == "mo-st. louis city" ~ "st. louis",
    fips == "md-baltimore city" ~ "baltimore",
    fips == "va-virginia beach city" ~ "virginia beach",
    fips == "va-richmond city" ~ "richmond",
    fips == "va-norfolk city" ~ "norfolk",
    fips == "nv-reno city" ~ "reno",
    fips == "va-chesapeake city" ~ "chesapeake",
    fips == "va-alexandria city" ~ "alexandria",
    fips == "va-newport news city" ~ "newport news",
    fips == "va-hampton city" ~ "hampton",
    fips == "va-suffolk city" ~ "suffolk",
    fips == "va-portsmouth city" ~ "portsmouth",
    fips == "va-roanoke city" ~ "roanoke",
    fips == "va-charlottesville city" ~ "charlottesville",
    fips == "va-lynchburg city" ~ "lynchburg",
    fips == "va-danville city" ~ "danville",
    fips == "va-petersburg city" ~ "petersburg",
    fips == "va-salem city" ~ "salem",
    fips == "va-staunton city" ~ "staunton",
    fips == "va-winchester city" ~ "winchester",
    fips == "va-fredericksburg city" ~ "fredericksburg",
    fips == "va-hopewell city" ~ "hopewell",
    fips == "va-waynesboro city" ~ "waynesboro",
    fips == "va-colonial heights city" ~ "colonial heights",
    fips == "va-bristol city" ~ "bristol",
    fips == "va-radford city" ~ "radford",
    fips == "va-martinsville city" ~ "martinsville",
    fips == "va-buena vista city" ~ "buena vista",
  fips == "nv-clark" ~ "clark",
  fips == "ga-atlanta" ~ "atlanta",
  fips == "ga-stone mountain" ~ "stone mountain",
  fips == "ga-coweta" ~ "coweta",
  fips == "nv-washoe" ~ "washoe",
  fips == "ga-blue ridge" ~ "blue ridge",
  fips == "ga-augusta" ~ "augusta",
  fips == "ga-bell-forsyth" ~ "bell-forsyth",
  fips == "ga-chattahoochee" ~ "chattahoochee",
  fips == "ga-griffin" ~ "griffin",
  fips == "ga-eastern" ~ "eastern",
  fips == "ga-piedmont" ~ "piedmont",
  fips == "ga-Ssouthern" ~ "southern",
  fips == "ga-macon" ~ "macon",
  fips == "ga-lookout mountain" ~ "lookout mountain",
  fips == "ga-ocmulgee" ~ "ocmulgee",
  fips == "MA-Northwestern" ~ "northwestern",
  fips == "ga-alcovy" ~ "alcovy",
  fips == "ga-cherokee" ~ "cherokee",
  fips == "ga-brunswick" ~ "brunswick",
  fips == "ga-ogeechee" ~ "ogeechee",
  fips == "ga-western" ~ "western",
  fips == "ga-appalachian" ~ "appalachian",
  fips == "ga-northern" ~ "northern",
  fips == "ga-conasauga" ~ "conasauga",
  fips == "ga-mountain" ~ "mountain",
  fips == "ga-middle" ~ "middle",
  fips == "ga-southwestern" ~ "southwestern",
  fips == "ga-towaliga" ~ "towaliga",
  fips == "ga-tallapoosa" ~ "tallapoosa",
  fips == "ga-tifton" ~ "tifton",
  fips == "wi-st. croix" ~ "st. croix",
  fips == "ga-south georgia" ~ "south georgia",
  fips == "ga-rome" ~ "rome",
  fips == "ga-dublin" ~ "dublin",
  fips == "ga-enotah" ~ "enotah",
  fips == "ga-oconee" ~ "oconee",
  fips == "nv-douglas" ~ "douglas",
  fips == "ga-alapaha" ~ "alapaha",
  fips == "ga-toombs" ~ "toombs",
  fips == "ga-atlantic" ~ "atlantic",
  fips == "nv-lyon" ~ "lyon",
  fips == "wi-menominee and shawano" ~ "shawano",
  fips == "nv-elko" ~ "elko",
  fips == "nv-nye" ~ "nye",
  fips == "nv-churchill" ~ "churchill",
  fips == "mn-lesueur" ~ "lesueur",
  fips == "il-dewitt" ~ "dewitt",
  fips == "nv-humboldt" ~ "humboldt",
  fips == "nv-white pine" ~ "white pine",
  fips == "mn-lac qui parle" ~ "lac qui parle",
  fips == "nv-storey" ~ "storey",
  fips == "nv-lander" ~ "lander",
  fips == "nv-lincoln" ~ "lincoln",
  fips == "nv-pershing" ~ "pershing",
  fips == "nv-mineral" ~ "mineral",
  fips == "ga-pataula" ~ "pataula",
  fips == "nv-eureka" ~ "eureka",
  fips == "nv-esmeralda" ~ "esmeralda",
  TRUE ~ location))

# Manual fixes to fips_type
locals <- locals %>%
  mutate(fips_type = case_when(
    fips %in% c(
      "mo-st. louis city", "md-baltimore city", "va-virginia beach city", 
      "va-richmond city", "va-norfolk city", "nv-reno city", 
      "va-chesapeake city", "va-alexandria city", "va-newport news city", 
      "va-hampton city", "va-suffolk city", "va-portsmouth city", 
      "va-roanoke city", "va-charlottesville city", "va-lynchburg city", 
      "va-danville city", "va-petersburg city", "va-salem city", 
      "va-staunton city", "va-winchester city", "va-fredericksburg city", 
      "va-hopewell city", "va-waynesboro city", "va-colonial heights city", 
      "va-bristol city", "va-radford city", "va-martinsville city", 
      "va-buena vista city", "nv-clark", "ga-atlanta", "ga-stone mountain", 
      "ga-coweta", "nv-washoe", "ga-blue ridge", "ga-augusta", 
      "ga-bell-forsyth", "ga-chattahoochee", "ga-griffin", "ga-eastern", 
      "ga-piedmont", "ga-Ssouthern", "ga-macon", "ga-lookout mountain", 
      "ga-ocmulgee", "ma-northwestern", "ga-alcovy", "ga-cherokee", 
      "ga-brunswick", "ga-ogeechee", "ga-western", "ga-appalachian", 
      "ga-northern", "ga-conasauga", "ga-mountain", "ga-middle", 
      "ga-southwestern", "ga-towaliga", "ga-tallapoosa", "ga-tifton", 
      "wi-st. croix", "ga-south georgia", "ga-rome", "ga-dublin", 
      "ga-enotah", "ga-oconee", "nv-douglas", "ga-alapaha", "ga-toombs", 
      "ga-atlantic", "nv-lyon", "wi-menominee and shawano", "nv-elko", 
      "nv-nye", "nv-churchill", "mn-lesueur", "il-dewitt", "nv-humboldt", 
      "nv-white pine", "mn-lac qui parle", "nv-storey", "nv-lander", 
      "nv-lincoln", "nv-pershing", "nv-mineral", "ga-pataula", 
      "nv-eureka", "nv-esmeralda", "ms-dutchess", "ga-dutchess", "va-dutchess") ~ "place",
    TRUE ~ fips_type))

# Separate into two datasets for county fips and place fips
county_fips <- locals %>%
  filter(fips_type == "county")
place_fips <- locals %>%
  filter(fips_type == "place")

county_fips <- county_fips %>%
  # Variable no longer needed
  select(-fips_type) %>%
  # Remove missing fips
  filter(!is.na(fips)) %>%
  # Rename variables
  rename(county = location) %>%
  # Remove state fips from string
  mutate(fips = substr(fips, 3, 5))

place_fips <- place_fips %>%
  # Variable no longer needed
  select(-fips_type) %>%
  # Remove unified and city label
  mutate(location = gsub("unified", "", location)) %>%
  mutate(location = gsub("city", "", location)) %>%
  # Remove white space
  mutate(location = str_trim(location)) %>%
  # Remove missing locations
  filter(!is.na(location)) %>%
  # Rename variables
  rename(locality = location)
```

## Cleaning State Legislatures

Dataset citation:
Klarner, Carl. 2022. “State Legislative Election Returns, 1967-2022.” 
doi:10.7910/DVN/3WZFK9.

Note: Full dataset generously provided by Professor Klarner. Please see his website for access: https://www.klarnerpolitics.org/data-for-sale.

```{r}
# Read in state legislature data
sleg <- read.csv("sleg.csv")
```

```{r}
sleg <- sleg %>%
  # Filter to relevant years
  filter(year >= 2010) %>%
  # Remove meaningless counties
  filter(cname != "emergencyutilityworkers" & cname != "stateuocava") %>%
# Removing irrelevant variables
  select(-c(uncert, day, sid, mmdpost, dseats, popnum, nest, nest1, nest2, nest3, eseats, term, termz, partytsource, hold, hold1, hold2, tenure1, tenure2, limit, middle2, nick, namenum, last1, last2, last3, last3, ltype1, ltype2, ltype3, ltype4, lastb, firstb, middleb, middle2b, nickb, suffixb, last1b, last2b, ltype1b, ltype2b, namebsource, v38, v39, nonlasto, middle2o, nicko, nonlasto,suffix, prefix, sicpsr, ddez, specpost, redist, redist1, redist2, redist3, regime, flot, flot1, flot2, flot3, deter, cando, candformat, partyo, party, firstcase, v56, v57, v58, v18_20171211, v19_20171211, v19_20160217, candid20190807, candid20210504, candid20210504, cand20210504,cand20190807, candpartyo, lasto, firsto, middleo, suffixo, last4, vote, cand, partyt, prior1, prior2, geopost, dtype)) %>%
# Renaming variables 
   rename(state = sab, state_fips = sfips, senate = sen, election_type = etype, party = partyz, last_name = last, first_name = first, middle_name = middle, cand_id = candid, case_id = caseid, incumbency = exper) %>%
   # Removing 1 withdrawal case
 filter(outcome != "withdrew") %>%
  # Assigning clearer values
  mutate(outcome = case_when(
    outcome == "w" ~ "won",
    # Candidates who lost in a runoff are marked as lost
    outcome == "r" ~ "lost",
    outcome == "l" ~ "lost",
    outcome == "t" ~ "tie")) %>%
  # Geraldo Alicea and Peter Durant came to an exact tie, then Durant won in a special election
  mutate(outcome = ifelse(last_name == "alicea" & outcome == "tie", "lost", outcome)) %>%
  mutate(outcome = ifelse(last_name == "durant" & outcome == "tie", "won", outcome)) %>%
   # Denotes write-in/scattering, so remove
  filter(party != "w") %>%
  # Assigning clearer values
  mutate(party = case_when(
    party == "d" ~ "democrat",
    party == "r" ~ "republican",
    # denotes non-major party
    party == "nm" ~ "other",
    # Fused Democrat and Republican, when votes for the two parties aren't separately reported on the ballot
    party == "b" ~ "fused",
    party == "np" ~ "non-partisan election")) %>%
  mutate(election_type = case_when(
    election_type == "g" ~ "general",
    election_type %in% c("s", "gs", "ssg", "nps") ~ "special",
    election_type %in% c("ttp", "dp", "rp", "upf", "7thindepp", "amerindepp", "conservativep", "constamerindepp", "constp", "greenp", "indepamerp", "indepp", "indepp1", "indepp2", "indeppartyofdelp", "liberp", "libertyunionp", "mountainp", "petitioningcandp", "progp", "workp", "amerpfsettled", "dpfsettled", "dpfunsettled", "indeppfsettled", "liberpfsettled", "rpfsettled", "rpfunsettled", "thegreenpfsettled", "unapfsettled", "dpsgf", "dpsf") ~ "primary",
    election_type %in% c("runoff", "lasrunoff", "larunoff", "dprunoff", "dpsgrunoff", "dpsrunoff", "grunoff", "rprunoff", "srunoff", "dpfsettled", "sfunsettled", "srunoff", "lafsettled", "lafunsettled", "lasf") ~ "runoff")) %>%
   mutate(incumbency = case_when(
    incumbency == "inc" ~ "incumbent",
    incumbency == "sinc" ~ "incumbent",
    TRUE ~ "challenger")) %>%
  # Changes empty cells to NA
  mutate(across(
    c(first_name, middle_name, cname, cfips), 
    ~ na_if(str_trim(.x), ""))) %>%
  # Label all districts with their states so they are distinct
   mutate(dno = paste(state, dno, sep = "_")) %>%
  # Put leading zeros as needed for county fips
  mutate(cfips = ifelse(
    is.na(cfips), NA, 
    sprintf("%03d", as.integer(cfips))))
```

```{r}
sleg <- sleg %>%
  # Group by district number
  group_by(dno) %>%
  # Create a variable that has all cfips within that district pasted together
  mutate(all_counties = ifelse(!is.na(cfips), paste(unique(cfips[!is.na(cfips)]), collapse = "_"), NA)) %>%
  # Ensure rows with that dno with a missing cfips get the all_counties value
  fill(all_counties, .direction = "downup") %>%
  # Ungroup districts
  ungroup()

expanded_rows <- sleg %>%
  # Filter to rows with missing cfips
  filter(is.na(cfips)) %>% 
  # Separate all_counties values into separate rows for each value
  separate_rows(all_counties, sep = "_") %>% # 
  mutate(cfips = all_counties) %>% # Assign each split value to cfips
  select(-all_counties) # Optionally remove all_counties if it's no longer needed

# Step 3: Combine expanded rows with the original dataset
sleg <- sleg %>%
  filter(!is.na(cfips)) %>% # Keep only rows with existing cfips
  bind_rows(expanded_rows) %>%# Add the expanded rows 
  select(-all_counties)
```

```{r}
# Create matching datasest for protest data
state_district_fips <- sleg %>%
  # Create dataset of fips, district number, and state
  select(cfips, dno, state) %>%
  # Remove redundant matches
  distinct() %>%
  # Rename variable
  rename(fips = cfips)
```

## Cleaning House of Representatives Candidates (General)

Dataset citation:
MIT Election Data And Science Lab. 2017. “U.S. House 1976–2022.
doi:10.7910/DVN/IG0UN2.

```{r}
# Read in house data
house_generals <- read.csv("house_generals through 2022.csv")
```

```{r}
house_generals <- house_generals %>%
# Subset to relevant years
  filter(year >= 2010) %>%
# Remove irrelevant variables or columns with only one value
  select(-c(state, state_cen, state_ic, writein, unofficial, version, office, stage, 
            special, mode, fusion_ticket, runoff, state_fips)) %>%
# Remove write-ins because BISG is not possible
  filter(candidate != "WRITEIN") %>%
# Any party besides Democrat or Republican gets called Other
    mutate(party = case_when(
    str_detect(party, "DEMOCRAT") ~ "DEMOCRAT",
    str_detect(party, "REPUBLICAN") ~ "REPUBLICAN",
    TRUE ~ "OTHER")) %>%
# Rename variables
  rename(state = state_po, candidate_votes = candidatevotes, total_votes = totalvotes) %>%
# Filter to only the 50 states
   filter(state != "DC") %>%
# Remove the word in quotes along with the quotes
  mutate(candidate = gsub(' ".*?" ', ' ', candidate)) %>%
  
# Separates candidate names for future BISG analysis
separate(candidate, into = c("first_name", "middle_name", "last_name", "suffix"), 
         sep = " ", extra = "merge", fill = "right")

# If nothing was put in last_name, the second name was the last name
# so move middle_name value to last_name
house_generals$last_name <- 
  ifelse(is.na(house_generals$last_name), house_generals$middle_name, 
         house_generals$last_name)

# Fill middle_name with NA if middle_name value got moved to last_name
house_generals$middle_name <-
  ifelse(house_generals$middle_name == house_generals$last_name, NA, 
         house_generals$middle_name)

# Remove any real suffix and other punctuation
house_generals <- house_generals %>%
  mutate(suffix = ifelse(suffix %in% c("JR", "SR", "II", "III", "IV"), NA, suffix)) %>%
  mutate(middle_name = ifelse(grepl('[\"“”]', middle_name), NA, middle_name)) %>%
  mutate(last_name = ifelse(grepl('[\"“”]', last_name), NA, last_name)) %>%
  mutate(first_name = gsub('[\"“”]', '', first_name))

# If last name is a suffix, the middle name was the last name
# so move middle name value to last name
house_generals$last_name <- 
  ifelse(house_generals$last_name %in% c("JR", "SR", "II", "III", "IV"), 
         house_generals$middle_name, house_generals$last_name)

# Fill middle name with NA if middle name value got moved to last name
house_generals$middle_name <-
  ifelse(house_generals$middle_name == house_generals$last_name, NA, 
         house_generals$middle_name)

house_generals <- house_generals %>%
  # Remove unnamed candidates
  filter(!first_name %in% c("OTHER", "BLANK", "VOID", "OVER", "UNDERVOTES", "OVERVOTES",
                            "VOTEFOREDDIECOM", "BLANKS", "ALL", "OTHERS", "SCATTERING",
                            "SCATTER", "PRO-LIFE", "WRITE-IN", "MISCELLANEOUS", "WORKING",
                            "INDEPENDENT", "EXHAUSTED", "MODERATE"))
```

```{r}
# Manual name fixes, according to Ballotpedia

house_generals <- house_generals %>%
 mutate(last_name = case_when(
    first_name == "EDWARD" & middle_name == "A" & is.na(last_name) 
    & suffix == "MAIDMENT" ~ "MAIDMENT",
    first_name == "GEOFFREY" & middle_name == "M" & is.na(last_name) 
    & suffix == "YOUNG" ~ "YOUNG",
    first_name == "WILLIAM" & middle_name == "F" & is.na(last_name) 
    & suffix == "POWERS" ~ "POWERS",
    first_name == "JAMES" & middle_name == "G" & is.na(last_name) 
    & suffix == "MYLES" ~ "MYLES",
    first_name == "ROBERT" & middle_name == "C" & is.na(last_name) 
    & suffix == "SCOTT" ~ "SCOTT",
    first_name == "HERBERT" & middle_name == "C" & is.na(last_name) 
    & suffix == "JONES, JR" ~ "JONES",
    first_name == "CHARLES" & middle_name == "J" & is.na(last_name) 
    & suffix == "FLEISCHMANN" ~ "FLEISCHMANN",
    first_name == "MAX" & middle_name == "H" & last_name == "DELLA" 
    & suffix == "PIA" ~ "DELLA PIA",
    first_name == "GEORGE" & middle_name == "A" & last_name == "D" 
    & suffix == "SANTOS" ~ "SANTOS",
    first_name == "JESÚS" & middle_name == "G" & is.na(last_name) 
    & suffix == "GARCÍA" ~ "GARCÍA",
    first_name == "HENRY" & middle_name == "C" & is.na(last_name) 
    & suffix == "JOHNSON, JR" ~ "JOHNSON",
    first_name == "EARL" & middle_name == "L" & is.na(last_name) 
    & suffix == "CARTER" ~ "CARTER",
    first_name == "THEODORE" & is.na(middle_name) & is.na(last_name) 
    & suffix == "MURRAY" ~ "MURRAY",
    first_name == "G" & is.na(middle_name) & last_name == "A" ~ "PUDLO",
    first_name == "MICHAEL" & middle_name == "J" & is.na(last_name) 
    & suffix == "BARKLEY" ~ "BARKLEY",
    first_name == "ERIC" & middle_name == "A" & is.na(last_name) 
    & suffix == "CRAWFORD" ~ "CRAWFORD",
    first_name == "DEBRA" & middle_name == "JO" & is.na(last_name) 
    & suffix == "BORDEN" ~ "BORDEN",
    first_name == "RICARDO" & middle_name == "DE" & last_name == "LA" 
    & suffix == "FUENTE" ~ "DE LA FUENTE",
    first_name == "MONICA" & middle_name == "DE" & last_name == "LA" 
    & suffix == "CRUZ-HERNANDEZ" ~ "DE LA CRUZ",
    first_name == "KYLE" & middle_name == "VAN" & last_name == "DE" 
    & suffix == "WATER" ~ "VAN DE WATER",
    first_name == "GERALD" & middle_name == "T" & last_name == "VAN" 
    & suffix == "SICKLE" ~ "VAN SICKLE",
    first_name == "MICHELLE" & middle_name == "DE" & last_name == "LA" 
    & suffix == "ISLA" ~ "DE LA ISLA",
    first_name == "GENERAL" & middle_name == "PARKER" & is.na(last_name) ~ "PARKER",
    first_name == "DIANE" & middle_name == "E" & last_name == "MITSCH" 
    & suffix == "BUSH" ~ "BUSH",
    first_name == "JAMES" & middle_name == "E" & last_name == "JIM" 
    & suffix == "CLYBURN" ~ "CLYBURN",
    first_name == "EBERT" & middle_name == "G" & last_name == "BILL" 
    & suffix == "BEEMAN" ~ "BEEMAN",
    first_name == "VICKIE" & middle_name == "YATES" & last_name == "B" 
    & suffix == "GLISSON" ~ "GLISSON",
    first_name == "ANDREW" & middle_name == "VSEVOLOD" & last_name == "VON" 
    & suffix == "SONN" ~ "VON SONN",
    first_name == "WILLIAM" & middle_name == "MAVERICK" & last_name == "ST" 
    & suffix == "CLAIRE" ~ "ST CLAIRE",
    first_name == "C" & middle_name == "W" & last_name == "BILL" 
    & suffix == "YOUNG" ~ "YOUNG",
    first_name == "GLORIA" & last_name == "E" & suffix == "LA RIVA" ~ "LA RIVA",
    first_name == "SAM" & middle_name == "S" & suffix == "CALIGIURI" ~ "CALIGIURI",
    first_name == "C" & middle_name == "A" & last_name == "DUTCH" 
    & suffix == "RUPPERSBERGER" ~ "RUPPERSBERGER",
    first_name == "SEAN" & middle_name == "D" & suffix == "MIELAT" ~ "MIELAT",
    first_name == "J" & middle_name == "MATTHEW" & suffix == "DE HEUS" ~ "DE HEUS",
    first_name == "TRACELLA" & middle_name == "LOU" & suffix == "HILL" ~ "HILL",
    first_name == "M" & middle_name == "E" & last_name == "MAC" 
    & suffix == "MCCULLOUGH" ~ "MCCULLOUGH",
    first_name == "WYNNE" & middle_name == "V" & last_name == "E" 
    & suffix == "LEGROW" ~ "LEGROW",
    first_name == "THOMAS" & middle_name == "S" & suffix == "PERRIELLO" ~ "PERRIELLO",
    first_name == "JONATHAN" & middle_name == "TE" & suffix == "COURTNEY" ~ "COURTNEY",
    first_name == "FRANK" & middle_name == "DELLA" & suffix == "VALLE" ~ "VALLE",
    first_name == "NAN" & middle_name == "AS" & suffix == "HAYWORTH" ~ "HAYWORTH",
    first_name == "BRIAN" & middle_name == "RYAN" & last_name == "B" 
    & suffix == "DOYLE" ~ "DOYLE",
    first_name == "HOWARD" & middle_name == "TERM" & last_name == "LIMITS" 
    & suffix == "LAWSON" ~ "LAWSON",
    first_name == "ROSEANN" & middle_name == "EHRHARD" & suffix == "WOFFORD" ~ "WOFFORD",
    first_name == "NICHOLAS" & suffix == "DI IORIO" ~ "Di Iorio",
    first_name == "ALAN" & middle_name == "J" & last_name == "K" 
    & suffix == "YIM" ~ "YIM",
    first_name == "KAREN" & middle_name == "FREE" & last_name == "SPIRIT" 
    & suffix == "TALLEY-LANE" ~ "TALLEY-LANE",
    TRUE ~ last_name)) %>% # Keep existing values for all other rows
  mutate(middle_name = case_when(
      first_name == "DIANE" & middle_name == "E" & last_name == "BUSH" ~ "MITSCH",
      first_name == "JAMES" & middle_name == "E" & last_name == "CLYBURN" ~ "ENOS",
      first_name == "C" & middle_name == "W" & last_name == "YOUNG" ~ "WILLIAM",
      first_name == "SAM" & middle_name == "S" & last_name == "CALIGIURI" ~ "SF",
      first_name == "TRACELLA" & middle_name == "LOU" & last_name == "HILL" ~ "LOU O'HARA",
      first_name == "THOMAS" & middle_name == "S" & last_name == "PERRIELLO" ~ "SP",
      first_name == "JONATHAN" & middle_name == "T" & last_name == "COURTNEY" ~ "TE",
      first_name == "FRANK" & middle_name == "L" & last_name == "VALLE" ~ "DELLA",
      first_name == "NAN" & middle_name == "A" & last_name == "HAYWORTH" ~ "AS",
      first_name == "ROSEANN" & middle_name == "L" & last_name == "WOFFORD" ~ "EHRHARD",
      first_name == "SEAN" & middle_name == "D" & last_name == "MIELAT" ~ "DM",
      TRUE ~ middle_name)) %>%  # Keep existing values for all other rows
  mutate(first_name = case_when(
    first_name == "C" & middle_name == "WILLIAM" & last_name == "YOUNG" ~ "CHARLES",
    first_name == "C" & last_name == "RUPPERSBERGER" ~ "DUTCH",
    first_name == "M" & middle_name == "E" & last_name == "MCCULLOUGH" ~ "MAC",
    TRUE ~ first_name))  # Keep existing values for all other rows
  
# Set all suffix values to NA
house_generals$suffix <- NA

# Variable not needed for BISG
house_generals <- house_generals %>%
  select(-suffix)

# Set all adjusted middle names to NA
house_generals <- house_generals %>%
  mutate(middle_name = case_when(
      first_name == "KAREN" & middle_name == "FREE" & last_name == "TALLEY-LANE" ~ NA,
      first_name == "ALAN" & middle_name == "J" & last_name ==  "YIM" ~ NA,
      first_name == "HOWARD" & middle_name == "TERM" & last_name == "LAWSON" ~ NA,
      first_name == "BRIAN" & middle_name == "RYAN" & last_name == "DOYLE" ~ NA,
      first_name == "WYNNE" & middle_name == "V" & last_name == "LEGROW" ~ NA,
      first_name == "MAC" & middle_name == "E" & last_name == "MCCULLOUGH" ~ NA,
      first_name == "EBERT" & middle_name == "G" & last_name == "BEEMAN" ~ NA,
      first_name == "GENERAL" & middle_name == "PARKER" & last_name == "PARKER" ~ NA,
      first_name == "MICHELLE" & middle_name == "DE" & last_name == "DE LA ISLA" ~ NA,
      first_name == "KYLE" & middle_name == "VAN" & last_name == "VAN DE WATER" ~ NA,
      first_name == "MONICA" & middle_name == "DE" & last_name == "DE LA CRUZ" ~ NA,
      first_name == "RICARDO" & middle_name == "DE" & last_name == "DE LA FUENTE" ~ NA,
      first_name == "GEORGE" & middle_name == "A" & last_name == "SANTOS" ~ NA,
      TRUE ~ middle_name))  # Keep existing values for all other rows
```

```{r}
house_generals <- house_generals %>%
 # Remove commas at end of string
  mutate(middle_name = gsub(",\\s*$", "", middle_name)) %>%
  mutate(last_name = gsub(",\\s*$", "", last_name)) %>%
  # Remove redundant rows
  distinct(year, district, last_name, first_name, .keep_all = TRUE)
```

```{r}
# Calculate results

house_generals <- house_generals %>%
  # Calculate proportion of votes the candidate received
  mutate(win_proportion = candidate_votes / total_votes) %>%
  # Label all districts with their states so they are distinct
   mutate(district = paste(state, district, sep = "_")) %>%
  # Exclude candidates that received no votes
   filter(candidate_votes != 0)

plurality_states <- house_generals %>% 
  # Exclude states without a plurality system 
  filter(!state %in% c("AK", "ME", "GA", "LA")) %>% 
  # Group into distinct contests
  group_by(year, state, district) %>% 
  # Designate a candidate a winner if they received the highest vote proportion
  mutate(result = ifelse(win_proportion == max(win_proportion), "WON", "LOST")) %>%
  # Remove grouping of distinct contests
  ungroup()

GA_LA <- house_generals %>%
  # Filter to just Georgia and Louisiana
  filter(state %in% c("GA", "LA")) %>%
  # Group into distinct contests
  group_by(year, state, district) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WON", "LOST")
    } else {
       # In  6 cases of no one getting over 50%, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WON", "LOST")}) %>%
  # Remove grouping of distinct contests
  ungroup()

AK_ME <- house_generals %>%
  # Filters to just Alaska and Maine
  filter(state %in% c("AK", "ME")) %>%
   # Groups into distinct contests
  group_by(year, state, district) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WON", "LOST")
    } else {
      # In 3 cases of no one getting over 50%, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WON", "LOST")}) %>%
  # Remove grouping of distinct contests
  ungroup()
  
# Bind rows back together
house_generals <- bind_rows(plurality_states, GA_LA, AK_ME)

# Variables not needed anymore
house_generals <- house_generals %>%
  select(-c(candidate_votes, total_votes, win_proportion))
```


## Cleaning US Senate Candidates (Generals, through 2020)

Dataset citation:
MIT Election Data And Science Lab. 2017. “U.S. Senate Statewide 1976–2020.
doi:10.7910/DVN/PEJ5QU.

```{r}
# Read in senate data
senate_generals <- read.csv("senate_generals through 2020.csv")
```

```{r}
# Subset to case years
senate_generals <- senate_generals %>%
  filter(year >= 2010) %>%
# Removing irrelevant variables or columns with only one value
  select(-c(state, state_cen, state_ic, office, district, party_detailed, unofficial, version, writein, state_fips, mode)) %>%
  # Turn empty cells to NAs
  mutate(candidate = na_if(str_trim(candidate), "")) %>%
# Removing rows with no candidate name
    filter(!is.na(candidate)) %>%
# Any party besides Democrat or Republican gets called Other
   mutate(party_simplified = ifelse(party_simplified == "DEMOCRAT" | party_simplified == "REPUBLICAN",
                                    party_simplified, "OTHER")) %>%
# Renaming variables
  rename(state = state_po, candidate_votes = candidatevotes, total_votes = totalvotes, party = party_simplified) %>%
# Removes meaningless values
# "MA" is candidate with just first name and 18 votes
  filter(!candidate %in% c("BLANK VOTE/SCATTERING", "SCATTER", "OTHER", "OVER VOTE", "BLANK VOTE", "OTHERS", "OVER VOTES", "UNDER VOTES", "BLANK VOTES","VOID VOTE", "NONE OF THESE CANDIDATES", "OTHER CANDIDATES", "BLANK VOTE/VOID VOTE/SCATTERING", "NONE OF THE ABOVE", "MA")) %>%
    # Removes the word in quotes along with the quotes
  mutate(candidate = gsub('[\"“”][^\"“”]+[\"“”]', '', candidate)) %>%
# Separates candidate names 
  separate(candidate, into = c("first_name", "middle_name", "last_name", "suffix"), sep = " ", extra = "merge", fill = "right") %>%
    mutate(middle_name = ifelse(trimws(middle_name) == "", NA, middle_name))
  
# If nothing was put in last_name, the second name was the last name so move middle_name value to last_name
senate_generals$last_name <- 
  ifelse(is.na(senate_generals$last_name), senate_generals$middle_name, senate_generals$last_name)

# Fill middle_name with NA if middle_name value got moved to last_name
senate_generals$middle_name <-
  ifelse(senate_generals$middle_name == senate_generals$last_name, NA, senate_generals$middle_name)

senate_generals <- senate_generals %>%
  # Manual error fixes
  mutate(last_name = case_when(
    first_name == "NIMROD" ~ "ALLEN",
    suffix == "GALAN" ~ "GALAN",
    suffix == "SPEARS" ~ "LANE",
    suffix == "LAFARGUE" ~ "G",
    suffix == "LAND, JR." ~ "ROBERT",
    middle_name == "MANCHIN" ~ "MANCHIN",
    suffix == "OBERWEIS" ~ "OBERWEIS",
    middle_name == "EMERSON" ~ "EMERSON",
    suffix == "GIUFFRE" ~ "GIUFFRE",
    last_name == "JR." & first_name == "GREGORY" ~ "TAYLOR",
    middle_name == "LOVE" ~ "LOVE",
    middle_name == "DE" ~ "DE LEON",
    first_name == "ROBERT" & state == "NJ" & year == 2018 ~ "MENENDEZ",
    TRUE ~ last_name)) %>%
  mutate(first_name = case_when(
    last_name == "GALAN" ~ "SKIP",
    last_name == "MELANCON" ~ "CHARLIE",
    TRUE ~ first_name)) %>%
  mutate(middle_name = case_when(
    last_name == "MANCHIN" ~ NA,
    suffix == "SPEARS" ~ NA,
    suffix == "LAFARGUE" ~ NA,
    suffix == "LAND, JR." ~ NA, 
    middle_name == "EMERSON" ~ NA,
    first_name == "GREGORY" & last_name == "TAYLOR" ~ NA,
    last_name == "LOVE" ~ NA,
    last_name == "DE LEON" ~ NA,
    last_name == "HORNING" ~ NA,
    last_name == "TURKAVAGE" ~ NA,
    last_name == "SONI" ~ NA,
    TRUE ~ middle_name)) %>%
# Remove suffix, not needed for BISG
  select(-suffix) %>%
  # Remove period at the end of one letter middle names 
   mutate(middle_name = gsub('\\.$', '', middle_name)) %>%
  # Remove period at the end of one letter first names 
   mutate(first_name = gsub('\\.$', '', first_name)) %>%
  # Remove period at the end of one letter last names 
   mutate(last_name = gsub('\\.$', '', last_name)) %>%
  # Remove comma at end
  mutate(last_name = gsub(",\\s*$", "", last_name)) %>%
  mutate(across(everything(), ~ replace(., . == "", NA))) %>%
  # Remove redundant candidates within an election
  distinct(first_name, middle_name, last_name, year, state, .keep_all = TRUE)
```

```{r}
# Results calculation

senate_generals <- senate_generals %>%
  # Excludes candidates that received no votes
   filter(candidate_votes != 0) %>%
  # Calculates proportion of votes the candidate received
  mutate(win_proportion = candidate_votes / total_votes)

plurality_states <- senate_generals %>% 
  # Excludes states without a plurality system 
  filter(!state %in% c("AK", "ME", "GA", "LA")) %>% 
  # Groups into distinct contests
  group_by(year, state) %>% 
  # Designates a candidate a winner if they received the highest vote proportion
  mutate(result = ifelse(win_proportion == max(win_proportion), "WINNER", "LOSER")) %>%
  ungroup()

GA_LA <- senate_generals %>%
  filter(state %in% c("GA", "LA")) %>%
  # Groups into distinct contests
  group_by(year, state) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WINNER", "LOSER")
    } else {
       # In all 6 cases of no one getting over 50% of the votes, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WINNER", "LOSER")}) %>%
  ungroup()

AK_ME <- senate_generals %>%
  filter(state %in% c("AK", "ME")) %>%
   # Groups into distinct contests
  group_by(year, state) %>%
  mutate(
     # Check if any candidate has more than 50%
    result = if (any(win_proportion > 0.5)) {
       # If a candidate gets more than 50% they win
      ifelse(win_proportion > 0.5, "WINNER", "LOSER")
    } else {
      # In all 3 cases of no one getting over 50% of the votes, the max win_proportion won
      ifelse(win_proportion == max(win_proportion), "WINNER", "LOSER")}) %>%
  ungroup()
```

```{r}
# Manual fixes to results
# Plurality state fixes

plurality_states <- plurality_states %>%
  mutate(result = case_when(
    last_name == "LONG" & first_name == "WENDY" ~ "LOSER",
    last_name == "FARLEY" ~ "LOSER",
    last_name == "HARRISON" ~ "LOSER",
    last_name == "GILLIBRAND" ~ "WINNER",
    last_name == "LANKFORD" ~ "WINNER",
    last_name == "GRAHAM" ~ "WINNER",
    TRUE ~ result))

plurality_states <- add_row(plurality_states, year = 2018, state = "MS", stage = "gen", special = "False", first_name = "ROGER", middle_name = "F", last_name = "WICKER", candidate_votes = NA, total_votes = NA, party = "REPUBLICAN", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2018, state = "MN", stage = "gen", special = "False", first_name = "AMY", middle_name = NA, last_name = "KLOBUCHAR", candidate_votes = NA, total_votes = NA, party = "DEMOCRAT", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2012, state = "NY", stage = "gen", special = "False", first_name = "KIRSTEN", middle_name = "E", last_name = "GILLIBRAND", candidate_votes = NA, total_votes = NA, party = "DEMOCRAT", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2018, state = "NY", stage = "gen", special = "False", first_name = "KIRSTEN", middle_name = "E", last_name = "GILLIBRAND", candidate_votes = NA, total_votes = NA, party = "DEMOCRAT", win_proportion = NA, result = "WINNER")
plurality_states <- add_row(plurality_states, year = 2020, state = "SC", stage = "gen", special = "False", first_name = "LINDSEY", middle_name = NA, last_name = "GRAHAM", candidate_votes = NA, total_votes = NA, party = "REPUBLICAN", win_proportion = NA, result = "WINNER")

# GA and LA state fixes
GA_LA <- GA_LA %>%
  mutate(result = case_when(
    last_name == "WARNOCK" ~ "WINNER",
    last_name == "BARKSDALE" ~ "LOSER",
    TRUE ~ result)) %>%
  mutate(first_name = case_when(
    last_name == "CASSIDY" ~ "BILL",
    TRUE ~ first_name))

GA_LA <- add_row(GA_LA, year = 2016, state = "GA", stage = "gen", special = "False", first_name = "JOHNNY", middle_name = NA, last_name = "ISAKSON", candidate_votes = NA, total_votes = NA, party = "REPUBLICAN", win_proportion = NA, result = "WINNER")

# AK and ME state fixes
AK_ME <- AK_ME %>%
  mutate(result = case_when(
  last_name == "STOCK" ~ "LOSER",
  last_name == "GROSS" ~ "LOSER",
  TRUE ~ result))
  
AK_ME <- add_row(AK_ME, year = 2016, state = "AK", stage = "gen", special = "False", first_name = "LISA", middle_name = NA, last_name = "MURKOWSKI", candidate_votes = NA, total_votes = NA, party = "REPUBLICAN", win_proportion = NA, result = "WINNER")
AK_ME <- add_row(AK_ME, year = 2020, state = "AK", stage = "gen", special = "False", first_name = "DAN", middle_name = NA, last_name = "SULLIVAN", candidate_votes = NA, total_votes = NA, party = "REPUBLICAN", win_proportion = NA, result = "WINNER")

# Bind back results
senate_generals <- bind_rows(plurality_states, GA_LA, AK_ME)

senate_generals <- senate_generals %>%
  # Variables not needed anymore
  select(-c(candidate_votes, total_votes, win_proportion)) %>%
   # Removes question marks from middle names
  mutate(middle_name = gsub("\\?", "", middle_name))
```

```{r}
# Read in 2022 & 2024 senate data
sen_20_24 <- read.csv("senate_generals_2022_2024.csv")

sen_20_24 <- sen_20_24 %>%
  # Match values to other senate dataset
  mutate(special = case_when(
    special == "NO" ~ "False",
    special == "YES" ~ "True")) %>%
  mutate(race = tolower(race))
```


## BISG

wru package citation:
Khanna, Kabir, Brandon Bertelsen, Santiago Olivella, Evan Rosenman, Alexander Rossell
Hayes, and Kosuke Imai. 2015. “Wru: Who Are You? Bayesian Prediction of Racial
Category Using Surname, First Name, Middle Name, and Geolocation.” 
doi:10.32614/CRAN.package.wru.

Note: Insert your own unique census API key into the quotes below.

```{r}
Sys.setenv(CENSUS_API_KEY = "")
```

```{r}
# Scraping census data

census.data <- get_census_data(
  # Personal API key from US Census Bureau
  key = Sys.getenv("CENSUS_API_KEY"),
  # Collect for all states
  states = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", 
  "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
  "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", 
  "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", 
  "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"),
  # Don't include age or sex
  age = FALSE,
  sex = FALSE,
  year = "2010",
  # Pull data by county
  census.geo = c("county"),
  # Number of times to reboot if network error
  retry = 1)
```

Dataset citation:
MDR Education, https://mdreducation.com/pdfs/US_FIPS_Codes.xls.

```{r}
# Read in data
fips_match <- read.csv("Fips Match Sheet - Sheet1.csv")
```

```{r}
fips_match <- fips_match %>%
  # Rename variables
  rename(county_name = County.Name,
         state_fips = FIPS.State,
         county_fips = FIPS.County,
         state_name = State) %>%
  # Set to lowercase
  mutate(county_name = tolower(county_name))
```

```{r}
# Create named vector to reassign spelled-out states to abbreviations
state_mapping <- c(
  "Alabama" = "AL", "Alaska" = "AK", "Arizona" = "AZ", "Arkansas" = "AR",
  "California" = "CA", "Colorado" = "CO", "Connecticut" = "CT", "Delaware" = "DE",
  "Florida" = "FL", "Georgia" = "GA", "Hawaii" = "HI", "Idaho" = "ID",
  "Illinois" = "IL", "Indiana" = "IN", "Iowa" = "IA", "Kansas" = "KS",
  "Kentucky" = "KY", "Louisiana" = "LA", "Maine" = "ME", "Maryland" = "MD",
  "Massachusetts" = "MA", "Michigan" = "MI", "Minnesota" = "MN", "Mississippi" = "MS",
  "Missouri" = "MO", "Montana" = "MT", "Nebraska" = "NE", "Nevada" = "NV",
  "New Hampshire" = "NH", "New Jersey" = "NJ", "New Mexico" = "NM", "New York" = "NY",
  "North Carolina" = "NC", "North Dakota" = "ND", "Ohio" = "OH", "Oklahoma" = "OK",
  "Oregon" = "OR", "Pennsylvania" = "PA", "Rhode Island" = "RI", "South Carolina" = "SC",
  "South Dakota" = "SD", "Tennessee" = "TN", "Texas" = "TX", "Utah" = "UT",
  "Vermont" = "VT", "Virginia" = "VA", "Washington" = "WA", "West Virginia" = "WV",
  "Wisconsin" = "WI", "Wyoming" = "WY")

fips_match <- fips_match %>%
  # Index at new state name
   mutate(state_name = state_mapping[state_name])
```

Note: to complete merge, obtain hun_six dataset and code from Cleaning Protests.rmd file.

```{r}
# Combine datasets into comprehensive matching dataset

hun_six <- hun_six %>%
  rename(county_name = county,
         state_name = state)

full_match <- left_join(fips_match, hun_six, by = c("county_name", "state_name"))

full_match <- full_match %>%
  # Remove unnecessary variables
  select(-c(state_fips, county_name)) %>%
  # Rename variable
  rename(state = state_name)
```

## US Senate BISG and Analysis

```{r}
# Merge senate dataset with matching dataset on state
senate <- left_join(senate_generals, full_match, by = c("state"))

senate <- senate %>%
  distinct(year, state, first_name, last_name, party, county_fips, .keep_all = TRUE)
```

```{r}
SBISG <- senate %>%
  # Grab relevant columns
  select(county_fips, last_name, first_name, middle_name, state, party) %>%
  # Reassign values for BISG
  mutate(party = case_when(
    party == "DEMOCRAT" ~ "1",
    party == "REPUBLICAN" ~ "2",
    party == "OTHER" ~ "0")) %>%
  # Remove white space
  mutate(county_fips = str_trim(county_fips)) %>%
  # Put leading zeros as needed
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  # Rename variables for BISG
  rename(surname = last_name,
         county = county_fips,
         first = first_name,
         middle = middle_name) %>%
  # Remove rows with missing county or last name
  filter(!is.na(county) & !is.na(surname)) %>%
  # Remove duplicates made in matching
  distinct()
```

```{r}
# Run BISG
SBISG <- predict_race(
  voter.file = SBISG,
  census.surname = TRUE,
  surname.only = FALSE,
  # Use all name components
  names.to.use = "surname, first, middle",
  # Compute predictions for each county in the state
  # State is not an available input
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  # Use party
  party = "party",
  year = "2020",
  skip_bad_geos = TRUE) 
```

```{r}
RSBISG <- SBISG %>%
  # Remove duplicates of candidates within counties
  distinct(first, surname, county, state, .keep_all = TRUE) %>%
  # Group by candidate
  group_by(first, surname, state) %>%
  # Compute the average race prediction of the candidate across all counties in the state
  mutate(avg_white = mean(pred.whi),
         avg_black = mean(pred.bla),
         avg_his = mean(pred.his),
         avg_asi = mean(pred.asi),
         avg_other = mean(pred.oth)) %>%
  # Assign candidate's race based on highest average 
  mutate(
      race = case_when(
      avg_white == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "white",
      avg_black == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "black",
      avg_his == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "hispanic",
      avg_asi == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "asian",
      avg_other == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "other")) 

# Convert to dataframe
RSBISG <- as.data.frame(RSBISG)

RSBISG <- RSBISG %>%
  # Group by candidate
   group_by(first, surname, middle, state) %>%
    mutate(
      # When the average white and Black estimates are close, there is at least a 0.3 average chance the candidate is Black, and the party is Democrat, flag as a check
      race = case_when(
  abs(avg_white - avg_black) <= 0.2 & avg_black >= 0.3 & party == "1" ~ "check",
  TRUE ~ race)) %>%
  # Remove grouping
    ungroup() %>%
  # Select relevant columns
   select(surname, first, state, middle, race) %>%
  # Rename variables
   rename(first_name = first,
         last_name = surname,
         middle_name = middle) %>%
  # Remove redundancies
    distinct()
```

```{r}
# Merge with full senate candidate dataset
senate_BISG <- left_join(senate_generals, RSBISG, by = c("state", "last_name", "first_name"))

senate_BISG <- senate_BISG %>%
  # Remove extra column
  select(-middle_name.y) %>%
  # Rename variable
  rename(middle_name = middle_name.x)
```

```{r}
# Filling in "check" race or missing race via manual online collection
# Ballotpedia, BallotReady etc.
# Denoting Middle Eastern candidates as Asian for manual collection

senate_BISG <- senate_BISG %>%
  mutate(race = case_when(
    last_name == "JONES" ~ "white",
    last_name == "WILSON" & first_name == "WILLIE" ~ "black",
    last_name == "BOOKER" ~ "black",
    last_name == "BRADSHAW" ~ "black",
    last_name == "JOHNSON" & middle_name == "WAYNE" ~ "white",
    last_name == "TAYLOR" & first_name == "KANDISS" ~ "white",
    last_name == "DARET" ~ "white",
    last_name == "JOHN" ~ "white",
    last_name == "CUNNINGHAM" ~ "white",
    last_name == "BARTELL" ~ "black",
    last_name == "FORTUIN" ~ "white",
    last_name == "WINFIELD" ~ "white",
    last_name == "HARRISON" ~ "black",
    last_name == "GROSS" ~ "white",
    middle_name == "MALOUF" ~ "white",
    last_name == "PETERS" ~ "white",
    middle_name == "INHOFE" ~ "white",
    last_name == "MURPHY" ~ "white",
    last_name == "COLLINS" ~ "white",
    last_name == "KING" ~ "white",
    last_name == "CLEMENTS" ~ "white",
    middle_name == "ROBERT" ~ "white",
    first_name == "THOMAS" & middle_name == "G" ~ "white",
    last_name == "HEINRICH" ~ "white",
    last_name == "BRENTON" ~ "white",
    last_name == "THUNE" ~ "white",
    first_name == "JOHN" & middle_name == "M" ~ "white",
    first_name == "JAMES" & middle_name == "D" ~ "white",
    last_name == "LANDRIEU" ~ "white",
    first_name == "KAMALA" ~ "black",
    last_name == "WILLIAMS" & first_name == "PETER" ~ "black",
    last_name == "THURMOND" ~ "black",
    last_name == "ESPY" ~ "black",
    last_name == "DIXON" & first_name == "THOMAS" ~ "black",
    last_name == "MARSHALL" & first_name == "ELAINE" ~ "white",
    TRUE ~ race))

senate_BISG <- senate_BISG %>%
  # These are candidates lacking sufficient identification so must be dropped
  # This is done so by removing candidates missing race
  filter(!is.na(race)) %>%
  mutate(incumbent = NA,
         gender = NA)
```

```{r}
# All columns match up in order
# sen_20_24 has additional columns
senate_BISG <- rbind(senate_BISG, sen_20_24)
```

```{r}
senate_2020 <- senate_BISG %>%
  # Filter to 2020 Senate races
  filter(year == 2020)

# Merge with protest dataset to create dataset for analysis
senate_protest_2020 <- left_join(senate_2020, state_protests, by = "state")
```

```{r}
# Calculate pre-2020 and 2022 average win rates for Black candidates in that state
black_historical_senate <- senate_BISG %>%
  filter(race == "black" & year != 2020) %>%
  group_by(state) %>%
  summarize(black_success_rate = mean(result == "WINNER"))
# Calculate pre-2020 and 2022 average win rates for white candidates in that state
white_historical_senate <- senate_BISG %>%
  filter(race == "white" & year != 2020) %>%
  group_by(state) %>%
  summarize(white_success_rate = mean(result == "WINNER"))

# Merge historical success rates with 2020 data
senate_protest_2020 <- left_join(senate_protest_2020, white_historical_senate, by = "state")
senate_protest_2020 <- left_join(senate_protest_2020, black_historical_senate, by = "state")

# Calculate pre-2020 and 2022 average win rates for Black candidates in that state
black_candidates <- senate_protest_2020 %>%
  filter(race == "black") %>%
  mutate(success = ifelse(result == "WINNER", 1, 0))

# Calculate pre-2020 and 2022 average win rates for white candidates in that state
white_candidates <- senate_protest_2020 %>%
  filter(race == "white") %>%
  mutate(success = ifelse(result == "WINNER", 1, 0))
```

```{r}
# Example logistic regression model
model <- glm(success ~ chemical_agents + white_success_rate, data = white_candidates, family = binomial)
summary(model)
```

## House of Representatives BISG and Analysis

```{r}
# Merge full house dataset with matching dataset on state and district
house <- left_join(house_generals, full_match, by = c("state", "district"))
```

```{r}
HBISG <- house %>%
  # Grab relevant columns
  select(county_fips, last_name, first_name, middle_name, state, party) %>%
  # Reassign values
  mutate(party = case_when(
    party == "DEMOCRAT" ~ "1",
    party == "REPUBLICAN" ~ "2",
    party == "OTHER" ~ "0")) %>%
  # Remove white space
  mutate(county_fips = str_trim(county_fips)) %>%
  # Put leading zeros as needed
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  # Rename variables
  rename(surname = last_name,
         county = county_fips,
         first = first_name,
         middle = middle_name) %>%
  # Remove rows missing county or last name
  filter(!is.na(county) & !is.na(surname)) %>%
  # Remove redudancies
  distinct()
```

```{r}
# Generate race predictions
HBISG <- predict_race(
  voter.file = HBISG,
  census.surname = TRUE,
  surname.only = FALSE,
  names.to.use = "surname, first, middle",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  party = "party",
  year = "2020",
  skip_bad_geos = TRUE) 
```

```{r}
RHBISG <- HBISG %>%
  # Remove duplicates of candidates within counties
  distinct(first, surname, county, state, .keep_all = TRUE) %>%
  # Group by candidate
  group_by(first, surname, state) %>%
  # Compute the average race prediction of the candidate across all counties in the district
  mutate(avg_white = mean(pred.whi),
         avg_black = mean(pred.bla),
         avg_his = mean(pred.his),
         avg_asi = mean(pred.asi),
         avg_other = mean(pred.oth)) %>%
   # Assign candidate's race based on highest average
    mutate(
      race = case_when(
      avg_white == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "white",
      avg_black == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "black",
      avg_his == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "hispanic",
      avg_asi == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "asian",
      avg_other == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "other")) 

# Convert to data frame
RHBISG <- as.data.frame(RHBISG)

RHBISG <- RHBISG %>%
  # Group by candidate
   group_by(first, surname, middle, state) %>%
    mutate(
      race = case_when(
    # When the average white and Black estimates are close, there is at least a 0.3 average chance the candidate is Black, and the party is Democrat, flag as a check
  abs(avg_white - avg_black) <= 0.2 & avg_black >= 0.3 & party == "1" ~ "check",
  TRUE ~ race)) %>%
  # Ungroup
  ungroup() %>%
  # Select relevant variables
 select(surname, first, state, middle, race) %>%
  # Rename variables
  rename(first_name = first,
         last_name = surname,
         middle_name = middle) %>%
  # Remove redundancies
   distinct()
```

```{r}
# Combine full house dataset with race predictions
house_BISG <- left_join(house_generals, RHBISG, by = c("state", "last_name", "first_name"))

house_BISG <- house_BISG %>%
  # Remove extra column
  select(-middle_name.x) %>%
  # Rename variables
  rename(middle_name = middle_name.y)
```

```{r}
# Filling in "check" race, missing race, and missing names via manual online collection
# Ballotpedia, BallotReady etc.
# Denoting Middle Eastern candidates as Asian for manual collection

house_BISG <- house_BISG %>%
  mutate(last_name = case_when(
    first_name == "HENRY" & district == "GA_4" ~ "JOHNSON",
    first_name == "EARL" & district == "GA_1" ~ "CARTER",
    first_name == "GEOFFREY" & district == "KY_6" ~ "YOUNG",
    first_name == "WILLIAM" & district == "IN_1" ~ "POWERS",
    first_name == "JAMES" & district == "VA_11" ~ "MYLES",
    first_name == "ROBERT" & district == "VA_3" ~ "SCOTT",
    first_name == "HERBERT" & district == "VA_1" ~ "JONES",
    first_name == "CHARLES" & district == "TN_3" ~ "FLEISCHMANN",
    first_name == "MICHAEL" & district == "CA_5" ~ "BARKLEY",
    first_name == "DEBRA" & district == "AZ_5" ~ "BORDEN",
    TRUE ~ last_name))

house_BISG <- house_BISG %>%
  mutate(race = case_when(
    last_name == "MOORE" & first_name == "BARRY" ~ "white",
    last_name == "ROGERS" & first_name == "MIKE" ~ "white",
    last_name == "OMAR" ~ "black",
    last_name == "SEWELL" ~ "black",
    last_name == "GILES" ~ "white",
    last_name == "EARLY" ~ "white",
    last_name == "WALKER" & first_name == "KIMBERLY" ~ "black",
    last_name == "ELLISON" & first_name == "ALLEN" ~ "black",
    last_name == "MUCARSEL-POWELL" ~ "white",
    last_name == "RUSH" ~ "black",
    first_name == "PHILANISE" ~ "black",
    last_name == "NEWMAN" ~ "white",
    last_name == "ROWDER" ~ "white",
    last_name == "CAMERON" ~ "black",
    last_name == "SCHAKOWSKY" ~ "white",
    last_name == "CARSON" & (first_name == "ANDRE" | first_name == "ANDRÉ") ~ "black",
    last_name == "HARRIS" & last_name == "ANDY" ~ "white",
    last_name == "BROWN" & first_name == "ANTHONY" ~ "black",
    last_name == "JONES" & first_name == "JEFF" ~ "white",
    last_name == "EASON" ~ "black",
    last_name == "KELLY" & first_name == "TRENT" ~ "white",
    last_name == "GUEST" ~ "white",
    last_name == "GORDON" ~ "black",
    last_name == "MALLIOTAKIS" ~ "white",
    last_name == "MORRIS-PERRY" ~ "black",
    last_name == "GWINN" ~ "hispanic",
    last_name == "COBB" & first_name == "TEDRA" ~ "white",
    last_name == "MATEMU" ~ "black",
    last_name == "THOMAS" & first_name == "ROBERT" ~ "white",
    last_name == "EVERETT" & first_name == "THERESA" ~ "black",
    last_name == "TIMMONS-GOODSON" ~ "black",
    last_name == "WALLACE" & first_name == "CYNTHIA" ~ "black",
    last_name == "DAVIS" & first_name == "ANGELA" ~ "white",
    last_name == "REED" & first_name == "ISAAC" ~ "white",
    last_name == "ENOCH" ~ "black",
    last_name == "GORE" & first_name == "LAVERNE" ~ "black",
    last_name == "HARVEY" & first_name == "MICHAEL" ~ "black",
    last_name == "NELSON" & first_name == "KIM" ~ "white",
    last_name == "CHANDLER" & first_name == "MICHAEL" ~ "white",
    last_name == "MCCOLLUM" ~ "white",
    last_name == "HACKETT" ~ "white",
    last_name == "RICE" & first_name == "TOM" ~ "white",
    last_name == "CLARK" & first_name == "DENNIS" ~ "black",
    last_name == "CRENSHAW" & first_name == "DAN" ~ "white",
    last_name == "TAYLOR" & first_name == "VAN" ~ "white",
    last_name == "JONES" & first_name == "TRACY" ~ "white",
    last_name == "SALTER" ~ "white",
    last_name == "HUNT" & first_name == "WESLEY" ~ "black",
    last_name == "GRAY" & first_name == "PHIL" ~ "white",
    last_name == "MCEACHIN" ~ "black",
    last_name == "ANDREWS" & first_name == "ALISCIA" ~ "white",
    last_name == "BOURDEAUX" ~ "white",
    last_name == "SCOTT" & first_name == "AUSTIN" ~ "white",
    last_name == "COOPER" & first_name == "JAMES" ~ "white",
    last_name == "KEARNEY" ~ "white",
    last_name == "VINCENT" ~ "white",
    last_name == "GIBSON" ~ "white",
    last_name == "GRAVES" ~ "white",
    last_name == "PALMER" & first_name == "GARY" ~ "white",
    last_name == "CARBAJAL" ~ "hispanic",
    last_name == "LOWENTHAL" ~ "white",
    last_name == "MCCORMICK" ~ "white",
    last_name == "REALE" ~ "white",
    last_name == "DUNN" ~ "white",
    last_name == "MURPHY" & first_name == "STEPHANIE" ~ "asian",
    last_name == "DEMINGS" ~ "black",
    last_name == "COTTRELL" ~ "white",
    last_name == "QUINN" ~ "white",
    last_name == "COHN" ~ "white",
    last_name == "SHALALA" ~ "white",
    last_name == "GARCIA" ~ "hispanic",
    last_name == "SCHNEIDER" ~ "white",
    first_name == "GENERAL" ~ "black",
    last_name == "COMER" ~ "white",
    last_name == "TRONE" ~ "white",
    last_name == "TRAHAN" ~ "white",
    last_name == "MOULTON" ~ "white",
    last_name == "PRESSLEY" ~ "black",
    last_name == "LAWRENCE" & first_name == "JOHN" ~ "white",
    last_name == "LAWRENCE" & first_name == "BRENDA" ~ "black",
    last_name == "STEVENS" ~ "white",
    last_name == "SINDT" ~ "white",
    last_name == "PALAZZO" ~ "white",
    last_name == "SMITH" & first_name == "JASON" ~ "white",
    last_name == "STRAWDER" ~ "black",
    last_name == "HORSFORD" ~ "black",
    last_name == "KUSTER" ~ "white",
    last_name == "NORCROSS" ~ "white",
    last_name == "RUFO" ~ "white",
    last_name == "ANABILAH-AZUMAH" ~ "black",
    last_name == "NADLER" ~ "white",
    last_name == "TONKO" ~ "white",
    first_name == "ALMA" ~ "black",
    last_name == "WENSTRUP" ~ "white",
    last_name == "HORN" ~ "white",
    last_name == "MEUSER" ~ "white",
    last_name == "RESCHENTHALER" ~ "white",
    last_name == "THOMPSON" & first_name == "GLENN" ~ "white",
    last_name == "LAMB" ~ "white",
    last_name == "TIMMONS" ~ "white",
    last_name == "NORMAN" ~ "white",
    last_name == "ROSE" ~ "white",
    last_name == "FLETCHER" ~ "white",
    last_name == "WEBER" ~ "white",
    last_name == "ARRINGTON" ~ "white",
    last_name == "BLUNT" & first_name == "JEFFREY" ~ "white",
    last_name == "WILLIAMS" & first_name == "ERIC" ~ "black",
    last_name == "ALLRED" ~ "black",
    last_name == "VEASEY" ~ "black",
    last_name == "CURTIS" ~ "white",
    last_name == "CLINE" ~ "white",
    last_name == "SPANBERGER" ~ "white",
    last_name == "WEXTON" ~ "white",
    last_name == "DELBENE" ~ "white",
    last_name == "BRUBAKER" ~ "white",
    last_name == "JOHNSON-GREEN" ~ "black",
    last_name == "LOUDERMILK" ~ "white",
    last_name == "DUGAS" ~ "white",
    last_name == "RICHMOND" ~ "black",
    last_name == "BAGWELL" ~ "white",
    last_name == "CAMPBELL" & first_name == "MATTHEW" ~ "white",
    last_name == "SHEETS" ~ "white",
    last_name == "PERRY" & first_name == "JEFFREY" ~ "white",
    first_name == "MARYANNE" ~ "white",
    last_name == "NES" ~ "white",
    last_name == "CLYDE" ~ "white", 
    first_name == "HENRY" & last_name == "JOHNSON" ~ "black",
    first_name == "EARL" & last_name == "CARTER" ~ "white",
    last_name == "ABRAHAM" ~ "white",
    last_name == "HICE" ~ "white",
    last_name == "LEWIS" & first_name == "JOHN" ~ "black",
    last_name == "BISHOP" & first_name == "SANFORD" ~ "black",
    last_name == "ROGERS" & first_name == "DAVID" ~ "white",
    last_name == "MOORE" & first_name == "BLAKE" ~ "white",
    last_name == "MCFARLAND" ~ "white",
    last_name == "SALINAS" ~ "white",
    last_name == "ERICKSON" ~ "white",
    last_name == "DELK" ~ "white",
    last_name == "BICE" ~ "white",
    first_name == "ALEXIS" & last_name == "JOHNSON" ~ "hispanic",
    last_name == "RANKIN" ~ "white",
    last_name == "BUCHANAN" ~ "white",
    last_name == "RONNING" ~ "white",
    last_name == "ROSENDALE" ~ "white",
    last_name == "TRANEL" ~ "white",
    last_name == "ZINKE" ~ "white",
    first_name == "EDWARD" & is.na(last_name) ~ "white",
    last_name == "MARTIN" & first_name == "HENRY" ~ "black",
    first_name == "GEOFFREY" ~ "white",
    last_name == "POWERS" ~ "white",
    last_name == "PAGLINO" ~ "white",
    last_name == "MYLES" ~ "white",
    first_name == "ROBERT" & last_name == "SCOTT" ~ "black",
    last_name == "DEJEAN" ~ "white",
    last_name == "KLUSSMANN" ~ "white",
    last_name == "TAYLOR" & first_name == "SHERRI" ~ "white",
    last_name == "ROYAL" ~ "white",
    last_name == "NEHLS" ~ "white",
    last_name == "CLAYTOR" ~ "white",
    last_name == "FLINN" ~ "white",
    first_name == "HERBERT" & last_name == "JONES" ~ "black",
    last_name == "FLEISCHMANN" ~ "white",
    last_name == "SMUCKER" ~ "white",
    last_name == "WILD" ~ "white",
    last_name == "HOULAHAN" ~ "white",
    first_name == "JEFF" & last_name == "JACKSON" ~ "white",
    last_name == "HARRIGAN" ~ "white",
    last_name == "MANNING" ~ "white",
    last_name == "SANTOS" ~ "hispanic",
    last_name == "JOHNSON" & first_name == "CYNTHIA" ~ "black",
    last_name == "VELLUCCI" ~ "white",
    last_name == "GUSTAFSON" ~ "white",
    last_name == "OVERBY" ~ "white",
    last_name == "MILLER" & first_name == "MARY" ~ "white",
    first_name == "JESÚS" ~ "hispanic",
    last_name == "SCHAFFER" ~ "white",
    last_name == "ASENCIO" ~ "white",
    last_name == "GIMENEZ" ~ "hispanic",
    last_name == "BANYAI" ~ "white",
    last_name == "CURNROW" ~ "white",
    last_name == "KONIZ" ~ "white",
    last_name == "LONG" ~ "white",
    last_name == "WARD" & first_name == "RICHARD" ~ "white",
    last_name == "WARD" & first_name == "ELLA" ~ "black",
    last_name == "CARAVEO" ~ "hispanic",
    last_name == "KIRKMEYER" ~ "white",
    last_name == "CHEN" ~ "asian",
    last_name == "BARKLEY" ~ "white",
    first_name == "MONTE" ~ "black",
    first_name == "ERIC" & district == "AR_1" ~ "white",
    last_name == "BORDEN" ~ "white",
    last_name == "CARL" ~ "white",
    last_name == "DUFFY" ~ "white",
    last_name == "MOORE" & first_name == "GWEN" ~ "black",
    last_name == "CONNOLLY" ~ "white",
    last_name == "BRAT" ~ "white",
    last_name == "VELA" ~ "white",
    last_name == "CARTER" & first_name == "JOHN" ~ "white",
    last_name == "MARCHANT" ~ "white",
    last_name == "CULBERSON" ~ "white",
    last_name == "DEFAZIO" ~ "white",
    last_name == "MCHENRY" ~ "white",
    last_name == "PRICE" ~ "white",
    last_name == "LUJAN" ~ "white",
    last_name == "BERLINSKI" ~ "white",
    last_name == "SHELL" ~ "white",
    last_name == "CUNNINGHAM" ~ "white",
    last_name == "DRISKELL" ~ "white",
    last_name == "CUMMINGS" & first_name == "ELIJAH" ~ "black",
    last_name == "MCDERMOTT" ~ "white",
    last_name == "SARBANES" ~ "white",
    last_name == "BUCSHON" ~ "white",
    last_name == "BROOKS" & first_name == "SUSAN" ~ "white",
    last_name == "SHIMKUS" ~ "white",
    last_name == "LIPINSKI" ~ "white",
    last_name == "KELLY" & first_name == "ROBIN" ~ "black",
    last_name == "GRIFFIN" & first_name == "CALVIN" ~ "black",
    last_name == "WILSON" & first_name == "FREDERICA" ~ "black",
    last_name == "BILIRAKIS" ~ "white",
    last_name == "STOCKHAM" ~ "black",
    last_name == "LIEU" ~ "asian",
    last_name == "WRIGHT" & first_name == "KENNETH" ~ "white",
    last_name == "NAPOLITANO" ~ "hispanic",
    last_name == "FAREED" ~ "white",
    last_name == "NUNES" ~ "white",
    last_name == "MATSUI" ~ "asian",
    last_name == "GRIJALVA" ~ "hispanic",
    last_name == "CURNOW" ~ "white",
    last_name == "ADERHOLT" ~ "white",
    last_name == "RYAN" & first_name == "PAUL" ~ "white",
    last_name == "JENKINS" ~ "white",
    last_name == "COMSTOCK" ~ "white",
    last_name == "SIMONSEN" ~ "white",
    last_name == "BALLARD" ~ "white",
    last_name == "CORVALAN" ~ "white",
    last_name == "MITCHELL" ~ "white",
    last_name == "NOEM" ~ "white",
    last_name == "MCCLELLAND" ~ "white",
    last_name == "COSTELLO" ~ "white",
    last_name == "WALKER" & first_name == "DAVID" ~ "white",
    last_name == "KATKO" ~ "white",
    last_name == "BELLONE" ~ "white",
    last_name == "BAKARI" ~ "black",
    last_name == "GERRARD" ~ "white",
    last_name == "NOLAN" ~ "white",
    last_name == "WIRTH" ~ "white",
    last_name == "DELANEY" ~ "white",
    last_name == "DOLD" ~ "white",
    last_name == "HANABUSA" ~ "asian",
    last_name == "YOHO" ~ "white",
    last_name == "GESTY" ~ "white",
    last_name == "SAVARY" ~ "white",
    last_name == "TACHERRA" ~ "white",
    last_name == "SMITH" & first_name == "JESSE" ~ "black",
    last_name == "GALDO" ~ "white",
    last_name == "MCALEER" ~ "white",
    last_name == "ROBERTS" & first_name == "MARK" ~ "white",
    last_name == "RAWLES" ~ "white",
    last_name == "REYNOLDS" & first_name == "STEVEN" ~ "white",
    last_name == "ELLMERS" ~ "white",
    last_name == "HECK" ~ "white",
    last_name == "MONCHIL" ~ "white",
    last_name == "YOUNG" & first_name == "TODD" ~ "white",
    last_name == "ESTY" & first_name == "ELIZABETH" ~ "white",
    last_name == "STROUD" ~ "white",
    last_name == "MIGLIETTA" ~ "white",
    last_name == "TRIVEDI" ~ "white",
    last_name == "ZALETEL" ~ "white",
    last_name == "LITTLE" ~ "white",
    last_name == "CHAPMAN" ~ "white",
    last_name == "LANGKRAEHR" ~ "white",
    last_name == "WUNSCH" ~ "white",
    last_name == "MIRABILE" ~ "white",
    first_name == "KAREN" & last_name == "BASS" ~ "black",
    first_name == "CHARLES" & last_name == "BASS" ~ "white",
    last_name == "DJOU" ~ "asian",
    last_name == "SANDERS" & first_name == "RYAN" ~ "white",
    last_name == "PLATTS" ~ "white",
    last_name == "MONIGHAN" ~ "white",
    last_name == "SPACE" ~ "white",
    last_name == "SUTTON" ~ "white",
    last_name == "GRAHAM" & first_name == "JIM" ~ "white",
    last_name == "GRAHAM" & first_name == "CHARLES" ~ "other",
    last_name == "TRAFICANT" ~ "white",
    last_name == "ZELLER" ~ "white",
    last_name == "ROWLAND" ~ "white",
    last_name == "NACER" ~ "white",
    last_name == "DWYER" ~ "white",
    last_name == "STEELE" ~ "white",
    last_name == "FURMAN" ~ "white",
    last_name == "MORGAN" & first_name == "KERRY" ~ "white",
    last_name == "SMITH" & first_name == "AIMEE" ~ "white",
    last_name == "ZANOWIC" ~ "white",
    last_name == "DAVIS" & first_name == "DANNY" ~ "black",
    last_name == "MEEKS" ~ "black",
    last_name == "LEE" & first_name == "BARBARA" ~ "black",
    last_name == "CLEAVER" ~ "black",
    last_name == "BEATTY" ~ "black",
    last_name == "COLEMAN" & first_name == "BONNIE" ~ "black",
    last_name == "UNDERWOOD" & first_name == "LAUREN" ~ "black",
    last_name == "BUSH" & first_name == "CORI" ~ "black",
    first_name == "RITCHIE" ~ "black",
    last_name == "STRICKLAND" & first_name == "MARILYN" ~ "black",
    first_name == "TROY" & last_name == "CARTER" ~ "black",
    last_name == "CHERFILUS-MCCORMICK" ~ "black",
    last_name == "FOUSHEE" ~ "black",
    last_name == "FROST" ~ "black",
    last_name == "IVEY" ~ "black",
    last_name == "JACKSON" & first_name == "JONATHAN" ~ "black",
    last_name == "KAMLAGER" ~ "black",
    first_name == "SUMMER" ~ "black",
    last_name == "HUFF" ~ "white",
    last_name == "MCLENDON" ~ "white",
    last_name == "LEBLANC" ~ "white",
    last_name == "JOHNSON" & first_name == "ELIZABETH" ~ "black",
    last_name == "COLLINS" ~ "white",
    last_name == "CHRISTIAN" ~ "white",
    last_name == "WEST" & first_name == "CHRIS" ~ "white",
    last_name == "BURKETTE" ~ "white",
    last_name == "ELLISON" & first_name == "GREG" ~ "white",
    last_name == "ELLISON" & first_name == "KEITH" ~ "black",
    last_name == "WILLIAMS" & first_name == "PETER" ~ "black",
    last_name == "CLARK" & first_name == "NORMAN" ~ "white",
    last_name == "CLAITOR" ~ "white",
    last_name == "HOLLOWAY" ~ "white",
    last_name == "MAYO" & first_name == "JAMIE" ~ "black",
    last_name == "LANDRIEU" ~ "white",
    last_name == "BROOKS" & first_name == "DAVID" ~ "white",
    last_name == "BARROW" ~ "white",
    last_name == "DIOUS" ~ "black",
    last_name == "BROADY" ~ "black",
    last_name == "TROTTER" ~ "white",
    last_name == "KING" ~ "white",
    last_name == "ANDERSON" & first_name == "LEE" ~ "white",
    last_name == "GINGREY" ~ "white",
    last_name == "KAZANOW" ~ "white",
    last_name == "HOUSE" ~ "white",
    last_name == "MCKINNEY" ~ "white",
    last_name == "GINGREY" ~ "white",
    last_name == "EDWARDS" & first_name == "RUSSELL" ~ "white",
    last_name == "SAUNDERS" ~ "white",
    last_name == "EZELL" ~ "white",
    first_name == "DIANNE" & last_name == "BLACK" ~ "black",
    last_name == "ROGERS" ~ "white",
    last_name == "SCHAFRANEK" ~ "white",
    last_name == "HENLEY" ~ "white",
    last_name == "WILLIAMS" & first_name == "LYNNETTE" ~ "black",
    last_name == "CHANDLER" ~ "white",
    last_name == "CLARK" & first_name == "BEN" ~ "black",
    last_name == "GASKINS" ~ "black",
    last_name == "SAPASKIS" ~ "other",
    last_name == "CHILDRESS" ~ "black",
    last_name == "LUDDEN" ~ "white",
    last_name == "PINCKNEY" ~ "black",
    last_name == "ARMSTRONG" ~ "white",
    last_name == "KUNIANSKY" ~ "white",
    last_name == "ANTISELL" ~ "white",
    last_name == "COLE" & first_name == "RONALD" ~ "black",
    last_name == "COLE" & first_name == "TOM" ~ "white",
    last_name == "AMBROSE" ~ "white",
    last_name == "SANDERS" & first_name == "BRENDA" ~ "black",
    last_name == "WILLIAMS" & first_name == "WHITTNEY" ~ "asian",
    last_name == "PALMER" & first_name == "DONNIE" ~ "black",
    last_name == "HARRIS" & first_name == "ANDY" ~ "white",
    last_name == "KOPPIE" ~ "white",
    last_name == "JONES" & first_name == "ART" ~ "white",
    last_name == "PEKAU" ~ "white",
    first_name == "BABETTE" ~ "black",
    last_name == "NICHOLSON" ~ "white",
    last_name == "RODGERS" & first_name == "JAMES" ~ "white",
    last_name == "GREEN" & first_name == "KAREN" ~ "black",
    last_name == "JONES" & first_name == "PAUL" ~ "white",
    last_name == "GOODMAN" ~ "white",
    last_name == "REALZ" ~ "white",
    last_name == "REMREY" ~ "white",
    first_name == "DESARAE" ~ "white",
    last_name == "HARRIS" & first_name == "MARK" ~ "white",
    last_name == "SCOTT" & first_name == "JEFF" ~ "white",
    last_name == "MCNEILL" ~ "white",
    last_name == "JONES" & first_name == "WALTER" ~ "white",
    last_name == "ZENO" ~ "white",
    last_name == "BARDEL" ~ "white",
    last_name == "WHITE" & first_name == "JESSICA" ~ "white",
    last_name == "COPELAND" ~ "black",
    last_name == "FREDLAND" ~ "white",
    last_name == "BISHOP" & first_name == "DAVE" ~ "white",
    last_name == "LASHAR" ~ "white",
    last_name == "MIMOUN" ~ "white",
    last_name == "RUPPERSBERGER" ~ "white",
    first_name == "JENICA" ~ "black",
    last_name == "JONES" & first_name == "ARTHUR" ~ "white",
    last_name == "TILLMAN" ~ "black",
    last_name == "HUNTER" ~ "white",
    last_name == "LIEBNITZKY" ~ "white",
    last_name == "SELMONT" ~ "white",
    last_name == "BASSILIAN" ~ "white",
    last_name == "CANADA" ~ "white",
    last_name == "PRESLEY" ~ "white",
    last_name == "WADE" ~ "white",
    last_name == "WILLIAMS" & first_name == "M" ~ "white",
    last_name == "BROWN" & first_name == "SHAUN" ~ "black",
    last_name == "WOODS" ~ "white",
    last_name == "SMITH" & first_name == "DARREL" ~ "white",
    last_name == "STERLING" ~ "white",
    last_name == "FEDALEI" ~ "white",
    last_name == "WILLIAMS" & first_name == "DEBORAH" ~ "white",
    last_name == "WALKER" & first_name == "MARK" ~ "white",
    first_name == "ERNEST" ~ "black",
    last_name == "SPOTORNO" ~ "white",
    last_name == "EVANS" & first_name == "ROBERT" ~ "white",
    last_name == "ARDINI" ~ "white",
    first_name == "DUWAYNE" ~ "black",
    last_name == "BEECHWOOD" ~ "black",
    last_name == "PATTERSON" ~ "white",
    last_name == "PERRY" ~ "white",
    last_name == "FREEMAN" ~ "white",
    last_name == "DARTLAND" ~ "white",
    last_name == "VARASTEH" ~ "white",
    last_name == "BOYD" & first_name == "WILL" ~ "black",
    last_name == "MATHIS" ~ "white",
    last_name == "MCGEHEARTY" ~ "white",
    last_name == "SHERRELL" ~ "white",
    last_name == "ADAMS" & first_name == "TOM" ~ "white",
    last_name == "THOMPSON" & first_name == "LINDA" ~ "white",
    last_name == "BARFIELD" ~ "black",
    last_name == "AIKEN" ~ "white",
    last_name == "MAGEE" ~ "white",
    last_name == "MCKENZIE" ~ "white",
    last_name == "TILGHMAN" ~ "white",
    last_name == "BRONSON" ~ "white",
    last_name == "LAWRENCE" & first_name == "HENRY" ~ "black",
    last_name == "ROBINSON" & first_name == "DAVE" ~ "black",
    last_name == "SANDERS" & first_name == "KENNETH" ~ "black",
    last_name == "KNOTT" ~ "white",
    last_name == "DUMAS" ~ "black",
    last_name == "WATT" ~ "black",
    last_name == "MCINTYRE" ~ "white",
    last_name == "GERMAN" ~ "black",
    last_name == "VARASTEH" ~ "white",
    last_name == "ROBINSON" & first_name == "JOHNNIE" ~ "black",
    last_name == "HOLLEY" ~ "black",
    last_name == "FORD" & first_name == "THERESE" ~ "white",
    last_name == "HERRON" ~ "white",
    last_name == "ROUSE" ~ "white",
    last_name == "ETHERIDGE" ~ "white",
    last_name == "BASCRELL" ~ "white",
    last_name == "KLEINHENDLER" ~ "white",
    last_name == "TAYLOR" & first_name == "GENE" ~ "white",
    first_name == "STEPHENE" ~ "black",
    last_name == "SCAKOWSKY" ~ "white",
    last_name == "JUSTICE" ~ "white",
    last_name == "BOYD" & first_name == "ALLEN" ~ "white",
    last_name == "LUJAN" & first_name == "BEN" ~ "hispanic",
    last_name == "HERGER" ~ "white",
    last_name == "GIFFORDS" ~ "white",
    last_name == "BONNER" ~ "white",
    last_name == "ROBY" ~ "white",
    last_name == "LEWIS" & first_name == "JERRY" ~ "white",
    last_name == "CRENSHAW" ~ "white",
    last_name == "MACK" ~ "white",
    last_name == "SANSARICQ" ~ "other",
    last_name == "ADAMS" & first_name == "SANDRA" ~ "white",
    last_name == "RATOWITZ" ~ "white",
    last_name == "UKRAINEC" ~ "white",
    first_name == "HAROLD" ~ "white",
    first_name == "JOE" & last_name == "WILSON" ~ "white",
    last_name == "GOWDY" ~ "white",
    last_name == "PRATT" ~ "white",
    last_name == "JOHNSON" & first_name == "SAM" ~ "white",
    first_name == "RON" & last_name == "PAUL" ~ "white",
    last_name == "FAULK" ~ "white",
    last_name == "COTTON" ~ "white",
    last_name == "JENNERJAHN" ~ "white",
    first_name == "CHRIS" & last_name == "EDWARDS" ~ "white",
    last_name == "BRADLEY" ~ "white",
    last_name == "WALLACE" ~ "white",
    first_name == "ARTHUR" ~ "white",
    last_name == "CULLER" ~ "white",
    first_name == "KIMBERLIN" ~ "white",
    last_name == "ANTHONY" & first_name == "CHARLES" ~ "white",
    first_name == "RICHMOND" ~ "white",
    last_name == "GOODEN" ~ "white",
    first_name == "RON" & last_name == "WRIGHT" ~ "white",
    last_name == "PATE" ~ "hispanic",
    first_name == "NIKKA" ~ "asian",
    last_name == "FLOWERS" & first_name == "BRIAN" ~ "white",
    first_name == "SANDY" & last_name == "SMITH" ~ "white",
    last_name == "HAYWOOD" ~ "white",
    last_name == "TEAGUE" ~ "white",
    last_name == "NICHOLS" ~ "white",
    last_name == "FALAKOS" ~ "white",
    last_name == "FORTE" ~ "white",
    first_name == "RODNEY" ~ "white",
    last_name == "STOPECK" ~ "white",
    last_name == "TARPLEY" ~ "white",
    last_name == "BROWN" & first_name == "HARRIS" ~ "white",
    first_name == "LENAR" ~ "white",
    last_name == "BELL" & first_name == "ROBERT" ~ "white",
    last_name == "BELL" & first_name == "DOUGLAS" ~ "white",
    last_name == "JOHNSON" & first_name == "MIKE" ~ "white",
    last_name == "GUILLORY" & first_name == "JOSH" ~ "white",
    last_name == "COLE" & first_name == "DON" ~ "white",
    first_name == "LANCE" & last_name == "HARRIS" ~ "white",
    last_name == "LETLOW" ~ "white",
    TRUE ~ race))
```

```{r}
house_2020 <- house_BISG %>%
  # Filter to 2020 House races
  filter(year == 2020)

# Merge with protest dataset to create dataset for analysis
house_protest_2020 <- left_join(house_2020, protest_district, by = c("district", "state"))
```

```{r}
# Calculate pre-2020 and 2022 average win rates for Black candidates in that district
black_historical_house <- house_BISG %>%
  filter(race == "black" & year != 2020) %>%
  group_by(district) %>%
  summarize(black_success_rate = mean(result == "WON"))
# Calculate pre-2020 and 2022 average win rates for white candidates in that district
white_historical_house <- house_BISG %>%
  filter(race == "white" & year != 2020) %>%
  group_by(district) %>%
  summarize(white_success_rate = mean(result == "WON"))

# Merge historical success rates with 2020 data
house_protest_2020 <- left_join(house_protest_2020, white_historical_house, by = "district")
house_protest_2020 <- left_join(house_protest_2020, black_historical_house, by = "district")

# Prep dataframe of Black candidates for logistic regression
black_candidates <- house_protest_2020 %>%
  filter(race == "black") %>%
  # Binary response of success/win
  mutate(success = ifelse(result == "WON", 1, 0))

# Prep dataframe for white candidates for logistic regression
white_candidates <- house_protest_2020 %>%
  filter(race == "white") %>%
  # Binary response of success/win
  mutate(success = ifelse(result == "WON", 1, 0))
```

```{r}
# Example logistic regression model
model <- glm(success ~ size + black_success_rate, data = black_candidates, family = binomial)
summary(model)
```


## State Legislatures BISG and analysis


```{r}
SlegBISG <- sleg %>%
  # Rename variable
  rename(county_fips = cfips) %>%
  # Grab relevant variables
  select(county_fips, last_name, first_name, middle_name, state, party) %>%
  # Reassign values
  mutate(party = case_when(
    party == "democrat" ~ "1",
    party == "republican" ~ "2",
    # Coding other non-partisan and fused as other
    TRUE ~ "0")) %>%
  # Remove white spaces
  mutate(county_fips = str_trim(county_fips)) %>%
    # Put leading zeros as needed
  mutate(county_fips = ifelse(
    is.na(county_fips), NA, 
    sprintf("%03d", as.integer(county_fips)))) %>%
  # Rename variables
  rename(surname = last_name,
         county = county_fips,
         first = first_name,
         middle = middle_name) %>%
  # Remove rows without county or last name
  filter(!is.na(county) & !is.na(surname)) %>%
  # Remove redundancies
  distinct()
```

```{r}
# Predict race
RSlegBISG <- predict_race(
  voter.file = SlegBISG,
  census.surname = TRUE,
  surname.only = FALSE,
  names.to.use = "surname, first, middle",
  census.geo = "county",
  census.key = Sys.getenv("CENSUS_API_KEY"),
  party = "party",
  year = "2020",
  skip_bad_geos = TRUE) 
```

```{r}
RSlegBISG <- RSlegBISG %>%
  # Filter to distinct candidates
  distinct(surname, first, county, state, .keep_all = TRUE) %>%
  # Group by candidate
  group_by(surname, first, middle, state, party) %>%
  # Compute the average race prediction of the candidate across all counties in the state
  mutate(avg_white = mean(pred.whi),
         avg_black = mean(pred.bla),
         avg_his = mean(pred.his),
         avg_asi = mean(pred.asi),
         avg_other = mean(pred.oth)) %>%
  # Assign candidate's race based on highest average
  mutate(
      race = case_when(
      avg_white == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "white",
      avg_black == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "black",
      avg_his == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "hispanic",
      avg_asi == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "asian",
      avg_other == max(avg_white, avg_black, avg_his, avg_asi, avg_other) ~ "other")) 

# Convert to data frame
RSlegBISG <- as.data.frame(RSlegBISG)

RSlegBISG <- RSlegBISG %>%
  # Grab relevant variables
  select(surname, first, state, middle, county, race) %>%
  # Rename variables
  rename(first_name = first,
         last_name = surname,
         middle_name = middle,
         county_fips = county) %>%
  # Remove redundancies
   distinct(first_name, last_name, state, middle_name, .keep_all = TRUE)
```

```{r}
# Merge with full state legislature dataset
sleg_BISG <- left_join(sleg, RSlegBISG, by = c("state", "last_name", "first_name"))
sleg_BISG <- sleg_BISG %>%
  distinct(cand_id, year, .keep_all = TRUE)
```

```{r}
sleg_2020 <- sleg_BISG %>%
  # Filter to 2020 candidates
  filter(year == 2020) %>%
  rename(fips = county_fips)

# Merge with protest data
sleg_protest_2020 <- left_join(protest_state_districts, sleg_2020, by = "dno")

sleg_protest_2020 <- sleg_protest_2020 %>%
  select(-c(year, month, state_fips, middle_name.y, state.y, )) %>%
  rename(middle_name = middle_name.x) %>%
  # Remove redundancies
  distinct(cand_id, .keep_all = TRUE)
```

```{r}
# Compute past and future electoral trends
black_historical_sleg <- sleg_BISG %>%
  filter(race == "black" & year != 2020) %>%
  group_by(dno) %>%
  summarize(black_success_rate = mean(outcome == "won"))
white_historical_sleg <- sleg_BISG %>%
  filter(race == "white" & year != 2020) %>%
  group_by(dno) %>%
  summarize(white_success_rate = mean(outcome == "won"))

# Merge historical success rates with 2020 data
sleg_protest_2020 <- left_join(sleg_protest_2020, white_historical_sleg, by = "dno")
sleg_protest_2020 <- left_join(sleg_protest_2020, black_historical_sleg, by = "dno")

# Prep for model
white_candidates <- sleg_protest_2020 %>%
  filter(race == "white") %>%
  mutate(success = ifelse(outcome == "won", 1, 0))

# Prep for model
black_candidates <- sleg_protest_2020 %>%
  filter(race == "black") %>%
  mutate(success = ifelse(outcome == "won", 1, 0))
```

```{r}
# Example model
model <- glm(success ~ frequency + black_success_rate, data = black_candidates, family = binomial)
summary(model)
```


## Local Office Analysis

Note that race is included in the locals dataset, so no BISG is needed.

```{r}
county_2020 <- county_fips %>%
  # Filter to 2020 local office candidates organized by county
  filter(year == 2020)
# Merge with protest data
merge_county_protests <- left_join(county_2020, county_protests, by = c("fips", "state"))

merge_county_protests <- merge_county_protests %>%
  # Remove extra column
  select(-c(county.y)) %>%
  # Rename variable
  rename(county = county.x)

place_2020 <- place_fips %>% 
  # Filter to 2020 local office candidates organized by place
  filter(year == 2020)
# Merge with protest data
merge_place_protests <- left_join(place_2020, city_protests, by = c("locality", "state"))

merge_place_protests <- merge_place_protests %>%
  # Remove extra column
  select(-c(fips.y, county)) %>%
  # Rename variable
  rename(fips = fips.x)
```

```{r}
# Compute pre-2020 and 2022 electoral trends
black_historical_county <- county_fips %>%
  filter(race == "black" & year != 2020) %>%
  group_by(fips, office) %>%
  summarize(black_success_rate = mean(winner == "win"))
white_historical_county <- county_fips %>%
  filter(race == "white" & year != 2020) %>%
  group_by(fips, office) %>%
  summarize(white_success_rate = mean(winner == "win"))

black_historical_place <- place_fips %>%
  filter(race == "black" & year != 2020) %>%
  group_by(locality, office) %>%
  summarize(black_success_rate = mean(winner == "win"))
white_historical_place <- place_fips %>%
  filter(race == "white" & year != 2020) %>%
  group_by(locality, office) %>%
  summarize(white_success_rate = mean(winner == "win"))

# Merge success rates
merge_place_protests <- left_join(merge_place_protests, white_historical_place, by = c("locality", "office"))
merge_place_protests <- left_join(merge_place_protests, black_historical_place, by = c("locality", "office"))
merge_county_protests <- left_join(merge_county_protests, white_historical_county, by = c("fips", "office"))
merge_county_protests <- left_join(merge_county_protests, black_historical_county, by = c("fips", "office"))
```

```{r}
# Combine place and county data into one dataset
# Warning that locality and countt are flipped as columns names in the join. This does not affect analysis.
merge_place_protests <- merge_place_protests %>%
  # Rename for clarity
  rename(location = locality)
merge_county_protests <- merge_county_protests %>%
  # Rename for clarity
  rename(location = county)

# Row bind the two datasets
locals_protests <- rbind(merge_place_protests, merge_county_protests)
```

```{r}
# Create data frame for analysis
black_candidates <- locals_protests %>%
  filter(race == "black") %>%
  mutate(success = ifelse(winner == "win", 1, 0))

# Create data frame for analysis
white_candidates <- locals_protests %>%
  filter(race == "white") %>%
  mutate(success = ifelse(winner == "win", 1, 0))
```

```{r}
# Example model
model <- glm(success ~ chemical_agents + black_success_rate, data = black_candidates, family = binomial)
summary(model)
```


